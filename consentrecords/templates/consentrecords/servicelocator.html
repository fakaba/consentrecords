<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Service Locator</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">
    <link href="{% static "custom_user/css/bodybackground.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
	<!-- Styles for this web page -->
	<style>
		body {
		  font-size: medium;
		  overflow-y: hidden;
		}
		.site-panel {
			position: absolute;
			overflow-y: hidden;
		}
		
		#id_panel1 {
			width: 100%;
			height: 100%;
			max-height: 100%;
			z-index: 1;
		}
		.panel-constrained {
			height: 100%;
			max-height: 100%;
			overflow-y: hidden;
		}
		.panel-scrolling {
			height: 100%;
			max-height: 100%;
			overflow-y: scroll;
		}
		.list-panel {
			background: #eee;
		}
		.show-panel {
			background: white;
		}
		.edit-panel {
			background: #eee;
		}
		.configuration-panel
		{
			height: 0px;
			width: 0px;
			display: none;
			overflow-y: hidden;
		}
		.configuration-header
		{
			width: 100%;
			text-align: center;
			font-weight: bold;
			background: white;
		}
		#id_title {
			width: 100%;
		}
		#valueContainer {
			margin-top: 15px;
			width: 100%;
			background: #fff;
		}
		.add-button {
			margin-top: 0px;
			padding-top: 4px;
			line-height: 22px;
			font-size: x-large;
			font-weight: 600;
		}
		.property-separator {
			width: 100%;
			text-align: right;
		}
		.property-text-box {
			width: 100%;
			border: none;
		}
		.value-text-box {
			width: 100%;
			border: none;
		}
		.row-button {
			background: white;
			width: 100%;
			border: 0;
			border-radius: 0;
		}
		.row-button:hover {
			background: #f8f8f8;
		}
		.list-div {
			display: inline-block;
			padding: 6px 15px;
			margin-bottom: 0;
			font-size: 14px;
			font-weight: 400;
			line-height: 1.42857143;
			text-align: center;
			white-space: nowrap;
			vertical-align: middle;
			background: white;
			width: 100%;
		}
		hr {
			margin-top: 0px;
			margin-bottom: 0px;
		}
		.element-div {
			width: 100%;
		}
		.element-label-div {
			margin-top: 15px;
			padding-left: 15px;
			padding-right: 15px;
			padding-top: 6px;
			padding-bottom: 6px;
			background: white;
		}
		.element-spacing-div {
			margin-top: 15px;
		}
		.string-value-view {
			position: relative;
			padding-left: 15px;
			padding-right: 15px;
			width: 100%;
			background: white;
		}
		.string-label-div {
			padding-left: 15px;
			padding-right: 15px;
			padding-top: 6px;
			padding-bottom: 6px;
		}
		.left-label-div {
			display: inline-block;
			margin-left: 0px;
			margin-right: auto;
		}
		.right-label-div {
			display: inline-block;
			position: absolute;
			padding-top: 6px;
			padding-bottom: 6px;
			right: 0px;
			text-align: right;
		}
		.string-input-container {
			background: white;
			width: 100%;
			padding-left: 15px;
			padding-right: 15px;
			padding-top: 3px;
			padding-bottom: 3px;	/* This padding allows space for the focus bounds. */
		}
		.string-input {
			width: 100%;
			background: white;
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}
		.string-input:focus {
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}
		
		.search-input-container {
			display: inline-block;
			vertical-align: middle;
			padding-left: 8px;
		}
		.search-input {
			background: white;
			margin: 2px;
			width: 100%;
		}
		.searchbar {
			position: relative;
			background: #D3D3D3;
		}
		#id_searchCancelButton {
			display: inline-block;
			width: auto;
			text-align: right;
			margin-left: 6px;
			margin-right: 15px;
		}
	</style>

    <style>
    	.sign-in-button {
    	    padding-top: 6px;
    	    padding-right: 15px;
    	}
    	.option-label {
    		margin-top: 15px;
    		margin-left: 15px;
    	}
    	.option-item {
    		margin-top: 15px;
    		margin-left: 45px;
    	}
    </style>
  </head>

  <body>
	<div id="id_panel1" class="site-panel">
		<div class="site-trio-container">
			<div class="site-trio-fill"></div>
			<span class="sign-in-button site-trio-clipped site-active-text">Sign&nbsp;In</span>
		</div>
    	<div class="site-title">Welcome to BC&YI Opportunity Source</div>
    	<div class="option-label">Ready?</div>
    	<div class="option-item">
    		<span id="id_startButton" class="site-active-text">Click&nbsp;here&nbsp;to&nbsp;find&nbsp;an&nbsp;opportunity.</span>
    	</div>
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "custom_user/js/bodybackground.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "consentrecords/js/models.js" %}"></script>
	<script src="{% static "consentrecords/js/views.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
	
		var storedcsrftoken = "{{ csrf_token }}";
		var pluralName = "Services";
		var singularName = "Service";
		
		/* For show methods, the obj is the DOM object that contains the item being shown.
							 the d object contains the field information.
							 d["_data"] has the data for the instance of this field.
		 */
		 
		function get_standard_fail_function(containerData)
		{
			return function(jqXHR, textStatus, errorThrown)
			{
				unblock_click(containerData.parentPanel);
				bootstrap_alert.warning(jqXHR.status + "; " + jqXHR.statusText, ".alert-container");
				console.log( "error: " + textStatus + "; " + errorThrown + ";");
				console.log( jqXHR.status + "; " + jqXHR.statusText);
			}
		}
		 
		function is_pick_field(field)
		{
			if (field["capacity"] == "_unique value")
				return true;
			else if (field.dataType == "_enumerated value from a list")
				return true;
			else if (("_object add rule" in field) &&
					 (field["_object add rule"] == "_pick object" ||
					  field["_object add rule"] == "_pick or create object"))
				return true;
			else
				return false;
		}
		
		function push_text_changed(d) {
			d.add_target("dataChanged", this);
			$(this).on("dataChanged", function(e) {
					d3.select(this).text(d.getDescription());
				});
		}
		
		function show_edit_string_cell(obj, containerData, cell, containerUUID)
		{
			var sectionObj = d3.select(obj).classed("object-name-div", true);
			
			if (cell.field.capacity == "_unique value")
			{
				sectionObj.append("div").classed("element-spacing-div", true)
			}
			else
			{
				sectionObj.append("div").classed("element-label-div", true)
						  .text(cell.field.name);
				sectionObj.append("hr");
			}

			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			var divs = itemsDiv.selectAll("div")
				.data(cell.data)
				.enter()
				.append("div")
				.classed("string-input-container", true);	// So that each item appears on its own row.
			
			divs.append("input").classed("string-input", true)
				.attr("type", "text")
				.attr("placeholder", cell.field.name)
				.property("value", function(d) { return d.value; });

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", function(e, newData)
					{
						d3.select(this).append("div").classed("string-input-container", true)
							.data([newData])
							.append("input").classed("string-input", true)
							.attr("type", "text")
							.attr("placeholder", cell.field.name)
							.text(newData.value);
					});
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							
							var newData = dataTypes[cell.field.dataType].newValue();
							cell.data.push(newData);
							if (cell.field.isDescriptor)
								newData.add_target("dataChanged", cell);
							cell.trigger_event("valueAdded", [newData]);
							
							unblock_click(containerData.parentPanel);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}
		
		function show_add_string_cell(obj, containerData, cell, containerUUID)
		{
			/* With this field unique, there will be a data element in the cell
			 */

			var sectionObj = d3.select(obj).classed("element-div", true);
			
			if (cell.field.capacity == "_unique value")
			{
				sectionObj.append("div").classed("element-spacing-div", true)
			}
			else
			{
				sectionObj.append("div").classed("element-label-div", true)
						  .text(cell.field.name);
				sectionObj.append("hr");
			}
			
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			var divs = itemsDiv.selectAll("div")
				.data(cell.data)
				.enter()
				.append("div")
				.classed("string-input-container", true);	// So that each item appears on its own row.
			
			divs.append("input").classed("string-input", true)
				.attr("type", "text")
				.attr("placeholder", cell.field.name);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", function(e, newData)
					{
						d3.select(this).append("div").classed("string-input-container", true)
							.data([newData])
							.append("input").classed("string-input", true)
							.attr("type", "text")
							.attr("placeholder", cell.field.name)
							.text(newData.value);
					});
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							
							var newData = dataTypes[cell.field.dataType].newValue();
							cell.data.push(newData);
							if (cell.field.isDescriptor)
								newData.add_target("dataChanged", cell);
							cell.trigger_event("valueAdded", [newData]);
							
							unblock_click(containerData.parentPanel);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}

		/* Produces a function which adds new value view to a container view
			when the new data is added.
		 */
		function get_on_value_added_function(containerData, viewFunction)
		{
			return function(e, newData)
			{
				var itemsDiv = d3.select(this);
			
				var divs = itemsDiv
					.append("div")	// So that each button appears on its own row.
					.data([newData]);
				var buttons = divs.append("button")
					.classed("btn row-button", true);
				if (viewFunction)
					buttons.on("click", function(d) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							var cell = itemsDiv.datum();
							viewFunction(d, cell, containerData);
						}
					});
				buttons.append("span")
					.classed("text-muted pull-left", true)
					.text(function(d) { return d.getDescription() })
					.each(push_text_changed);
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
			}
		}
		
		function show_edit_object_cell(obj, containerData, cell, containerUUID, viewFunction, pickFunction, addFunction, storeDataFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			layout_objects(itemsDiv, cell.data,
				function(d) {
					if (!is_click_blocked(containerData.parentPanel))
					{
						block_click(containerData.parentPanel);
						if (is_pick_field(cell.field))
							pickFunction(d, cell, containerUUID, containerData);
						else if (viewFunction)
							viewFunction(d, cell, containerData);
					}
				}
				);
			
			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerData, viewFunction));
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							if (is_pick_field(cell.field))
								pickFunction(null, cell, containerUUID, containerData)
							else
								addFunction(cell, containerUUID, containerData, storeDataFunction);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}
		
		/* For a new container that has an object cell, this function displays the UI for
			adding an object to this cell.
		 */
		function show_add_object_cell(obj, containerData, cell, containerUUID, viewFunction, pickFunction, addFunction, storeDataFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerData, viewFunction));

				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							if (is_pick_field(cell.field))	
							{
								pickFunction(null, cell, containerUUID, containerData)
							}
							else
							{
								addFunction(cell, containerUUID, containerData, storeDataFunction);
							}
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
			else if (is_pick_field(cell.field))	
			{
				layout_objects(itemsDiv, cell.data,
					function(d) {
						if (!is_click_blocked(containerData.parentPanel))
						{
							block_click(containerData.parentPanel);
							pickFunction(d, cell, containerUUID, containerData);
						}
					});
			}
		}
		
		/* Add the functionality to a javascript object to attach event targets and
			trigger events on them. This allows events to be fired on model objects.
		 */
		
		function EventHandler() { 
			this.events = {};
		};
		EventHandler.prototype.add_target = function(e, target)
		{
			if (!(e in this.events))
				this.events[e] = [];
			this.events[e].push(target);
		}
		
		EventHandler.prototype.remove_target = function(e, target)
		{
			if (e in this.events)
			{
				var a = this.events[e]
				a.splice($.inArray(target, a), 1);
			}
		}
			
		EventHandler.prototype.trigger_event = function(e, eventInfo)
		{
			if (e in this.events)
				$(this.events[e]).trigger(e, eventInfo);
		}
		
		EventHandler.prototype.clear_events = function()
		{
			this.events = {};
		}
		
		function Cell() { 
			EventHandler.call(this);
			this.data = [];
		}
		Cell.prototype = new EventHandler();
		Cell.prototype.setup = function (objectData)
		{
			if (this.field.isDescriptor && objectData)
			{
				this.add_target("valueAdded", objectData);
				this.add_target("dataChanged", objectData);
				$(this).on("dataChanged", function(e) {
					this.trigger_event("dataChanged");
				});
			}
			
			/* If this is a unique value and there is no value, set up an unspecified one. */
			if (this.data.length == 0 &&
				this.field.capacity == "_unique value") {
				this.data = [dataTypes[this.field.dataType].newValue()];
			}
		};
				
		function CellValue() {
			EventHandler.call(this);
			this.id = null; 
			this.value = null;
		}
		CellValue.prototype = new EventHandler();
		
		function ObjectValue() {
			CellValue.call(this);
			this.value = {id: null, description: "None" };
		}
		ObjectValue.prototype = new CellValue();
		ObjectValue.prototype.getDescription = function() { return this.value.description; };
		ObjectValue.prototype.getValueID = function() { return this.value.id; };
		ObjectValue.prototype.calculateDescription = function()
		{
			if (!("cells" in this.value))
				return this.value.description;
			else
			{
				var nameArray = [];
				for (var i = 0; i < this.value.cells.length; ++i)
				{
					var cell = this.value.cells[i];
					if (cell.field.isDescriptor && cell.data)
					{
						for (var j = 0; j < cell.data.length; ++j)
						{
							nameArray.push(cell.data[j].getDescription());
						}
					}
				}
				if (nameArray.length == 0)
					this.value.description = "None";
				else
					this.value.description = nameArray.join(separator = ' ');
			}
		}
		
		ObjectValue.prototype.handleContentsChanged = function(e)
		{
			var oldDescription = this.getDescription();
			this.calculateDescription();
			if (this.getDescription() != oldDescription)
				this.trigger_event("dataChanged");
		}
		
		function make_new_cell(oldCell)
		{
			var newCell = new Cell();
			newCell.field = oldCell.field;
			if (oldCell.data)
			{
				var dt = dataTypes[newCell.field.dataType];
				$(oldCell.data).each(function()
				{
					newValue = dt.copyValue(this);
					if (newCell.field.isDescriptor)
						newValue.add_target("dataChanged", newCell);
					newCell.data.push(newValue);
				});
			}
			return newCell;
		}
		
		function move_cell(cell, objectData)
		{
			cell.clear_events();
			if (cell.field.isDescriptor && objectData)
			{
				cell.add_target("valueAdded", objectData);
				cell.add_target("dataChanged", objectData);
				$(cell).on("dataChanged", function(e) {
					cell.trigger_event("dataChanged");
				});
			}
		}
				
		var dataTypes = {
			_string: {
				isEmpty: function(d)
				{
					return !d.value;
				},
				setupValue: function(d)
				{
					d.getDescription = function() { return this.value; };
					$(d).on("dataChanged", function(e) {
						d.trigger_event("dataChanged");
					});
				},
				newValue: function()
				{
					var d = new CellValue();
					this.setupValue(d);
					return d;
				},
				copyValue: function(oldValue)
				{
					var newValue = new CellValue();
					this.setupValue(newValue);
					if (oldValue.id !== null && oldValue.id !== undefined)
						newValue.id = oldValue.id;
					if (oldValue.value !== null && oldValue.value !== undefined)
						newValue.value = oldValue.value;
					return newValue;
				},
				show: function(obj, containerData, cell)
				{
					var sectionObj = d3.select(obj);
					
					sectionObj.selectAll("div")
						.data(cell.data)
						.enter()
						.append("div").classed("object-name-div", true)
						.text(function(d) { return d.value; })
						.each(push_text_changed);
				},
				showEdit: function(obj, containerData, cell, containerUUID)
				{
					show_edit_string_cell(obj, containerData, cell, containerUUID);
				},
				showAdd: function(obj, containerData, cell, containerUUID)
				{
					show_add_string_cell(obj, containerData, cell, containerUUID);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = [];
					$(cell.data).each(function()
						{
							var newDatum = {id: null, value: this.value};
							newData.push(newDatum);
						});
					initialData.push({"data": newData, "field": cell.field});
				},
				appendUpdateCommands: function(sectionObj, cell, initialData)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								var command;
								if (cell.field.name == "_uuname")
									command = {id: d.id, elementID: "_uuname", value: this.value};
								else
									command = {id: d.id, elementID: "_value", value: this.value};
								initialData.push(command);
							}
						}
					);
				},
				updateCell: function(sectionObj, cell)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								d.value = this.value;
								d.trigger_event("dataChanged", [d]);
							}
						}
					);
				}
			},
			_object: {
				isEmpty: function(d)
				{
					return !d.value.id && !d.value.cells;
				},
				setupValue: function(d)
				{
					$(d).on("dataChanged", d.handleContentsChanged);
					$(d).on("valueAdded", d.handleContentsChanged);
				},
				newValue: function()
				{
					var d = new ObjectValue();
					this.setupValue(d);
					return d;
				},
				copyValue: function(oldValue)
				{
					var newValue = new ObjectValue();
					this.setupValue(newValue);
					if (oldValue.id !== null && oldValue.id !== undefined)
						newValue.id = oldValue.id;
					if (oldValue.value !== null && oldValue.value !== undefined)
					{
						if (oldValue.value.id)
							newValue.value.id = oldValue.value.id;
						if (oldValue.value.description)
							newValue.value.description = oldValue.value.description;
						if (oldValue.value.cells)
						{
							newValue.value.cells = [];
							$(oldValue.value.cells).each(function()
							{
								newCell = make_new_cell(this);
								newCell.setup(newValue);
								newValue.value.cells.push(newCell);
							});
						}
					}
					return newValue;
				},
				show: function(obj, containerData, cell)
				{
					var sectionObj = d3.select(obj).classed("element-div", true);
					
					sectionObj.append("div").classed("element-label-div", true)
						.text(cell.field.name);
					var itemsDiv = sectionObj.append("div").classed("items-div", true);

					cell.add_target("valueAdded", itemsDiv.node());
					$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerData, show_view_object_panel));
					
					var clickFunction;
					if (is_pick_field(cell.field))
						clickFunction = null;
					else
						clickFunction = function(d) {
							if (!is_click_blocked(containerData.parentPanel))
							{
								block_click(containerData.parentPanel);
								show_view_object_panel(d, cell, containerData);
							}
						}
					layout_objects(itemsDiv, cell.data, clickFunction);
				},
				showEdit: function(obj, containerData, cell, containerUUID)
				{
					show_edit_object_cell(obj, containerData, cell, containerUUID, show_view_object_panel, show_pick_object_panel, show_add_object_panel, submit_create_instance);
				},
				showAdd: function(obj, containerData, cell, containerUUID)
				{
					show_add_object_cell(obj, containerData, cell, containerUUID, show_view_object_panel, show_pick_object_panel, show_add_object_panel, store_new_instance);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = [];
					if (cell.data)
					{
						for (var i = 0; i < cell.data.length; ++i)
						{
							var d = cell.data[i];
							if (d.getValueID())
							{
								/* This case is true if we are picking an object. */
								var newDatum = {id: null, value: {id: d.getValueID()}};
								newData.push(newDatum);
							}
							else if ("cells" in d.value)
							{
								/* This case is true if we are creating an object */
								var newDatum = {id: null, value: {cells: []}};
								$(d.value.cells).each(function()
								{
									dataTypes[this.field.dataType].appendData(null, this, newDatum.value.cells);
								});
								
								newData.push(newDatum);
							}
							/* Otherwise, it is blank and shouldn't be saved. */
						}
					}
					initialData.push({"data": newData, "field": cell.field});
				},
			},
			"_enumerated value from a list": {
				isEmpty: function(d)
				{
					return !d.value.id;
				},
				setupValue: function(d)
				{
					d.getDescription = function() { return this.value.description; };
					d.getValueID = function() { return this.value.id; };

					$(d).on("dataChanged", function(e) {
						d.trigger_event("dataChanged");
					});
				},
				newValue: function()
				{
					var d = new CellValue();
					d.value = {id: null, description:"None" };
					this.setupValue(d);
					return d;
				},
				copyValue: function(oldValue)
				{
					var newValue = new CellValue();
					newValue.value = {id: null, description:"None" };
					this.setupValue(newValue);
					if (oldValue.id !== null && oldValue.id !== undefined)
						newValue.id = oldValue.id;
					if (oldValue.value !== null && oldValue.value !== undefined)
					{
						if (oldValue.value.id)
							newValue.value.id = oldValue.value.id;
						if (oldValue.value.description)
							newValue.value.description = oldValue.value.description;
					}
					return newValue;
				},
				show: function(obj, containerData, cell)
				{
					var sectionObj = d3.select(obj).classed("element-div", true);
					
					sectionObj.append("div").classed("element-label-div", true)
						.text(cell.field.name);
					var itemsDiv = sectionObj.append("div").classed("items-div", true);
					
					cell.add_target("valueAdded", itemsDiv.node());
					$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerData, null));
					
					layout_objects(itemsDiv, cell.data, null);
				},
				showEdit: function(obj, containerData, cell, containerUUID)
				{
					show_edit_object_cell(obj, containerData, cell, containerUUID, null, show_pick_value_panel, show_add_value_panel, submit_add_value);
				},
				showAdd: function(obj, containerData, cell, containerUUID)
				{
					show_add_object_cell(obj, containerData, cell, containerUUID, null, show_pick_value_panel, show_add_value_panel, store_new_value);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = []
					if (cell.data)
					{
						for (var i = 0; i < cell.data.length; ++i)
						{
							var d = cell.data[i];
							if (d.getValueID())
							{
								/* This case is true if we are picking an object. */
								var newDatum = {id: null, value: {id: d.getValueID()}};
								newData.push(newDatum);
							}
						}
					}
					initialData.push({"data": newData, "field": cell.field});
				}
			},
		};
		
		$(document).ready (function(e) {
// 			$("#id_cancelButton").click(function(e) {
// 				window.location = "{{ backURL }}";
// 				e.preventDefault();
// 			});
// 			
// 			$("#id_searchInput").on("keyup input paste", function(){
// 				val = this.value;
// 				if (val.length == 0)
// 				{
// 					/* Show all of the items. */
// 					d3.select("#id_objects").selectAll("div")
// 						.style("display", "block");
// 				}
// 				else
// 				{
// 					/* Show the items whose description is this.value */
// 					d3.select("#id_objects").selectAll("div")
// 						.style("display", function(d)
// 							{
// 								if (d.getDescription().indexOf(val) >= 0)
// 									return "block";
// 								else
// 									return "none";
// 							});
// 				}
// 				d3.select("#id_searchCancelButton")
// 					.classed("site-disabled-text", val.length == 0)
// 					.classed("site-active-text", val.length > 0);
// 			});
// 			
// 			$("#id_searchCancelButton").on("click", function() {
// 				$("#id_searchInput").val("");
// 				$("#id_searchInput").trigger("input");
// 			});
// 
// 			
// 			var itemsDiv = d3.select("#id_objects")
// 				.data([cell]);
// 			cell.add_target("valueAdded", itemsDiv.node());
// 			itemsDiv.node().onValueAdded = get_on_value_added_function(containerData, show_view_object_panel);
// 			$(itemsDiv.node()).on("valueAdded", function(e, newData)
// 			{
// 				this.onValueAdded(e, newData);
// 				itemsDiv.selectAll("div").sort(function(a, b)
// 				{
// 					return a.getDescription().localeCompare(b.getDescription());
// 				});
// 			});

			$("#id_startButton").on("click", handle_start_button);						
// 			$.getJSON("{% url 'selectAll' %}", { "ofKindName" : "Service" }, function(json){
// 				if (json.success) {
// 					var newObjects = [];
// 					$(json.objects).each(function()
// 					{
// 						newObjects.push(dataTypes._object.copyValue(this));
// 					});
// 				
// 					newObjects.sort(function(a, b)
// 						{
// 							return a.getDescription().localeCompare(b.getDescription());
// 						});
// 					
// 					layout_objects(d3.select("#id_objects"), newObjects,
// 						function(d) {
// 							if (!is_click_blocked(containerData.parentPanel))
// 							{
// 								block_click(containerData.parentPanel);
// 								show_view_object_panel(d, cell, containerData);
// 							}
// 						});
// 				}
// 				else
// 				{
// 					bootstrap_alert.warning(json.error, ".alert-container");
// 					unblock_click(containerData.parentPanel);
// 				}
// 			});
		});
		
		$(document).ready(function(e) { resetidObjectsHeight() });
		$(window).resize(function(e) { resetidObjectsHeight() });
		
		$(document).ready(function(e) { resetSearchbarWidth() });
		$(window).resize(function(e) { resetSearchbarWidth() });
		
		function appendButtons(divs)
		{
			var buttons = divs.append("button").classed("btn row-button", true);
			
			buttons.append("span")
				.classed("text-muted pull-left", true)
				.text(function(d) {return d.getDescription()})
				.each(push_text_changed);
				
			return buttons;
		}
		
		function appendDivs(divs)
		{
			var buttons = divs.append("div").classed("list-div", true);
			
			buttons.append("span")
				.classed("text-muted pull-left", true)
				.text(function(d) {return d.getDescription()})
				.each(push_text_changed);
				
			return buttons;
		}
		
		/* Returns the set of objects that contain the description of each data element */
		function layout_objects(container, data, clickFunction)
		{
			// Remove any lingering contents from the set of full issues.
			container.selectAll("div").remove();

			// container[0] is the DOM element associated with the container jQuery object.
			var divs = container.selectAll("div")
				.data(data)
				.enter()
				.append("div");	// So that each button appears on its own row.
			
			var buttons;
			if (clickFunction) {
				buttons = appendButtons(divs);
				buttons.on("click", clickFunction);
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
			}
			else
			{
				buttons = appendDivs(divs);
			}
			
			// divs.append("hr");
			
			return buttons;
		}
		
		function handle_start_button()
		{
			var containerData = {
				name: pluralName, 
				zindex: 1, 
				parentPanel: document.getElementById("id_panel1")
				};
			var cell = new Cell();
			cell.field = {name: singularName,
								dataType: "_object",
								ofKindID : "{{servicesID}}" };
			cell.setup(null);
			
			show_pick_object_panel(null, cell, null, containerData);
		}
		
		function show_click_feedback(obj)
		{
			$(obj).animate({opacity: "0.2"}, 200)
				   .animate({opacity: "1.0"}, 200);
		}
		
		function show_panel_up(obj, containerData)
		{
			var p = $("#id_panel1").position();
			$(obj).offset({top: p.top + window.innerHeight, left: p.left})
						   .height(0)
						   .width("100%")
						   .css("display", "block")
						   .animate({height: "100%", top: p.top}, 400, "swing",
						   		function() {
						   			$(window).trigger("resize");
						   			inputObject = d3.select(obj).selectAll("input").node();
						   			if (inputObject)
						   				inputObject.focus();
						   			if (containerData.parentPanel)
						   				unblock_click(containerData.parentPanel);
						   		});
		}
		
		function show_panel_left(obj, containerData)
		{
			var p = $("#id_panel1").position();
			$(obj).offset({top: p.top, left: p.left + window.innerWidth})
						   .height("100%")
						   .width("100%")
						   .css("display", "block")
						   .animate({width: "100%", left: p.left}, 400, "swing",
						   		function() {
						   			$(window).trigger("resize");
						   			if (containerData.parentPanel)
						   				unblock_click(containerData.parentPanel);
						   		});
		}
		
		function hide_panel_down(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).animate({top: p.top + window.innerHeight}, 400, "swing", 
				function() {
					$(this).remove();
				});
		}
		
		function hide_panel_right(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).animate({left: p.left + window.innerWidth}, 400, "swing", 
				function() {
					$(this).remove();
				});
		}
		
		/* Determines whether clicks should be blocked on the specified object.
			This is used to prevent extra clicks on buttons from repeating operations.
		 */
		function is_click_blocked(obj)
		{
			return obj.clickBlockCount;
		}
		
		/* Blocks clicks on the specified object. */			
		function block_click(obj)
		{
			if (!("clickBlockCount" in obj))
				obj.clickBlockCount = 0;
			obj.clickBlockCount += 1;
		}
		
		/* Blocks clicks on the specified object. */			
		function unblock_click(obj)
		{
			if ("clickBlockCount" in obj)
				obj.clickBlockCount -= 1;
		}
		
		/* From the specified configuration array of objects, get the objects in index order. 
			Indexes are retrieved using the getIndex function.*/
		function orderObjectsByIndex(objects, getIndex)
		{
			var indexed = [];
			var unindexes = [];
			for (var i = 0; i < objects.length; i++) {
				var f = objects[i]
				var index = getIndex(f)
				if (index !== undefined && !(indexed[index]))
					indexed[index] = f;
				else
					unindexes.push(f);
			}
			
			/* Remove all of the undefined elements from the array. */
			var a = indexed.concat(unindexes);
			var indexed = [];
			for (var i = 0; i < a.length; i++) {
				if (a[i] != undefined) indexed.push(a[i]);
			}
			
			return indexed;
		}
		
		function create_panel(zindex, datum)
		{
			var containerPanel = $("#id_panel1").parent()[0];
			var panelDiv = d3.select(containerPanel)
							.append("div")
							.classed("configuration-panel site-panel", true)
							.style("z-index", zindex)
							.data([datum]);
							
			panelDiv.appendNavContainer = function()
			{
				var navContainer = this.append("nav").classed("navbar navbar-default site-navbar always-visible", true)
							.attr("role", "navigation")
							.append("div")
							.classed("container-fluid", true);
							
				navContainer.appendLeftButton = function()
				{
					return this.append("div").classed("pull-left", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				navContainer.appendRightButton = function()
				{
					return this.append("div").classed("pull-right", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				return navContainer;
			}
			
			panelDiv.appendScrollArea = function()
			{
				var panel2Div = panelDiv.append("div").classed("panel-scrolling", true);
				
				panel2Div.appendHeader = function(newText)
				{
					return this.append("header").classed("configuration-header", true)
						.text(newText);
				}
			
				panel2Div.appendSections = function(sectionData)
				{
					return panel2Div.selectAll("section")
							.data(sectionData)
							.enter()
							.append("section")
				}
				panel2Div.resetHeight = function()
				{
					var newHeight = window.innerHeight;
					panelDiv.selectAll(".always-visible").each(
						function() { newHeight -= $(this).height(); }
					);
					$(panel2Div.node()).height(newHeight);
				}
				
				panel2Div.show_view_cells = function(objectData, cell, childContainerData)
				{
					this.appendSections(objectData.value.cells)
						.each(function(cell) {
								if (!cell.field.isDescriptor)
								{
									dataTypes[cell.field.dataType].show(this, childContainerData, cell);
									if (cell.data && cell.data.length > 0)
										$(this).css("display", "block");
									else
										$(this).css("display", "none");
								
									/* Make sure the section gets shown if a value is added to it. */
									cell.add_target("valueAdded", this);
									$(this).on("valueAdded", function(e, newData) {
										$(this).css("display", "block");
									});
									d3.select(this).append("hr");
								}
							});
				}
				
				$(window).resize(panel2Div.resetHeight);
				
				return panel2Div;
			}

			return panelDiv;
		}
		
		function resetSearchbarWidth()
		{
			var newWidth = window.innerWidth;
			$("#id_searchArea").children().each(
				function(i) { 
					if (i > 0) newWidth -= $(this).width(); 
					newWidth -= parseInt($(this).css("margin-right"));
					newWidth -= parseInt($(this).css("margin-left"));
					newWidth -= parseInt($(this).css("padding-right"));
					newWidth -= parseInt($(this).css("padding-left"));
					newWidth -= parseInt($(this).css("border-right"));
					newWidth -= parseInt($(this).css("border-left"));
				}
			);
			$("#id_searchInputContainer").width(newWidth - 5);
		}

		resetidObjectsHeight = function()
		{
			var newHeight = window.innerHeight;
			$("#id_panel1").children().each(
				function() { if (this != document.getElementById("id_scrollableArea")) newHeight -= $(this).height(); }
			);
			$("#id_scrollableArea").height(newHeight);
		}
		
		function add_new_value(containerCell, newData)
		{
			var isEmpty = dataTypes[containerCell.field.dataType].isEmpty;
			for (var i = 0; i < containerCell.data.length; ++i)
			{
				var oldData = containerCell.data[i];
				if (!oldData.id && isEmpty(oldData)) {
					complete_update_value(oldData, newData);
					return;
				}
			}				
			containerCell.data.push(newData);
			if (containerCell.field.isDescriptor)
				newData.add_target("dataChanged", containerCell);
			containerCell.trigger_event("valueAdded", [newData]);
		}
		
		function complete_update_value(oldData, newData)
		{
			if (!oldData.id)
				oldData.id = newData.id;
			oldData.value.id = newData.getValueID();
			oldData.value.description = newData.getDescription();
			oldData.trigger_event("dataChanged");
		}
		
		function store_unsaved_picked_value(cell, oldData, newData)
		{
			if (oldData)
			{
				/* In this case, we are replacing an old value for
				   an item that was added to the item but not saved;
				   a placeholder or a previously picked value.
				 */
				if (newData.getValueID() != oldData.getValueID()) {
					complete_update_value(oldData, newData);
				}
			}
			else	/* In this case, we are adding an object to a new object. */
			{
				add_new_value(cell, newData);
			}
		}
		
		/* This is a storeDataFunction for adding a value to an unsaved cell. */
		function store_new_value(containerCell, containerUUID, initialData, containerData, onSuccessFunction) {
			closealert();
			add_new_value(containerCell, initialData);
			onSuccessFunction();
		}
		
		/* This is a storeDataFunction for adding a value to a saved cell. */
		function submit_add_value(containerCell, containerUUID, initialData, containerData, onSuccessFunction) {
			closealert();
			$.post("{% url 'submitAddValue' %}", 
					{ csrfmiddlewaretoken: '{{ csrf_token }}', 
					  containerUUID: containerUUID,
					  elementUUID: containerCell.field.nameID,
					  valueUUID: initialData.getValueID(),
					  timezoneoffset: new Date().getTimezoneOffset()
					})
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							var newData = dataTypes[containerCell.field.dataType].newValue();
							newData.id = json.id;
							newData.value.description = d.getDescription();
							newData.value.id = d.getValueID();
							add_new_value(cell, newData);
							onSuccessFunction();
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							unblock_click(containerData.parentPanel);
						}
					})
				  .fail(get_standard_fail_function(containerData));
		}
			
		function show_add_value_panel(containerCell, containerUUID, containerData, storeDataFunction) {
			var panelDiv = create_panel(containerData.zindex+1, containerCell)
				.classed("list-panel", true);
		
			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", function(d) {
					hide_panel_right(panelDiv.node());
					d3.event.preventDefault();
				});
			backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
			backButton.append("span").text(" " + containerData.name);
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader(containerCell.field.name);
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			var onSuccessFunction = function(newData) {
				hide_panel_down(panelDiv.node());
			};
			
			var childContainerData = {zindex: containerData.zindex+1,
								  name: containerCell.field.name,
								  parentPanel: panelDiv.node()
								 };
			
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : containerCell.field.id }, 
				function(json)
				{
					if (json.success) {
						var values = [];
						$(json.values).each(function()
						{
							values.push(dataTypes[containerCell.field.dataType].copyValue(this));
						});
					
						var sections = panel2Div.appendSections(values);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (!is_click_blocked(childContainerData.parentPanel))
								{
									block_click(childContainerData.parentPanel);
									storeDataFunction(containerCell, containerUUID, d, childContainerData, onSuccessFunction);
								}
								d3.event.preventDefault();
							});
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node(), containerData);
					}
					else
					{
						alert(json.error);
					}
				}
			);
		}	
			
		/* Displays a panel in which the specified object's contents appear.
		 */
		function show_view_object_panel(objectData, cell, containerData) {
			var panelDiv = create_panel(containerData.zindex+1, objectData)
				.classed("show-panel", true);
	
			var childContainerData = {zindex: containerData.zindex+1,
								  name: objectData.getDescription(),
								  parentPanel: panelDiv.node()
								 };

			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", function(d) {
					hide_panel_right(panelDiv.node());
					d3.event.preventDefault();
				});
			backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
			backButton.append("span").text(" " + containerData.name);
			
			var editButton = navContainer.appendRightButton()
				.on("click", function(d) {
					if (!is_click_blocked(childContainerData.parentPanel))
					{
						block_click(childContainerData.parentPanel);
						show_edit_object_panel(objectData, cell, childContainerData);
					}
					d3.event.preventDefault();
				});
			editButton.append("span").text("Edit");
			
			var panel2Div = panelDiv.appendScrollArea();
		
			var headerDiv = panel2Div.appendHeader(objectData.getDescription());
			objectData.add_target("dataChanged", headerDiv.node());
			$(headerDiv.node()).on("dataChanged", function(e) {
					d3.select(this).text(objectData.getDescription());
				});

			var alertContainer = panel2Div.append("div").classed("alert-container", true);
									
			window.scrollTo(0, 0);
			show_panel_left(panelDiv.node(), containerData);
			
			if (objectData.value.cells)
			{
				panel2Div.show_view_cells(objectData, cell, childContainerData);
			}
			else if (objectData.getValueID())
			{
				$.getJSON("{% url 'getData' %}",
					{ "id" : objectData.getValueID() }, 
					function(json)
					{
						if (json.success) {
							objectData.value.cells = [];
							for (var i = 0; i < json.cells.length; ++i)
							{
								var newCell = make_new_cell(json.cells[i]);
								newCell.setup(objectData);
								objectData.value.cells.push(newCell);
							}
						
							panel2Div.show_view_cells(objectData, cell, childContainerData);
						}
						else {
							alert(json['error']);
						}
					}
				);
			}
		}
		
		/* 
			Displays a panel for editing the specified object. 
		 */
		function show_edit_object_panel(objectData, containerCell, containerData) {
			var panelDiv = create_panel(containerData.zindex+1, objectData)
							.classed("edit-panel", true);
	
			var navContainer = panelDiv.appendNavContainer();
		
			var header = "Edit " + containerCell.field.name;
			var childContainerData = {zindex: containerData.zindex + 1, 
									  name: header,
									  parentPanel: panelDiv.node()
									 };
			
			var doneButton = navContainer.appendRightButton()
				.on("click", function(d) {
					if (!is_click_blocked(childContainerData.parentPanel))
					{
						block_click(childContainerData.parentPanel);
						panelDiv.storeData();
					}
					d3.event.preventDefault();
				});
			doneButton.append("span").text("Done");
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader(header);
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			var sections = panel2Div.appendSections(objectData.value.cells)
				.each(function(cell) {
						dataTypes[cell.field.dataType].showEdit(this, childContainerData, cell, objectData.getValueID());
					});
					
			panelDiv.storeData = function()
			{
				var initialData = [];
				sections.each(function(cell) {
						if ("appendUpdateCommands" in dataTypes[cell.field.dataType])
							dataTypes[cell.field.dataType].appendUpdateCommands(this, cell, initialData);
					});
				if (initialData.length > 0) {
					$.post("{% url 'submitUpdateValues' %}", 
							{ csrfmiddlewaretoken: '{{ csrf_token }}', 
							  commands: JSON.stringify(initialData),
							  timezoneoffset: new Date().getTimezoneOffset()
							})
						  .done(function(json, textStatus, jqXHR)
							{
								if (json.success) {
									closealert();
									sections.each(function(cell) {
											if ("updateCell" in dataTypes[cell.field.dataType])
												dataTypes[cell.field.dataType].updateCell(this, cell);
										});
									hide_panel_down(panelDiv.node());
								}
								else
								{
									bootstrap_alert.warning(json.error, ".alert-container");
									unblock_click(childContainerData.parentPanel);
								}
							})
						  .fail(get_standard_fail_function(childContainerData));
				}
				else
				{
					hide_panel_down(panelDiv.node());
				}
			}
		
			window.scrollTo(0, 0);
			show_panel_up(panelDiv.node(), containerData);
		}
		
		/* For root objects, the containerData.name is the type name of the container;
		   for container objects, the containerData.name is the field name of the object within its container.
		 */
		function show_pick_value_panel(oldData, cell, containerUUID, containerData) {
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : cell.field.id }, 
				function(json)
				{
					if (json.success) {
						var values = [];
						$(json.values).each(function()
						{
							values.push(dataTypes[cell.field.dataType].copyValue(this));
						});
					
						var panelDatum;
						if (oldData && oldData.id)
							panelDatum = oldData;
						else
							panelDatum = cell;
						var panelDiv = create_panel(containerData.zindex+1, panelDatum)
							.classed("list-panel", true);
					
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on("click", function(cell) {
								hide_panel_right(panelDiv.node());
								d3.event.preventDefault();
							});
						backButton.append("span").text("Cancel");
						
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader(cell.field.name);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						var childContainerData = {name: cell.field.name,
											  zindex: containerData.zindex+1,
											  parentPanel: panelDiv.node()
											 };
						
						var sections = panel2Div.appendSections(values);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (!is_click_blocked(childContainerData.parentPanel))
								{
									block_click(childContainerData.parentPanel);								
									if (oldData && oldData.id != null)
									{
										if (d.getValueID() == oldData.getValueID()) {
											hide_panel_right(childContainerData.parentPanel);
										}
										else
										{
											initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
											$.post("{% url 'submitUpdateValues' %}", 
													{ csrfmiddlewaretoken: '{{ csrf_token }}', 
														"commands": JSON.stringify(initialData),
														"timezoneoffset": new Date().getTimezoneOffset()
													})
												  .done(function(json, textStatus, jqXHR)
													{
														if (json.success) {
															closealert();
															complete_update_value(oldData, d);
															hide_panel_right(childContainerData.parentPanel);
														}
														else {
															bootstrap_alert.warning(json.error, ".alert-container");
															unblock_click(childContainerData.parentPanel);
														}
													})
												  .fail(get_standard_fail_function(childContainerData));
										}
									}
									else if (containerUUID)	/* In this case, we are adding an object to an existing object. */
									{
										$.post("{% url 'submitAddValue' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												  containerUUID: containerUUID,
												  elementUUID: cell.field.nameID,
												  valueUUID: d.getValueID(),
												  timezoneoffset: new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														var newData = dataTypes[cell.field.dataType].newValue();
														newData.id = json.id;
														newData.value.description = d.getDescription();
														newData.value.id = d.getValueID();
														add_new_value(cell, newData);
														hide_panel_right(panelDiv.node());
													}
													else {
														bootstrap_alert.warning(json.error, ".alert-container");
														unblock_click(childContainerData.parentPanel);
													}
												})
											  .fail(get_standard_fail_function(childContainerData));
									}
									else 
									{
										closealert();
										store_unsaved_picked_value(cell, oldData, d);
										hide_panel_right(panelDiv.node());
									}
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node(), containerData);
					}
					else
					{
						alert(json['error']);
						if (containerData.parentPanel)
							unblock_click(containerData.parentPanel);
					}
				}
			);
		}
		
		/* Displays a panel from which a user can select an object of the kind required 
			for objects in the specified cell.
		 */
		function show_pick_object_panel(oldData, cell, containerUUID, containerData) {
			var panelDatum;
			if (oldData && oldData.id)
				panelDatum = oldData;	/* Replacing a new object. */
			else
				panelDatum = cell;		/* Adding a new object. */
			var panelDiv = create_panel(containerData.zindex+1, panelDatum)
				.classed("list-panel", true);
		
			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", function(d) {
					hide_panel_right(panelDiv.node());
					d3.event.preventDefault();
				});
			backButton.append("span").text("Cancel");
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader(cell.field.name);
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			
			var childContainerData = {name: cell.field.name,
								  zindex: containerData.zindex+1,
								  parentPanel: panelDiv.node()
								 };
			
			$.getJSON("{% url 'selectAll' %}", 
				{ "ofKindID" : cell.field.ofKindID },
				function(json)
				{
					if (json.success) {
						var rootObjects = [];
						$(json.objects).each(function()
						{
							rootObjects.push(dataTypes._object.copyValue(this));
						});
						
						rootObjects.sort(function(a, b)
							{
								return a.getDescription().localeCompare(b.getDescription());
							});
					
						var sections = panel2Div.appendSections(rootObjects);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (!is_click_blocked(childContainerData.parentPanel))
								{
									block_click(childContainerData.parentPanel);								
									if (oldData && oldData.id != null)
									{
										if (d.getValueID() == oldData.getValueID()) {
											hide_panel_right(panelDiv.node());
										}
										else
										{
											initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
											$.post("{% url 'submitUpdateValues' %}", 
													{ csrfmiddlewaretoken: '{{ csrf_token }}', 
														"commands": JSON.stringify(initialData),
														"timezoneoffset": new Date().getTimezoneOffset()
													})
												  .done(function(json, textStatus, jqXHR)
													{
														if (json.success) {
															closealert();
															complete_update_value(oldData, d);
															hide_panel_right(childContainerData.parentPanel);
														}
														else {
															bootstrap_alert.warning(json.error, ".alert-container");
															unblock_click(childContainerData.parentPanel);
														}
													})
												  .fail(get_standard_fail_function(childContainerData));
										}
									}
									else if (containerUUID)	/* In this case, we are adding an object to an existing object. */
									{
										$.post("{% url 'submitAddValue' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												  containerUUID: containerUUID,
												  elementUUID: cell.field.nameID,
												  valueUUID: d.getValueID(),
												  timezoneoffset: new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														var newData = dataTypes[cell.field.dataType].newValue();
														newData.id = json.id;
														newData.value.description = d.getDescription();
														newData.value.id = d.getValueID();
														add_new_value(cell, newData);
														hide_panel_right(childContainerData.parentPanel);
													}
													else {
														bootstrap_alert.warning(json.error, ".alert-container");
														unblock_click(childContainerData.parentPanel);
													}
												})
											  .fail(get_standard_fail_function(childContainerData));
									}
									else 
									{
										closealert();
										store_unsaved_picked_value(cell, oldData, d);
										hide_panel_right(childContainerData.parentPanel);
									}
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node(), containerData);
					}
					else
					{
						alert(json['error']);
					}
				}
			);
		}
		
		/* This method gets called to bring up a configuration panel when adding
			a new instance of an object to another object. For example, adding a 
			configuration to an object with a uuname kind.
		 */
		function show_add_object_panel(containerCell, containerUUID, containerData, storeDataFunction) {
			$.getJSON("{% url 'getAddConfiguration' %}",
				{ "typeID" : containerCell.field.ofKindID }, 
				function(json)
				{
					if (json.success)
					{
						var cells = [];
						$(json.cells).each(function()
						{
							newCell = new Cell();
							newCell.field = this.field;
							newCell.setup(null);
							cells.push(newCell);
						});
						
						var panelDiv = create_panel(containerData.zindex + 1, containerCell)
							.classed("edit-panel", true);
			
						var header = "New " + containerCell.field.name
						var childContainerData = {name: header,
								  zindex: containerData.zindex+1,
								  parentPanel: panelDiv.node()
								 };
								 
						var navContainer = panelDiv.appendNavContainer();
			
						var backButton = navContainer.appendLeftButton()
							.on("click", function(d) {
								hide_panel_down(panelDiv.node());
								d3.event.preventDefault();
							});
						
						backButton.append("span").text("Cancel");
			
						var onSuccessFunction = function(newData) {
							hide_panel_down(panelDiv.node());
						};
							
						var addButton = navContainer.appendRightButton()
							.on("click", function(d) {
								if (!is_click_blocked(childContainerData.parentPanel))
								{
									block_click(childContainerData.parentPanel);								
									storeDataFunction(containerCell, containerUUID, sections, childContainerData, onSuccessFunction);
								}
								d3.event.preventDefault();
							});
						addButton.append("span").text("Add");
			
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader(header);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						var sections = panel2Div.appendSections(cells)
							.each(function(cell) {
									var childContainerData = {
										zindex: containerData.zindex + 1, 
										name: header,
									    parentPanel: panelDiv.node()
									 };
									dataTypes[cell.field.dataType].showAdd(this, childContainerData, cell, null);
								});
			
						window.scrollTo(0, 0);
						show_panel_up(panelDiv.node(), containerData);
					}
					else
						alert(json.error);
				}
			);
		}
		
		/* This is a storeDataFunction for adding an object within an unsaved object. */
		function store_new_instance(containerCell, containerUUID, sections, containerData, onSuccessFunction)
		{
			closealert();
			var newData = dataTypes._object.newValue();
			newData.value.cells = [];
			sections.each(
				function(cell) {
					if ("updateCell" in dataTypes[cell.field.dataType])
						dataTypes[cell.field.dataType].updateCell(this, cell);
					newCell = make_new_cell(cell);
					newCell.setup(newData);
					newData.value.cells.push(newCell);
				});
				
			newData.calculateDescription();
			add_new_value(containerCell, newData);
			if (onSuccessFunction) onSuccessFunction(newData);
		}
		
		/* This is a storeDataFunction for creating a root object. */
		function submit_create_root_instance(containerCell, containerUUID, sections, containerData, onSuccessFunction)
		{
			var initialData = []
			sections.each(
				function(cell) {
					dt = dataTypes[cell.field.dataType]
					if ("updateCell" in dt)
						dt.updateCell(this, cell);
					dt.appendData(this, cell, initialData);
				});
				
			var jsonArray = { csrfmiddlewaretoken: '{{ csrf_token }}', 
						typeID: containerCell.field.ofKindID,
						properties: JSON.stringify(initialData),
						timezoneoffset: new Date().getTimezoneOffset()
					};
			
			$.post("{% url 'submitCreateInstance' %}", 
					jsonArray)
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							/* Copy the data from json object into newData so that 
								any functions are properly initialized.
							 */
							var newData = dataTypes._object.newValue();
							newData.value.id = json.object.value.id;
							newData.value.description = json.object.value.description;
							add_new_value(containerCell, newData);
							if (onSuccessFunction) onSuccessFunction(newData);
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							if (containerData.parentPanel)
								unblock_click(containerData.parentPanel);
						}
					})
				  .fail(get_standard_fail_function(containerData));
		}

		/* This is a storeDataFunction for creating an object within a saved object. */
		function submit_create_instance(containerCell, containerUUID, sections, containerData, onSuccessFunction)
		{
			var initialData = []
			sections.each(
				function(cell) {
					dt = dataTypes[cell.field.dataType]
					if ("updateCell" in dt)
						dt.updateCell(this, cell);
					dt.appendData(this, cell, initialData);
				});
				
			var jsonArray = { csrfmiddlewaretoken: '{{ csrf_token }}', 
						typeID: containerCell.field.ofKindID,
						properties: JSON.stringify(initialData),
						timezoneoffset: new Date().getTimezoneOffset()
					};
			if ('elementName' in containerCell.field)
				jsonArray.elementName = containerCell.field.elementName;
			if ('nameID' in containerCell.field)
				jsonArray.elementUUID = containerCell.field.nameID;
			if (containerUUID)
				jsonArray.containerUUID = containerUUID;
			
			$.post("{% url 'submitCreateInstance' %}", 
					jsonArray)
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							/* Copy the data from json object into newData so that 
								any functions are properly initialized.
							 */
							var newData = dataTypes._object.newValue();
							/* If there is a container, then the id in newData will contain
								the id of the value object in the database. */
							if (containerUUID)
								newData.id = json.object.id;
							newData.value.id = json.object.value.id;
							newData.value.description = json.object.value.description;
							add_new_value(containerCell, newData);
							if (onSuccessFunction) onSuccessFunction(newData);
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							if (containerData.parentPanel)
								unblock_click(containerData.parentPanel);
						}
					})
				  .fail(get_standard_fail_function(containerData));
		}
	</script>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  </body>
</html>
