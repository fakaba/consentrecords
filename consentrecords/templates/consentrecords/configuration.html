<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>New {{instanceType}}</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
	<!-- Styles for this web page -->
	<style>
		body {
		  background: #eee;
		  overflow-y: hidden;
		}
		.site-panel {
			position: absolute;
			background: #eee;
			overflow-y: hidden;
		}
		
		#id_panel1 {
			width: 100%;
			height: 100%;
			max-height: 100%;
			z-index: 1;
		}
		.panel-constrained {
			height: 100%;
			max-height: 100%;
			overflow-y: hidden;
		}
		.panel-scrolling {
			height: 100%;
			max-height: 100%;
			overflow-y: scroll;
		}
		.configuration-panel
		{
			height: 0px;
			width: 0px;
			display: none;
			overflow-y: hidden;
		}
		.configuration-header
		{
			width: 100%;
			text-align: center;
			font-weight: bold;
			background: white;
		}
		#id_title {
			width: 100%;
		}
		#valueContainer {
			margin-top: 15px;
			width: 100%;
			background: #fff;
		}
		.property-separator {
			width: 100%;
			text-align: right;
		}
		.property-text-box {
			width: 100%;
			border: none;
		}
		.value-text-box {
			width: 100%;
			border: none;
		}
		.row-button {
			background: white;
			width: 100%;
			border: 0;
			border-radius: 0;
		}
		.row-button:hover {
			background: #f8f8f8;
		}
		hr {
			margin-top: 0px;
			margin-bottom: 0px;
		}
		.object-name-div {
			padding-left: 15px;
			padding-right: 15px;
			padding-top: 20px;
			width: 100%;
			background: white;
		}
		.element-label-div {
			padding-left: 15px;
			padding-right: 15px;
			margin-top: 15px;
			padding-top: 6px;
			background: white;
		}
		.string-input {
			width: 100%;
			background: white;
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}
		.string-input:focus {
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}
	</style>

  </head>

  <body>
	<div id="id_panel1" class="site-panel">
		<nav class="navbar navbar-default site-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="pull-left">
					<div id="id_cancelButton" class="cancel-button site-navbar-link site-active-text">Done</div>
				</div>
				<div class="pull-right">
					<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text">
						<span class="glyphicon glyphicon-plus"></span>
					</div>
				</div>
				<div class="site-navbar-commands">
					<div class="site-title site-fill"><span class="site-inner-fill"><strong>Configurations</strong></span></div>
				</div>
			</div>
		</nav>
		<div id="id_scrollableArea" class="panel-scrolling">
			<div>
				<div class="alert-container"></div>
			</div>
			<div id="id_objects">
			</div>
		</div> <!-- /container-fluid -->
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
	
		var storedcsrftoken = "{{ csrf_token }}";
		
		/* For show methods, the obj is the DOM object that contains the item being shown.
							 the d object contains the field information.
							 d["_data"] has the data for the instance of this field.
		 */
		 
		function standard_fail(jqXHR, textStatus, errorThrown)
			{
					bootstrap_alert.warning(jqXHR.status + "; " + jqXHR.statusText, ".alert-container");
					console.log( "error: " + textStatus + "; " + errorThrown + ";");
					console.log( jqXHR.status + "; " + jqXHR.statusText);
			}
		 
		function is_pick_field(field)
		{
			if (field["capacity"] == "_unique value")
				return true;
			else if (field.dataType == "_enumerated value from a list")
				return true;
			else if (("_object add rule" in field) &&
					 (field["_object add rule"] == "_pick object" ||
					  field["_object add rule"] == "_pick or create object"))
				return true;
			else
				return false;
		}
		
		function show_edit_object_cell(obj, containerData, cell, viewFunction, pickFunction, addFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			/* If this is a unique value and there is no value, set up an unspecified one. */
			if (cell.data.length == 0 &&
				cell.field["capacity"] == "_unique value") {
				cell.data = [dataTypes[cell.field.dataType].newValue()];
			}
			
			layout_objects(itemsDiv, cell.data,
				function(d) {
					var textContainer = d3.select(this).selectAll(".name-container");
					var completeEdit = function(newData) {
						if (d.id == null)
							d.id = newData.id;
						d.value.id = newData.getValueID();
						d.value.description = newData.getDescription();
						textContainer.text(newData.getDescription());
					}
					if (is_pick_field(cell.field)) {
						pickFunction(d, cell, containerData, completeEdit);
					}
					else
					{
						viewFunction(d, cell, containerData.name, containerData);
					}
				}
				);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on('click', function(cell) {
						var completeEdit = function(newData) {
							cell.data.push(newData);
							var divs = itemsDiv
								.append("div")	// So that each button appears on its own row.
								.data([newData]);
							var buttons = divs.append("button")
								.classed("btn row-button", true)
								.on("click", function(d) {
										show_view_object_panel(d, cell, cell.field.name, containerData);
									});
							buttons.append("span")
								.classed("text-muted pull-left", true)
								.text(function(d) { return d.getDescription() });
							buttons.append("span")
								.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
							divs.append("hr");				
						};

						if (is_pick_field(cell.field))
						{
							pickFunction(null, cell, containerData, completeEdit)
						}
						else
						{
							addFunction(cell, containerData, completeEdit);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}
		
		function show_add_object_field(obj, containerData, cell, viewFunction, pickFunction, addFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div input-source", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				if (cell.data === undefined)
					cell.data = []
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on('click', function(cell) {
						var oldData = dataTypes[cell.field.dataType].newValue();
						var completeEdit = function(newData) {
							oldData.value.id = newData.getValueID();
							oldData.value.description = newData.getDescription();
							cell.data.push(oldData);
							var divs = itemsDiv
								.append("div")	// So that each button appears on its own row.
								.data([oldData]);
							var buttons = divs.append("button")
								.classed("btn row-button", true)
								.on("click", function(d) {
										viewFunction(d, cell.field.name, containerData);
									});
							buttons.append("span")
								.classed("text-muted pull-left", true)
								.text(function(d) { return d.getDescription() });
							buttons.append("span")
								.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
							divs.append("hr");				
						};

						if (is_pick_field(cell.field))	
						{
							pickFunction(oldData, cell, containerData, completeEdit)
						}
						else
						{
							addFunction(cell, cell, containerData, completeEdit);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
			else if (is_pick_field(cell.field))	
			{
				if (cell.data === undefined)
					cell.data = [dataTypes[cell.field.dataType].newValue()]
				/* If this is a unique value and there is no value, set up an unspecified one. */
				layout_objects(itemsDiv, cell.data,
					function(d) {
						var textContainer = d3.select(this).selectAll(".name-container");
						var completeEdit = function(newData) {
							d.value.id = newData.getValueID();
							d.value.description = newData.getDescription();
							textContainer.text(newData.getDescription());
						}
						pickFunction(d, cell, containerData, completeEdit);
					});
			}
		}
		
		var dataTypes = {
			_string: {
				setupValue: function(d)
				{
					d.getDescription = function() { return this.value; };
					d.targets = [];
				},
				newValue: function()
				{
					d = { id:null, value: null };
					this.setupValue(d);
					return d;
				},
				setupCell: function(cell)
				{
					for (var i = 0; i < cell.data.length; ++i) {
						this.setupValue(cell.data[i]);
					}
				},
				show: function(obj, containerData, cell)
				{
					d3.select(obj)
						.selectAll("div")
						.data(cell.data)
						.enter()
						.append("div").classed("object-name-div", true)
						.text(function(d) { return d.value; })
						.each(function(d) {
							d.targets.push(this);
							$(this).bind("dataChanged", function(e, eventInfo) {
									d3.select(this).text(d.value);
								});
						});
				},
				showEdit: function(obj, containerData, cell)
				{
					sectionObj = d3.select(obj).classed("object-name-div input-source", true);
					
					sectionObj.selectAll("input")
						.data(cell.data)
						.enter()
						.append("input")
						.classed("string-input", true)
						.attr("type", "text")
						.attr("placeholder", cell.field.name)
						.property("value", function(d) { return d.value; });
				},
				showAdd: function(obj, containerData, cell)
				{
					d3.select(obj).classed("object-name-div input-source", true)
						.append("input").classed("string-input", true)
						.attr("type", "text")
						.attr("placeholder", cell.field.name);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = d3.select(sectionObj).select("input").property("value");
					if (newData.length > 0) {
						initialData.push({"data": [newData], "field": {"id": cell.field.id}});
					}
				},
				appendUpdateCommands: function(sectionObj, cell, initialData)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								var command;
								if (cell.field.name == "_uuname")
									command = {id: d.id, elementID: "_uuname", value: this.value};
								else
									command = {id: d.id, elementID: "_value", value: this.value};
								initialData.push(command);
							}
						}
					);
				},
				updateCell: function(sectionObj, cell)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								d.value = this.value;
								$(d.targets).trigger("dataChanged", [d]);
							}
						}
					);
				}
			},
			_object: {
				setupValue: function(d)
				{
					d.getDescription = function() { return this.value.description; };
					d.getValueID = function() { return this.value.id; };
					d.targets = [];
				},
				newValue: function()
				{
					d = { id:null, value: {id: null, description:"None" }};
					this.setupValue(d);
					return d;
				},
				setupCell: function(cell)
				{
					for (var i = 0; i < cell.data.length; ++i) {
						this.setupValue(cell.data[i]);
					}
				},
				show: function(obj, containerData, cell)
				{
					var sectionObj = d3.select(obj).classed("element-div", true);
					
					sectionObj.append("div").classed("element-label-div", true)
						.text(cell.field.name);
					sectionObj.append("hr");
					var itemsDiv = sectionObj.append("div").classed("items-div", true);

					/* If this is a unique value and there is no value, set up an unspecified one. */
					if (cell.data.length == 0 &&
						cell.field["capacity"] == "_unique value") {
						cell.data = [dataTypes[cell.field.dataType].newValue()];
					}
					
					var clickFunction;
					if (is_pick_field(cell.field))
						clickFunction = null;
					else
						clickFunction = function(d) {
							show_view_object_panel(d, cell, cell.field.name, containerData);
						}
					layout_objects(itemsDiv, cell.data, clickFunction);
				},
				showEdit: function(obj, containerData, cell)
				{
					show_edit_object_cell(obj, containerData, cell, show_view_object_panel, show_pick_object_panel, show_add_object_panel);
				},
				showAdd: function(obj, containerData, cell)
				{
					show_add_object_field(obj, containerData, cell, show_view_object_panel, show_pick_object_panel, show_add_object_panel);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = []
					if (cell.data)
					{
						for (var i = 0; i < cell.data.length; ++i)
						{
							var d = cell.data[i];
							if (d.getValueID())
								newData.push(d.getValueID());
						}
					}
					if (newData.length > 0) {
						initialData.push({"data": newData, "field": {"id": cell.field.id}});
					}
				},
			},
			"_enumerated value from a list": {
				setupValue: function(d)
				{
					d.getDescription = function() { return this.value.description; };
					d.getValueID = function() { return this.value.id; };
					d.targets = [];
				},
				newValue: function()
				{
					d = { id:null, value: {id: null, description:"None" }};
					this.setupValue(d);
					return d;
				},
				setupCell: function(cell)
				{
					for (var i = 0; i < cell.data.length; ++i) {
						this.setupValue(cell.data[i]);
					}
				},
				show: function(obj, containerData, cell)
				{
					var sectionObj = d3.select(obj).classed("element-div", true);
					
					sectionObj.append("div").classed("element-label-div", true)
						.text(cell.field.name);
					sectionObj.append("hr");
					var itemsDiv = sectionObj.append("div").classed("items-div", true);
					
					/* If this is a unique value and there is no value, set up an unspecified one. */
					if (cell.data.length == 0 &&
						cell.field["capacity"] == "_unique value") {
						cell.data = [dataTypes[cell.field.dataType].newValue()];
					}
					
					layout_objects(itemsDiv, cell.data, null);
				},
				showEdit: function(obj, containerData, cell)
				{
					show_edit_object_cell(obj, containerData, cell, show_view_value_panel, show_pick_value_panel, show_add_value_panel);
				},
				showAdd: function(obj, containerData, cell)
				{
					show_add_object_field(obj, containerData, cell, show_view_value_panel, show_pick_value_panel, show_add_value_panel);
				},
				appendData: function(sectionObj, cell, initialData)
				{
					var newData = []
					if (cell.data)
					{
						for (var i = 0; i < cell.data.length; ++i)
						{
							var d = cell.data[i];
							if (d.getValueID())
								newData.push(d.getValueID());
						}
					}
					if (newData.length > 0) {
						initialData.push({"data": newData, "field": {"id": cell.field.id}});
					}
				}
			},
		};
		
		$(document).ready (function(e) {
			$("#id_cancelButton").click(function(e) {
				window.location = "{{ backURL }}";
				e.preventDefault();
			});
			
			$("#id_addUniversalObjectButton").click(function(e) {
				var containerData = {id: null, name: "Configurations", zindex: 1};
				var cell = {field: {name: "{{rootType}}", ofKind : "{{rootType}}"}};
				var completeFunction = function(elementData) {
					// Make a new element that has the same fields as the elements generated, below.
					var oldData = {
							id: elementData.getValueID(),
							name: elementData.getDescription(),
							getDescription: function() { return this.name; },
							getValueID: function() { return this.id; }
						};
					var itemsDiv = d3.select("#id_objects");
					var divs = itemsDiv.append("div")	// So that each button appears on its own row.
								.data([oldData]);
					var buttons = divs.append("button")
						.classed("btn row-button", true)
						.on("click", function(d) {
								show_view_object_panel(d, null, "{{rootType}}", containerData);
							});
					buttons.append("span")
						.classed("text-muted pull-left", true)
						.text(function(d) { return d.getDescription(); });
					buttons.append("span")
						.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
					divs.append("hr");
					
					itemsDiv.selectAll("div").sort(function(a, b)
						{
							return a.getDescription().localeCompare(b.getDescription());
						});
				};
				show_add_object_panel(cell, containerData, completeFunction);

				e.preventDefault();
			});
			
			$.getJSON("{% url 'getRootObjects' %}", { "ofKindName" : "{{rootType}}" }, function(json){
				var allObjects = json['objects'];
				for (var i = 0; i < allObjects.length; ++i)
				{
					d = allObjects[i];
					d.getDescription = function() { return this.name; };
					d.getValueID = function() { return this.id; };
				}
				
				allObjects.sort(function(a, b)
					{
						return a.getDescription().localeCompare(b.getDescription());
					});
					
				layout_objects(d3.select("#id_objects"), allObjects,
					function(d) {
						var containerData = {id: null, "zindex": 1, "name": "{{rootType}}" + " Objects"};
						show_view_object_panel(d, null, "{{rootType}}", containerData);
					});
			});
		});
		
		$(document).ready(function(e) { resetidObjectsHeight() });
		$(window).resize(function(e) { resetidObjectsHeight() });
		
		function appendButtons(divs)
		{
			var buttons = divs.append("button").classed("btn row-button", true);
			
			buttons.append("span")
				.classed("name-container text-muted pull-left", true)
				.text(function(d) {return d.getDescription()});
				
			return buttons;
		}
		
		function layout_objects(container, data, clickFunction)
		{
			// Remove any lingering contents from the set of full issues.
			container.selectAll("div").remove();

			// container[0] is the DOM element associated with the container jQuery object.
			var divs = container.selectAll("div")
				.data(data)
				.enter()
				.append("div");	// So that each button appears on its own row.
			
			var buttons = appendButtons(divs);

			if (clickFunction) {
				buttons.on("click", clickFunction);
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
			}
			
			divs.append("hr");
		}
		
		function show_panel_up(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).offset({top: p.top + window.innerHeight, left: p.left})
						   .height(0)
						   .width("100%")
						   .css("display", "block")
						   .animate({height: "100%", top: p.top}, 400, "swing",
						   		function() {
						   			$(window).trigger("resize");
						   		});
		}
		
		function show_panel_left(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).offset({top: p.top, left: p.left + window.innerWidth})
						   .height("100%")
						   .width("100%")
						   .css("display", "block")
						   .animate({width: "100%", left: p.left}, 400, "swing",
						   		function() {
						   			$(window).trigger("resize");
						   		});
		}
		
		function hide_panel_down(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).animate({top: p.top + window.innerHeight}, 400, "swing", 
				function() {
					$(this).remove();
				});
		}
		
		function hide_panel_right(obj)
		{
			var p = $("#id_panel1").position();
			$(obj).animate({left: p.left + window.innerWidth}, 400, "swing", 
				function() {
					$(this).remove();
				});
		}
		
		/* From the specified configuration array of objects, get the objects in index order. 
			Indexes are retrieved using the getIndex function.*/
		function orderObjectsByIndex(objects, getIndex)
		{
			var indexed = [];
			var unindexes = [];
			for (var i = 0; i < objects.length; i++) {
				var f = objects[i]
				var index = getIndex(f)
				if (index !== undefined && !(indexed[index]))
					indexed[index] = f;
				else
					unindexes.push(f);
			}
			
			/* Remove all of the undefined elements from the array. */
			var a = indexed.concat(unindexes);
			var indexed = [];
			for (var i = 0; i < a.length; i++) {
				if (a[i] != undefined) indexed.push(a[i]);
			}
			
			return indexed;
		}
		
		function create_panel(zindex, datum)
		{
			var containerPanel = $("#id_panel1").parent()[0];
			var panelDiv = d3.select(containerPanel)
							.append("div")
							.classed("configuration-panel site-panel", true)
							.style("z-index", zindex)
							.data([datum]);
							
			panelDiv.appendNavContainer = function()
			{
				var navContainer = this.append("nav").classed("navbar navbar-default site-navbar always-visible", true)
							.attr("role", "navigation")
							.append("div")
							.classed("container-fluid", true);
							
				navContainer.appendLeftButton = function()
				{
					return this.append("div").classed("pull-left", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				navContainer.appendRightButton = function()
				{
					return this.append("div").classed("pull-right", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				return navContainer;
			}
			
			panelDiv.appendScrollArea = function()
			{
				var panel2Div = panelDiv.append("div").classed("panel-scrolling", true);
				
				panel2Div.appendHeader = function(newText)
				{
					this.append("header").classed("configuration-header", true)
						.text(newText);
				}
			
				panel2Div.appendSections = function(sectionData)
				{
					return panel2Div.selectAll("section")
							.data(sectionData)
							.enter()
							.append("section")
				}
				panel2Div.resetHeight = function()
				{
					var newHeight = window.innerHeight;
					panelDiv.selectAll(".always-visible").each(
						function() { newHeight -= $(this).height(); }
					);
					$(panel2Div.node()).height(newHeight);
				}
				$(window).resize(panel2Div.resetHeight);
				
				return panel2Div;
			}

			return panelDiv;
		}

		resetidObjectsHeight = function()
		{
			var newHeight = window.innerHeight;
			$("#id_panel1").children().each(
				function() { if (this != document.getElementById("id_scrollableArea")) newHeight -= $(this).height(); }
			);
			$("#id_scrollableArea").height(newHeight);
		}
		function show_view_value_panel(objectData, cell, containerObjectName, containerData) {
			alert("show_view_value_panel not implemented");
		}
			
		function show_add_value_panel(cell, containerData, completeFunction) {
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : cell.field.id }, 
				function(json)
				{
					if (json['success']) {
						var values = orderObjectsByIndex(json['values'], function(v)
							{
								if (!("index" in v))
									return undefined;
								else
									return parseInt(v.index);
							});
					
						var panelDiv = create_panel(containerData.zindex+1, cell);
					
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on('click', function(cell) {
								hide_panel_right(panelDiv.node());
								d3.event.preventDefault();
							});
						backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
						backButton.append("span").text(" " + containerData.name);
					
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader(cell.field.name);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						var sections = panel2Div.appendSections(values)
							.each(function(d) {
								d.getDescription = function() { return this.name };
								d.getValueID = function() { return this.id };
							});
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								var verbID;
								var subjectID;
								/* Select this item, update the parent text and return. */
								verbID = cell.field.nameID;
						
								if (containerData.id)	/* In this case, we are adding an object to an existing object. */
								{
									$.post("{% url 'submitAddValue' %}", 
											{ csrfmiddlewaretoken: '{{ csrf_token }}', 
											  containerUUID: containerData.id,
											  elementUUID: verbID,
											  valueUUID: d.getValueID(),
											  timezoneoffset: new Date().getTimezoneOffset()
											})
										  .done(function(json, textStatus, jqXHR)
											{
												if (json.success) {
													closealert();
													var oldData = dataTypes[cell.field.dataType].newValue();
													oldData.id = json.id;
													oldData.value.description = d.getDescription();
													oldData.value.id = d.getValueID();
													if (completeFunction)
														completeFunction(oldData);
													hide_panel_right(panelDiv.node());
												}
												else {
													bootstrap_alert.warning(json.error, alertContainer.node());
												}
											})
										  .fail(standard_fail);
								}
								else	/* In this case, we are adding an object to a new object. */
								{
									closealert();
									if (completeFunction)
										completeFunction(d);
									hide_panel_right(panelDiv.node());
								}
								d3.event.preventDefault();
							});
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json.error);
					}
				}
			);
		}	
			
		/* For root objects, the containerObjectName is the type name of the container;
		   for container objects, the containerObjectName is the field name of the object within its container.
		   id, containerName and containerObjectName refer to the object being show; 
		 */
		function show_view_object_panel(objectData, cell, containerObjectName, containerData) {
			$.getJSON("{% url 'getData' %}",
				{ "id" : objectData.getValueID() }, 
				function(json)
				{
					if (json.success) {
						var cells = json.cells;
						
						var panelDiv = create_panel(containerData.zindex+1, objectData);
				
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on('click', function(d) {
								hide_panel_right(panelDiv.node());
								d3.event.preventDefault();
							});
						backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
						backButton.append("span").text(" " + containerData.name);
						
						var editButton = navContainer.appendRightButton()
							.on('click', function(d) {
								var editContainerData = {id: d.getValueID(), name: containerObjectName, zindex: containerData.zindex + 1}
								show_edit_object_panel(objectData, cells, editContainerData)
								d3.event.preventDefault();
							});
						editButton.append("span").text("Edit");
						
						
						var panel2Div = panelDiv.appendScrollArea();
					
						panel2Div.appendHeader(containerObjectName);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						panel2Div.appendSections(cells)
							.each(function(cell) {
									dataTypes[cell.field.dataType].setupCell(cell);
									var childContainerData = {"id": objectData.getValueID(), "zindex": 
										containerData.zindex + 1, "name": objectData.getDescription()};
									dataTypes[cell.field.dataType].show(this, childContainerData, cell);
								});
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else {
						alert(json['error']);
					}
				}
			);
		}
		
		/* Reveals a panel for editing the specified object.
			For root objects, the containerObjectName is the type name of the container;
		   for container objects, the containerObjectName is the field name of the object within its container.
		   id, containerName and containerObjectName refer to the object being shown; 
		 */
		function show_edit_object_panel(objectData, cells, containerData) {
			var panelDiv = create_panel(containerData.zindex+1, objectData);
	
			var navContainer = panelDiv.appendNavContainer();
		
			var doneButton = navContainer.appendRightButton()
				.on('click', function(d) {
					panelDiv.storeData();
					d3.event.preventDefault();
				});
			doneButton.append("span").text("Done");
		
			var childContainerData = {"id": objectData.getValueID(), "zindex": containerData.zindex + 1, "name": "Edit " + containerData.name};
			
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader("Edit " + containerData.name);
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			var sections = panel2Div.appendSections(cells)
				.each(function(cell) {
						dataTypes[cell.field.dataType].showEdit(this, childContainerData, cell);
					});
					
			panelDiv.storeData = function()
			{
				var initialData = [];
				sections.each(function(cell) {
						if ("appendUpdateCommands" in dataTypes[cell.field.dataType])
							dataTypes[cell.field.dataType].appendUpdateCommands(this, cell, initialData);
					});
				if (initialData.length > 0) {
					$.post("{% url 'submitUpdateValues' %}", 
							{ csrfmiddlewaretoken: '{{ csrf_token }}', 
							  commands: JSON.stringify(initialData),
							  timezoneoffset: new Date().getTimezoneOffset()
							})
						  .done(function(json, textStatus, jqXHR)
							{
								if (json.success) {
									closealert();
									sections.each(function(cell) {
											if ("updateCell" in dataTypes[cell.field.dataType])
												dataTypes[cell.field.dataType].updateCell(this, cell);
										});
									hide_panel_down(panelDiv.node());
								}
								else
								{
									bootstrap_alert.warning(json.error, alertContainer.node());
								}
							})
						  .fail(standard_fail);
				}
				else
				{
					hide_panel_down(panelDiv.node());
				}
			}
		
			window.scrollTo(0, 0);
			show_panel_up(panelDiv.node());
		}
		
		/* For root objects, the containerData.name is the type name of the container;
		   for container objects, the containerData.name is the field name of the object within its container.
		 */
		function show_pick_value_panel(oldData, cell, containerData, completeFunction) {
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : cell.field.id }, 
				function(json)
				{
					if (json.success) {
						var values = orderObjectsByIndex(json.values, function(v)
							{
								if (!("index" in v))
									return undefined;
								else
									return parseInt(v.index);
							});
					
						var panelDatum;
						if (oldData && oldData.id)
							panelDatum = oldData;
						else
							panelDatum = cell;
						var panelDiv = create_panel(containerData.zindex+1, panelDatum);
					
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on('click', function(cell) {
								hide_panel_right(panelDiv.node());
								d3.event.preventDefault();
							});
						backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
						backButton.append("span").text(" " + containerData.name);
					
						
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader(cell.field.name);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						sections = panel2Div.appendSections(values)
							.each(function(d) {
								d.getDescription = function() { return this.name };
								d.getValueID = function() { return this.id };
							});
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								var verbID;
								var subjectID;
								/* Select this item, update the parent text and return. */
								verbID = cell.field.nameID;
						
								if (oldData && oldData.id != null)
								{
									subjectID = oldData.id;
									if (d.getValueID() == oldData.getValueID()) {
										hide_panel_right(panelDiv.node());
									}
									else
									{
										initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
										$.post("{% url 'submitUpdateValues' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
													"commands": JSON.stringify(initialData),
													"timezoneoffset": new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														if (completeFunction)
															completeFunction(d);
														hide_panel_right(panelDiv.node());
													}
													else {
														bootstrap_alert.warning(json.error, alertContainer.node());
													}
												})
											  .fail(standard_fail);
									}
								}
								else if (containerData.id)	/* In this case, we are adding an object to an existing object. */
								{
									$.post("{% url 'submitAddValue' %}", 
											{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												"containerUUID": containerData.id,
												"elementUUID": verbID,
												"valueUUID": d.getValueID(),
												"timezoneoffset": new Date().getTimezoneOffset()
											})
										  .done(function(json, textStatus, jqXHR)
											{
												if (json.success) {
													closealert();
													var newData = dataTypes[cell.field.dataType].newValue();
													newData.id = json.id;
													newData.value.description = d.getDescription();
													newData.value.id = d.getValueID();
													if (completeFunction)
														completeFunction(newData);
													hide_panel_right(panelDiv.node());
												}
												else {
													bootstrap_alert.warning(json.error, alertContainer.node());
												}
											})
										  .fail(standard_fail);
								}
								else	/* In this case, we are adding an object to a new object. */
								{
									closealert();
									if (completeFunction)
										completeFunction(d);
									hide_panel_right(panelDiv.node());
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json['error']);
					}
				}
			);
		}
		
		/* For root objects, the containerObjectName is the type name of the container;
		   for container objects, the containerObjectName is the field name of the object within its container.
		 */
		function show_pick_object_panel(oldData, cell, containerData, completeFunction) {
			$.getJSON("{% url 'getRootObjects' %}", 
				{ "ofKindID" : cell.field.ofKindID },
				function(json)
				{
					if (json['success']) {
						var rootObjects = json['objects'];
					
						var panelDatum;
						if (oldData && oldData.id)
							panelDatum = oldData;
						else
							panelDatum = cell;
						var panelDiv = create_panel(containerData.zindex+1, panelDatum);
					
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on('click', function(d) {
								hide_panel_right(panelDiv.node());
								d3.event.preventDefault();
							});
						backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
						backButton.append("span").text(" " + containerData.name);
					
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader(cell.field.name);
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						sections = panel2Div.appendSections(rootObjects)
							.each(function(d) {
								d.getDescription = function() { return this.name };
								d.getValueID = function() { return this.id };
							});
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								var verbID;
								var subjectID;
								/* Select this item, update the parent text and return. */
								
								verbID = cell.field.nameID;
							
								if (oldData && oldData.id != null)
								{
									subjectID = oldData.id;
									if (d.getValueID() == oldData.getValueID()) {
										hide_panel_right(panelDiv.node());
									}
									else
									{
										initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
										$.post("{% url 'submitUpdateValues' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
													"commands": JSON.stringify(initialData),
													"timezoneoffset": new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														if (completeFunction)
															completeFunction(d);
														hide_panel_right(panelDiv.node());
													}
													else {
														bootstrap_alert.warning(json.error, alertContainer.node());
													}
												})
											  .fail(standard_fail);
									}
								}
								else if (containerData.id)	/* In this case, we are adding an object to an existing object. */
								{
									$.post("{% url 'submitAddValue' %}", 
											{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												"containerUUID": containerData.id,
												"elementUUID": verbID,
												"valueUUID": d.getValueID(),
												"timezoneoffset": new Date().getTimezoneOffset()
											})
										  .done(function(json, textStatus, jqXHR)
											{
												if (json['success']) {
													closealert();
													var newData = dataTypes[cell.field.dataType].newValue();
													newData.id = json.id;
													newData.value.description = d.getDescription();
													newData.value.id = d.getValueID();
													if (completeFunction)
														completeFunction(newData);
													hide_panel_right(panelDiv.node());
												}
												else {
													bootstrap_alert.warning(json['error'], alertContainer.node());
												}
											})
										  .fail(standard_fail);
								}
								else	/* In this case, we are adding an object to a new object. */
								{
									closealert();
									if (completeFunction)
										completeFunction(d);
									hide_panel_right(panelDiv.node());
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json['error']);
					}
				}
			);
		}
		
		/* This method gets called to bring up a configuration panel when adding
			a new instance of an object to another object. For example, adding a 
			configuration to an object with a uuname kind.
		 */
		// The completeFunction takes one argument that contains two fields: the ID and the summary name of the new object.
		function show_add_object_panel(cell, containerData, completeFunction) {
			$.getJSON("{% url 'getAddConfiguration' %}",
				{ "typeName" : cell.field.ofKind }, 
				function(json)
				{
					if (json['success'])
					{
						var cells = orderObjectsByIndex(json.cells, function(cell)
							{
								field = cell.field;
								if (!("index" in field))
									return undefined;
								else
									return parseInt(field.index);
							});
							
						var panelDiv = create_panel(containerData.zindex + 1, cell);
			
						var navContainer = panelDiv.appendNavContainer();
			
						var backButton = navContainer.appendLeftButton()
							.on('click', function(d) {
								hide_panel_down(panelDiv.node());
								d3.event.preventDefault();
							});
						
						backButton.append("span").text("Cancel");
			
						var sections;
						var addButton = navContainer.appendRightButton()
							.on('click', function(d) {
								add_child(cell, containerData, sections, completeFunction);
								hide_panel_down(panelDiv.node());
								d3.event.preventDefault();
							});
						addButton.append("span").text("Add");
			
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader("New " + cell.field.name);
				
						sections = panel2Div.appendSections(cells)
							.each(function(cell) {
									var childContainerData = {id: null, zindex: containerData.zindex + 1, name: "New " + cell.field.name};
									dataTypes[cell.field.dataType].showAdd(this, childContainerData, cell);
								});
			
						window.scrollTo(0, 0);
						show_panel_up(panelDiv.node());
					}
					else
						alert(json.error);
				}
			);
		}
		
		// The completeFunction takes one argument that contains two fields: 
		// the ID and the summary name of the new object.
		function add_child(cell, containerData, sections, completeFunction) {
			var initialData = []
			sections.each(
				function(cell) {
					dataTypes[cell.field.dataType].appendData(this, cell, initialData);
				});
				
			var jsonArray = { csrfmiddlewaretoken: '{{ csrf_token }}', 
						typeName: cell.field.name,
						properties: JSON.stringify(initialData),
						timezoneoffset: new Date().getTimezoneOffset()
					};
			if ('elementName' in cell.field)
				jsonArray.elementName = cell.field.elementName;
			if ('id' in containerData && containerData.id)
				jsonArray.containerUUID = containerData.id;
			
			$.post("{% url 'submitCreateInstance' %}", 
					jsonArray)
				  .done(function(json, textStatus, jqXHR)
					{
						if (json['success']) {
							closealert();
							/* Copy the data from json object into newData so that 
								any functions are properly initialized.
							 */
							var newData;
							if ('id' in containerData && containerData.id) {
								var newData = dataTypes[cell.field.dataType].newValue();
								newData.id = json.object.id;
								newData.value.id = json.object.value.id;
								newData.value.description = json.object.value.description;
							}
							else {
								/* In this case, we are creating a root element. */
								newData = {id : json.object.id, name: json.object.name,
										   getValueID: function() { return this.id; },
										   getDescription: function() { return this.name; }
										  };
							}
							if (completeFunction) completeFunction(newData);
						}
						else {
							alert(json['error']);
						}
					})
				  .fail(standard_fail);
		}
		
	</script>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  </body>
</html>
