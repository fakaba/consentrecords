<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>{{rootType}}</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
	<!-- Styles for this web page -->
	<style>
		body {
		  font-size: medium;
		  background: #eee;
		  overflow-y: hidden;
		}
		.site-panel {
			position: absolute;
			overflow-y: hidden;
		}
		
		#id_panel1 {
			width: 100%;
			height: 100%;
			max-height: 100%;
			z-index: 1;
		}
		.panel-constrained {
			height: 100%;
			max-height: 100%;
			overflow-y: hidden;
		}
		.panel-scrolling {
			height: 100%;
			max-height: 100%;
			overflow-y: scroll;
		}
		.list-panel {
			background: #eee;
		}
		.show-panel {
			background: white;
		}
		.edit-panel {
			background: #eee;
		}
		.configuration-panel
		{
			height: 0px;
			width: 0px;
			display: none;
			overflow-y: hidden;
		}
		.configuration-header
		{
			width: 100%;
			text-align: center;
			font-weight: bold;
			background: white;
		}
		#id_title {
			width: 100%;
		}
		#valueContainer {
			margin-top: 15px;
			width: 100%;
			background: #fff;
		}
		.add-button {
			margin-top: 0px;
			padding-top: 4px;
			line-height: 22px;
			font-size: x-large;
			font-weight: 600;
		}
		.property-separator {
			width: 100%;
			text-align: right;
		}
		.property-text-box {
			width: 100%;
			border: none;
		}
		.value-text-box {
			width: 100%;
			border: none;
		}
		.row-button {
			background: white;
			width: 100%;
			border: 0;
			border-radius: 0;
		}
		.row-button:hover {
			background: #f8f8f8;
		}
		.list-div {
			display: inline-block;
			padding: 6px 12px;
			margin-bottom: 0;
			font-size: 14px;
			font-weight: 400;
			line-height: 1.42857143;
			text-align: center;
			white-space: nowrap;
			vertical-align: middle;
			background: white;
			width: 100%;
		}
		hr {
			margin-top: 0px;
			margin-bottom: 0px;
		}
		.element-div {
			width: 100%;
			padding-left: 0px;	/* 0 px so that the edges of buttons go to the screen edge. */
			padding-right: 0px;
		}
		.element-edit-div {
			margin-top: 15px;
			background: white;
		}
		.element-label-div {
			padding-top: 6px;
			padding-bottom: 6px;
			padding-left: 12px;
			background: white;
		}
		.string-value-view {
			position: relative;
			width: 100%;
			background: white;
		}
		.string-label-div {
			padding-top: 6px;
			padding-bottom: 6px;
			padding-left: 12px;
			padding-right: 12px;
			vertical-align: center;
		}
		.left-label-div {
			display: inline-block;
			margin-left: 0px;
			margin-right: auto;
			padding-left: 12px;
		}
		.right-label-div {
			display: inline-block;
			position: absolute;
			padding-top: 6px;
			padding-bottom: 6px;
			padding-right: 12px;
			right: 0px;
			text-align: right;
		}
		.string-input-container {
			width: 100%;
			padding: 3px;	/* For the highlight box of the input. */
		}
		.string-multi-input-container {
			padding-left: 12px;
			padding-right: 12px;
		}
		.string-unique-input-label {
			width: auto;
			float: left;
			padding: 3px 12px;	/* For the highlight box of the input. */
		}
		.string-unique-table-cell {
			overflow: hidden;
			width:auto;
			margin-right: 12px;
		}
		.string-unique-input {
			width: 100%;
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
			display: inline-block;
			right: 0px;
			text-align: right;
		}
		.string-input {
			width: 100%;
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}
		.string-input:focus {
			-webkit-appearance:none;
			-moz-appearance:none;
			appearance:none;
			border: none;
			border-color: transparent;
		}

		.search-input-container {
			display: inline-block;
			vertical-align: middle;
			padding-left: 8px;
		}
		.search-input {
			background: white;
			margin: 2px;
			width: 100%;
		}
		.searchbar {
			position: relative;
			background: #D3D3D3;
		}
		#id_searchCancelButton {
			display: inline-block;
			width: auto;
			text-align: right;
			margin-left: 6px;
			margin-right: 15px;
		}
	</style>

  </head>

  <body>
	<div id="id_panel1" class="site-panel list-panel">
		<nav class="navbar navbar-default site-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="pull-left">
					<div id="id_cancelButton" class="cancel-button site-navbar-link site-active-text">Done</div>
				</div>
				<div class="pull-right">
					<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
						<span>+</span>
					</div>
				</div>
				<div class="site-navbar-commands">
					<div class="site-title site-fill"><span class="site-inner-fill">{{rootType}}</span></div>
				</div>
			</div>
		</nav>
		<div id="id_scrollableArea" class="panel-scrolling">
			<div>
				<div class="alert-container"></div>
			</div>
			<div id="id_searchArea" class="searchbar">
				<span id="id_searchInputContainer" class="search-input-container">
					<input id="id_searchInput" class="search-input" placeholder="Search">
					</input>
				</span>
				<span id="id_searchCancelButton" class="site-disabled-text"><span>Cancel</span></span>
			</div>
			<div id="id_objects">
			</div>
		</div> <!-- /container-fluid -->
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "consentrecords/js/models.js" %}"></script>
	<script src="{% static "consentrecords/js/views.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
	
		var storedcsrftoken = "{{ csrf_token }}";
		var pluralName = "{{rootType}}s";
		var singularName = "{{rootType}}";
		
		$("title").text(pluralName);
		$(".site-navbar-commands .site-title .site-inner-fill").text(pluralName);
		
		/* For show methods, the obj is the DOM object that contains the item being shown.
							 the d object contains the field information.
							 d["_data"] has the data for the instance of this field.
		 */
		 
		function prepare_click()
		{
			if (is_click_blocked())
				return false;
			closealert();
			block_click();
			return true;
		}
		 
		function is_pick_field(field)
		{
			if (field["capacity"] == "_unique value")
				return true;	/* This is true because there will always be a default blank item. */
			else if (field.dataType == "_enumerated value from a list")
				return true;
			else if (("_object add rule" in field) &&
					 (field["_object add rule"] == "_pick object" ||
					  field["_object add rule"] == "_pick or create object"))
				return true;
			else
				return false;
		}
		
		function push_text_changed(d) {
			d.add_target("dataChanged", this);
			$(this).on("dataChanged", function(e) {
					d3.select(this).text(d.getDescription());
				});
		}
		
		getDataValue = function(d) { return d.value; }
		getDataDescription = function(d) { return d.getDescription() }
		
		function show_view_string_cell(obj, cell)
		{
			var sectionObj = d3.select(obj);
			
			sectionObj.classed("element-div", true);
			
			var labelDiv = sectionObj.append("div").classed("string-label-div", true)
				.text(cell.field.name);
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			if (cell.field.capacity == "_unique value")
			{
				labelDiv.classed("left-label-div", true);
				itemsDiv.classed("right-label-div", true);
			}

			cell.add_target("valueAdded", itemsDiv.node());
			$(itemsDiv.node()).on("valueAdded", function(e, newData)
				{
					d3.select(this).append("div").classed("string-value-view", true)
						.datum(newData)
						.text(getDataValue)
						.each(push_text_changed);
				});
				
			itemsDiv.selectAll("div")
				.data(cell.data)
				.enter()
				.append("div").classed("string-value-view", true)
				.text(getDataValue)
				.each(push_text_changed);
		}
		
		function show_edit_string_cell(obj, panelDiv, cell, containerUUID, inputType)
		{
			var sectionObj = d3.select(obj).classed("element-div element-edit-div", true);
			
			if (cell.field.capacity == "_unique value")
			{
				var labelDiv = sectionObj.append("div").classed("string-label-div string-unique-input-label", true)
					.text(cell.field.name);
				var itemsDiv = sectionObj.append("div").classed("items-div string-unique-table-cell", true);

				var divs = itemsDiv.selectAll("div")
					.data(cell.data)
					.enter()
					.append("div")
					.classed("string-input-container", true);	// So that each item appears on its own row.
			
				divs.append("input")
					.classed("string-unique-input", true)
					.attr("type", inputType)
					.attr("placeholder", cell.field.name)
					.property("value", getDataValue);

				labelDiv
					.style("line-height", divs.selectAll("input").style("line-height"));
			}
			else
			{
				var labelDiv = sectionObj.append("div").classed("string-label-div", true)
					.text(cell.field.name);
				sectionObj.append("hr");
				var itemsDiv = sectionObj.append("div").classed("items-div", true);

				var divs = itemsDiv.selectAll("div")
					.data(cell.data)
					.enter()
					.append("div")
					.classed("string-input-container", true)	// So that each item appears on its own row.
					.classed("string-multi-input-container", true);
			
				divs.append("input")
					.classed("string-input", true)
					.attr("type", inputType)
					.attr("placeholder", cell.field.name)
					.property("value", getDataValue);

				if (cell.field.capacity == "_unique value")
				{
					labelDiv
						.style("line-height", divs.selectAll("input").style("line-height"));
					itemsDiv.style("width", sectionObj.style("width") - labelDiv.style("width"));
					$(window).resize(function()
					{
						$(itemsDiv.node()).width($(sectionObj.node()).width() 
							- $(labelDiv.node()).width()
							- labelDiv.style("padding-left")
							- labelDiv.style("padding-right"));
					});
				}

				if (["_over time", "_multiple values"].indexOf(cell.field.capacity) >= 0)
				{
					cell.add_target("valueAdded", itemsDiv.node());
					$(itemsDiv.node()).on("valueAdded", function(e, newData)
						{
							d3.select(this).append("div").classed("string-input-container", true)
								.classed("string-multi-input-container", true)
								.datum(newData)
								.append("input").classed("string-input", true)
								.attr("type", inputType)
								.attr("placeholder", cell.field.name)
								.text(newData.value);
						});
				
					/* Add one more button for the add Button item. */
					var buttonDiv = sectionObj.append("div")
						.append("button").classed("btn row-button site-active-text add-element-button", true)
						.on("click", function(cell) {
							if (prepare_click())
							{
								show_click_feedback(this);
							
								var newData = dataTypes[cell.field.dataType].newValue();
								cell.data.push(newData);
								if (cell.field.isDescriptor)
									newData.add_target("dataChanged", cell);
								cell.trigger_event("valueAdded", [newData]);
							
								unblock_click();
							}
							d3.event.preventDefault();
						})
						.append("div").classed("pull-left", true);
					buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
					buttonDiv.append("span").text(" add " + cell.field.name);
					sectionObj.append("hr");
				}
			}
		}
		
		function show_add_string_cell(obj, panelDiv, cell, containerUUID, inputType)
		{
			/* With this field unique, there will be a data element in the cell
			 */

			var sectionObj = d3.select(obj).classed("element-div element-edit-div", true);
			
			if (cell.field.capacity != "_unique value")
			{
				sectionObj.append("div").classed("element-label-div", true)
						  .text(cell.field.name);
				sectionObj.append("hr");
			}
			
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			var divs = itemsDiv.selectAll("div")
				.data(cell.data)
				.enter()
				.append("div")
				.classed("string-input-container", true);	// So that each item appears on its own row.
			
			divs.append("input").classed("string-input", true)
				.attr("type", inputType)
				.attr("placeholder", cell.field.name);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", function(e, newData)
					{
						d3.select(this).append("div").classed("string-input-container", true)
							.data([newData])
							.append("input").classed("string-input", true)
							.attr("type", inputType)
							.attr("placeholder", cell.field.name)
							.text(newData.value);
					});
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (prepare_click())
						{
							show_click_feedback(this);
							
							var newData = dataTypes[cell.field.dataType].newValue();
							cell.data.push(newData);
							if (cell.field.isDescriptor)
								newData.add_target("dataChanged", cell);
							cell.trigger_event("valueAdded", [newData]);
							
							unblock_click();
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}

		/* Produces a function which adds new value view to a container view
			when the new data is added.
		 */
		function get_on_value_added_function(panelDiv, viewFunction)
		{
			return function(e, newData)
			{
				var itemsDiv = d3.select(this);
			
				var divs = itemsDiv
					.append("div")	// So that each button appears on its own row.
					.datum(newData);
				var buttons = divs.append("button")
					.classed("btn row-button", true);
				if (viewFunction)
					buttons.on("click", function(d) {
						if (prepare_click())
						{
							var cell = itemsDiv.datum();
							viewFunction(d, cell, panelDiv);
						}
					});
				buttons.append("span")
					.classed("text-muted pull-left", true)
					.text(getDataDescription)
					.each(push_text_changed);
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
			}
		}
		
		function show_view_object_cell(obj, containerPanel, cell)
		{
			var sectionObj = d3.select(obj).classed("element-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			cell.add_target("valueAdded", itemsDiv.node());
			$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerPanel, show_view_object_panel));
			
			var clickFunction;
			if (is_pick_field(cell.field))
				clickFunction = null;
			else
				clickFunction = function(d) {
					if (prepare_click())
					{
						show_view_object_panel(d, cell, containerPanel);
					}
				}
			layout_objects(itemsDiv, cell.data, clickFunction);
		}
		
		function show_view_value_cell(obj, containerPanel, cell)
		{
			var sectionObj = d3.select(obj).classed("element-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			var itemsDiv = sectionObj.append("div").classed("items-div", true);
			
			cell.add_target("valueAdded", itemsDiv.node());
			$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerPanel, null));
			
			layout_objects(itemsDiv, cell.data, null);
		}
		
		function show_edit_object_cell(obj, panelDiv, cell, containerUUID, viewFunction, pickFunction, addFunction, storeDataFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div element-edit-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			layout_objects(itemsDiv, cell.data,
				function(d) {
					if (prepare_click())
					{
						if (is_pick_field(cell.field))
							pickFunction(d, cell, containerUUID, panelDiv);
						else if (viewFunction)
							viewFunction(d, cell, panelDiv);
					}
				}
				);
			
			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(panelDiv, viewFunction));
				
				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (prepare_click())
						{
							if (is_pick_field(cell.field))
								pickFunction(null, cell, containerUUID, panelDiv)
							else
								addFunction(cell, containerUUID, panelDiv, storeDataFunction);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
		}
		
		/* For a new container that has an object cell, this function displays the UI for
			adding an object to this cell.
		 */
		function show_add_object_cell(obj, containerPanel, cell, containerUUID, viewFunction, pickFunction, addFunction, storeDataFunction)
		{
			var sectionObj = d3.select(obj).classed("element-div element-edit-div", true);
			
			sectionObj.append("div").classed("element-label-div", true)
				.text(cell.field.name);
			sectionObj.append("hr");
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			if (["_over time", "_multiple values"].indexOf(cell.field["capacity"]) >= 0)
			{
				cell.add_target("valueAdded", itemsDiv.node());
				$(itemsDiv.node()).on("valueAdded", get_on_value_added_function(containerPanel, viewFunction));

				/* Add one more button for the add Button item. */
				var buttonDiv = sectionObj.append("div")
					.append("button").classed("btn row-button site-active-text add-element-button", true)
					.on("click", function(cell) {
						if (prepare_click())
						{
							if (is_pick_field(cell.field))	
								pickFunction(null, cell, containerUUID, containerPanel)
							else
								addFunction(cell, containerUUID, containerPanel, storeDataFunction);
						}
						d3.event.preventDefault();
					})
					.append("div").classed("pull-left", true);
				buttonDiv.append("span").classed("glyphicon glyphicon-plus", true);
				buttonDiv.append("span").text(" add " + cell.field.name);
				sectionObj.append("hr");
			}
			else if (is_pick_field(cell.field))	
			{
				layout_objects(itemsDiv, cell.data,
					function(d) {
						if (prepare_click())
						{
							pickFunction(d, cell, containerUUID, containerPanel);
						}
					});
			}
		}
		
		var dataTypeViews = {
			_string: {
				show: function(obj, containerPanel, cell)
				{
					show_view_string_cell(obj, cell);
				},
				showEdit: function(obj, containerPanel, cell, containerUUID)
				{
					show_edit_string_cell(obj, containerPanel, cell, containerUUID, "text");
				},
				showAdd: function(obj, containerPanel, cell, containerUUID)
				{
					show_add_string_cell(obj, containerPanel, cell, containerUUID, "text");
				},
				appendUpdateCommands: function(sectionObj, cell, initialData)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								var command;
								if (cell.field.name == "_uuname")
									command = {id: d.id, elementID: "_uuname", value: this.value};
								else
									command = {id: d.id, elementID: "_value", value: this.value};
								initialData.push(command);
							}
						}
					);
				},
				updateCell: function(sectionObj, cell)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								d.value = this.value;
								d.trigger_event("dataChanged", [d]);
							}
						}
					);
				}
			},
			_number: {
				show: function(obj, containerPanel, cell)
				{
					show_view_string_cell(obj, cell);
				},
				showEdit: function(obj, containerPanel, cell, containerUUID)
				{
					show_edit_string_cell(obj, containerPanel, cell, containerUUID, "number");
				},
				showAdd: function(obj, containerPanel, cell, containerUUID)
				{
					show_add_string_cell(obj, containerPanel, cell, containerUUID, "number");
				},
				appendUpdateCommands: function(sectionObj, cell, initialData)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								var command;
								if (cell.field.name == "_uuname")
									command = {id: d.id, elementID: "_uuname", value: this.value};
								else
									command = {id: d.id, elementID: "_value", value: this.value};
								initialData.push(command);
							}
						}
					);
				},
				updateCell: function(sectionObj, cell)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								d.value = this.value;
								d.trigger_event("dataChanged", [d]);
							}
						}
					);
				}
			},
			_datestamp: {
				show: function(obj, containerPanel, cell)
				{
					show_view_string_cell(obj, cell);
				},
				showEdit: function(obj, containerPanel, cell, containerUUID)
				{
					show_edit_string_cell(obj, containerPanel, cell, containerUUID, "date");
				},
				showAdd: function(obj, containerPanel, cell, containerUUID)
				{
					show_add_string_cell(obj, containerPanel, cell, containerUUID, "date");
				},
				appendUpdateCommands: function(sectionObj, cell, initialData)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								var command;
								if (cell.field.name == "_uuname")
									command = {id: d.id, elementID: "_uuname", value: this.value};
								else
									command = {id: d.id, elementID: "_value", value: this.value};
								initialData.push(command);
							}
						}
					);
				},
				updateCell: function(sectionObj, cell)
				{
					d3.select(sectionObj).selectAll("input").each(function(d)
						{
							if (this.value != d.value)
							{
								d.value = this.value;
								d.trigger_event("dataChanged", [d]);
							}
						}
					);
				}
			},
			_object: {
				show: function(obj, containerPanel, cell)
				{
					show_view_object_cell(obj, containerPanel, cell);
				},
				showEdit: function(obj, containerPanel, cell, containerUUID)
				{
					show_edit_object_cell(obj, containerPanel, cell, containerUUID, show_edit_object_panel, show_pick_object_panel, show_add_object_panel, submit_create_instance);
				},
				showAdd: function(obj, containerPanel, cell, containerUUID)
				{
					show_add_object_cell(obj, containerPanel, cell, containerUUID, show_view_object_panel, show_pick_object_panel, show_add_object_panel, store_new_instance);
				},
			},
			"_enumerated value from a list": {
				show: function(obj, containerPanel, cell)
				{
					show_view_value_cell(obj, containerPanel, cell);
				},
				showEdit: function(obj, containerPanel, cell, containerUUID)
				{
					show_edit_object_cell(obj, containerPanel, cell, containerUUID, null, show_pick_value_panel, show_add_value_panel, submit_add_value);
				},
				showAdd: function(obj, containerPanel, cell, containerUUID)
				{
					show_add_object_cell(obj, containerPanel, cell, containerUUID, null, show_pick_value_panel, show_add_value_panel, store_new_value);
				},
			},
		};

		$(document).ready (function(e) {
			$("#id_cancelButton").click(function(e) {
				window.location = "{{ backURL }}";
				e.preventDefault();
			});
			
			$("#id_searchInput").on("keyup input paste", function(){
				val = this.value;
				if (val.length == 0)
				{
					/* Show all of the items. */
					d3.select("#id_objects").selectAll("div")
						.style("display", "block");
				}
				else
				{
					/* Show the items whose description is this.value */
					d3.select("#id_objects").selectAll("div")
						.style("display", function(d)
							{
								if (d.getDescription().indexOf(val) >= 0)
									return "block";
								else
									return "none";
							});
				}
				d3.select("#id_searchCancelButton")
					.classed("site-disabled-text", val.length == 0)
					.classed("site-active-text", val.length > 0);
			});
			
			$("#id_searchCancelButton").on("click", function() {
				$("#id_searchInput").val("");
				$("#id_searchInput").trigger("input");
			});

			var parentPanel = document.getElementById("id_panel1")
			var panelDiv = d3.select(parentPanel);
			panelDiv.attr("headerText", "{{rootType}}");

			var cell = new Cell();
			cell.field = {name: singularName,
								dataType: "_object",
								ofKindID : "{{rootID}}" };
			cell.setup(null);
			
			var itemsDiv = d3.select("#id_objects")
				.data([cell]);
			cell.add_target("valueAdded", itemsDiv.node());
			itemsDiv.node().onValueAdded = get_on_value_added_function(d3.select(parentPanel), show_view_object_panel);
			$(itemsDiv.node()).on("valueAdded", function(e, newData)
			{
				this.onValueAdded(e, newData);
				itemsDiv.selectAll("div").sort(function(a, b)
				{
					return a.getDescription().localeCompare(b.getDescription());
				});
			});
			
			$("#id_addUniversalObjectButton").click(function(e) {
				if (prepare_click())
				{
					show_click_feedback(this);
				
					show_add_object_panel(cell, null, panelDiv, submit_create_root_instance);
				}

				e.preventDefault();
			});
			
			$.getJSON("{% url 'selectAll' %}", { "ofKindName" : "{{rootType}}" }, function(json){
				if (json.success) {
					var newObjects = [];
					$(json.objects).each(function()
					{
						newObjects.push(dataTypes._object.copyValue(this));
					});
				
					newObjects.sort(function(a, b)
						{
							return a.getDescription().localeCompare(b.getDescription());
						});
					
					layout_objects(d3.select("#id_objects"), newObjects,
						function(d) {
							if (prepare_click())
							{
								show_view_object_panel(d, cell, panelDiv);
							}
						});
				}
				else
				{
					bootstrap_alert.warning(json.error, ".alert-container");
					unblock_click();
				}
			});
		});
		
		$(document).ready(function(e) { resetidObjectsHeight() });
		$(window).resize(function(e) { resetidObjectsHeight() });
		
		$(document).ready(function(e) { resetSearchbarWidth() });
		$(window).resize(function(e) { resetSearchbarWidth() });
		
		function appendButtons(divs)
		{
			var buttons = divs.append("button").classed("btn row-button", true);
			
			buttons.append("span")
				.classed("text-muted pull-left", true)
				.text(getDataDescription)
				.each(push_text_changed);
				
			return buttons;
		}
		
		function appendDivs(divs)
		{
			var buttons = divs.append("div").classed("list-div", true);
			
			buttons.append("span")
				.classed("text-muted pull-left", true)
				.text(getDataDescription)
				.each(push_text_changed);
				
			return buttons;
		}
		
		/* Returns the set of objects that contain the description of each data element */
		function layout_objects(container, data, clickFunction)
		{
			// Remove any lingering contents from the set of full issues.
			container.selectAll("div").remove();

			var divs = container.selectAll("div")
				.data(data)
				.enter()
				.append("div");	// So that each button appears on its own row.
			
			var buttons;
			if (clickFunction) {
				buttons = appendButtons(divs);
				buttons.on("click", clickFunction);
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
			}
			else
			{
				buttons = appendDivs(divs);
			}
			
			return buttons;
		}
		
		/* From the specified configuration array of objects, get the objects in index order. 
			Indexes are retrieved using the getIndex function.*/
		/* Creates a panel that sits atop the specified containerPanel in the same container. */
		function create_panel(containerPanel, datum, headerText)
		{
			var rootPanel = d3.select($(containerPanel.node()).parents()[0]);
			var zindex = parseInt(containerPanel.style("z-index"))+1;
			var panelDiv = rootPanel
							.append("div")
							.classed("configuration-panel site-panel", true)
							.style("z-index", zindex)
							.datum(datum)
							.attr("headerText", headerText);
			
			panelDiv.appendNavContainer = function()
			{
				var navContainer = this.append("nav").classed("navbar navbar-default site-navbar always-visible", true)
							.attr("role", "navigation")
							.append("div")
							.classed("container-fluid", true);
							
				navContainer.appendLeftButton = function()
				{
					return this.append("div").classed("pull-left", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				navContainer.appendRightButton = function()
				{
					return this.append("div").classed("pull-right", true)
							   .append("div") .classed("site-navbar-link site-active-text", true);
				}
			
				return navContainer;
			}
			
			panelDiv.appendScrollArea = function()
			{
				var panel2Div = panelDiv.append("div").classed("panel-scrolling", true);
				
				panel2Div.appendHeader = function()
				{
					return this.append("header").classed("configuration-header", true)
						.text(headerText);
				}
			
				panel2Div.appendSections = function(sectionData)
				{
					return panel2Div.selectAll("section")
							.data(sectionData)
							.enter()
							.append("section")
				}
				panel2Div.resetHeight = function()
				{
					var newHeight = window.innerHeight;
					panelDiv.selectAll(".always-visible").each(
						function() { newHeight -= $(this).height(); }
					);
					$(panel2Div.node()).height(newHeight);
				}
				
				panel2Div.show_view_cells = function(objectData, cell, panelDiv)
				{
					this.appendSections(objectData.value.cells)
						.each(function(cell) {
								if (!cell.field.isDescriptor)
								{
									dataTypeViews[cell.field.dataType].show(this, panelDiv, cell);
									if (!cell.isEmpty())
										$(this).css("display", "block");
									else
										$(this).css("display", "none");
								
									/* Make sure the section gets shown if a value is added to it. */
									cell.add_target("valueAdded", this);
									$(this).on("valueAdded", function(e, newData) {
										$(this).css("display", "block");
									});
									d3.select(this).append("hr");
								}
							});
				}
				
				panel2Div.show_edit_cells = function(objectData, cell, panelDiv)
				{
					this.appendSections(objectData.value.cells)
						.each(function(cell) {
								dataTypeViews[cell.field.dataType].showEdit(this, panelDiv, cell, objectData.getValueID());
							});
				}
				
				$(window).resize(panel2Div.resetHeight);
				
				return panel2Div;
			}

			return panelDiv;
		}
		
		function resetSearchbarWidth()
		{
			var newWidth = window.innerWidth;
			$("#id_searchArea").children().each(
				function(i) { 
					if (i > 0) newWidth -= $(this).width(); 
					newWidth -= parseInt($(this).css("margin-right"));
					newWidth -= parseInt($(this).css("margin-left"));
					newWidth -= parseInt($(this).css("padding-right"));
					newWidth -= parseInt($(this).css("padding-left"));
					newWidth -= parseInt($(this).css("border-right"));
					newWidth -= parseInt($(this).css("border-left"));
				}
			);
			$("#id_searchInputContainer").width(newWidth - 5);
		}

		resetidObjectsHeight = function()
		{
			var newHeight = window.innerHeight;
			$("#id_panel1").children().each(
				function() { if (this != document.getElementById("id_scrollableArea")) newHeight -= $(this).height(); }
			);
			$("#id_scrollableArea").height(newHeight);
		}
		
		function store_unsaved_picked_value(cell, oldData, newData)
		{
			if (oldData)
			{
				/* In this case, we are replacing an old value for
				   an item that was added to the item but not saved;
				   a placeholder or a previously picked value.
				 */
				if (newData.getValueID() != oldData.getValueID()) {
					oldData.completeUpdateValue(newData);
				}
			}
			else	/* In this case, we are adding an object to a new object. */
			{
				cell.addValue(newData);
			}
		}
		
		/* This is a storeDataFunction for adding a value to an unsaved cell. */
		function store_new_value(containerCell, containerUUID, initialData, onSuccessFunction) {
			closealert();
			containerCell.addValue(initialData);
			onSuccessFunction();
		}
		
		/* This is a storeDataFunction for adding a value to a saved cell. */
		function submit_add_value(containerCell, containerUUID, initialData, onSuccessFunction) {
			closealert();
			$.post("{% url 'submitAddValue' %}", 
					{ csrfmiddlewaretoken: '{{ csrf_token }}', 
					  containerUUID: containerUUID,
					  elementUUID: containerCell.field.nameID,
					  valueUUID: initialData.getValueID(),
					  timezoneoffset: new Date().getTimezoneOffset()
					})
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							var newData = dataTypes[containerCell.field.dataType].newValue();
							newData.id = json.id;
							newData.value.description = d.getDescription();
							newData.value.id = d.getValueID();
							cell.addValue(newData);
							onSuccessFunction();
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							unblock_click();
						}
					})
				  .fail(standard_fail_function);
		}
			
		function show_add_value_panel(containerCell, containerUUID, containerPanel, storeDataFunction) {
			var panelDiv = create_panel(containerPanel, containerCell, containerCell.field.name)
				.classed("list-panel", true);
		
			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", handle_close_right_event);
			backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
			backButton.append("span").text(" " + containerPanel.attr("headerText"));
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader();
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			var onSuccessFunction = function(newData) {
				hide_panel_down(panelDiv.node());
			};
			
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : containerCell.field.id }, 
				function(json)
				{
					if (json.success) {
						var values = [];
						$(json.values).each(function()
						{
							values.push(dataTypes[containerCell.field.dataType].copyValue(this));
						});
					
						var sections = panel2Div.appendSections(values);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (prepare_click())
								{
									storeDataFunction(containerCell, containerUUID, d, onSuccessFunction);
								}
								d3.event.preventDefault();
							});
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json.error);
					}
				}
			);
		}	
			
		/* Displays a panel in which the specified object's contents appear.
		 */
		function show_view_object_panel(objectData, containerCell, containerPanel) {
			var panelDiv = create_panel(containerPanel, 
										objectData, objectData.getDescription())
				.classed("show-panel", true);
	
			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", handle_close_right_event);
			backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
			backButton.append("span").text(" " + containerPanel.attr("headerText"));
			
			var editButton = navContainer.appendRightButton()
				.on("click", function(d) {
					if (prepare_click())
					{
						show_click_feedback(this);
						
						show_edit_object_panel(objectData, containerCell, panelDiv);
					}
					d3.event.preventDefault();
				});
			editButton.append("span").text("Edit");
			
			var panel2Div = panelDiv.appendScrollArea();
		
			var headerDiv = panel2Div.appendHeader();
			objectData.add_target("dataChanged", headerDiv.node());
			$(headerDiv.node()).on("dataChanged", function(e) {
					d3.select(this).text(objectData.getDescription());
				});

			var alertContainer = panel2Div.append("div").classed("alert-container", true);
									
			window.scrollTo(0, 0);
			show_panel_left(panelDiv.node());
			
			if (objectData.value.cells)
			{
				panel2Div.show_view_cells(objectData, containerCell, panelDiv);
			}
			else if (objectData.getValueID())
			{
				$.getJSON("{% url 'getData' %}",
					{ "id" : objectData.getValueID() }, 
					function(json)
					{
						if (json.success) {
							objectData.value.cells = [];
							for (var i = 0; i < json.cells.length; ++i)
							{
								objectData.importCell(json.cells[i]);
							}
						
							panel2Div.show_view_cells(objectData, containerCell, panelDiv);
						}
						else {
							alert(json['error']);
						}
					}
				);
			}
		}
		
		/* 
			Displays a panel for editing the specified object. 
		 */
		function show_edit_object_panel(objectData, containerCell, containerPanel) {
			var panelDiv = create_panel(containerPanel, 
										objectData, "Edit " + containerCell.field.name)
							.classed("edit-panel", true);
	
			var navContainer = panelDiv.appendNavContainer();
		
			var header = "Edit " + containerCell.field.name;
			
			var doneButton = navContainer.appendRightButton();
			doneButton.append("span").text("Done");
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader();
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			window.scrollTo(0, 0);
			show_panel_up(panelDiv.node());

			if (objectData.value.cells)
			{
				panel2Div.show_edit_cells(objectData, containerCell, panelDiv);
			}
			else if (objectData.getValueID())
			{
				$.getJSON("{% url 'getData' %}",
					{ "id" : objectData.getValueID() }, 
					function(json)
					{
						if (json.success) {
							objectData.value.cells = [];
							for (var i = 0; i < json.cells.length; ++i)
							{
								objectData.importCell(json.cells[i]);
							}
						
							panel2Div.show_edit_cells(objectData, containerCell, panelDiv);
						}
						else {
							alert(json.error);
						}
					}
				);
			}
					
			doneButton.on("click", function(d) {
				if (prepare_click())
				{
					show_click_feedback(this);
					
					var initialData = [];
					var sections = panel2Div.selectAll("section");
					sections.each(function(cell) {
							if ("appendUpdateCommands" in dataTypeViews[cell.field.dataType])
								dataTypeViews[cell.field.dataType].appendUpdateCommands(this, cell, initialData);
						});
					if (initialData.length > 0) {
						$.post("{% url 'submitUpdateValues' %}", 
								{ csrfmiddlewaretoken: '{{ csrf_token }}', 
								  commands: JSON.stringify(initialData),
								  timezoneoffset: new Date().getTimezoneOffset()
								})
							  .done(function(json, textStatus, jqXHR)
								{
									if (json.success) {
										sections.each(function(cell) {
												if ("updateCell" in dataTypeViews[cell.field.dataType])
													dataTypeViews[cell.field.dataType].updateCell(this, cell);
											});
										hide_panel_down($(this).parents(".site-panel")[0]);
									}
									else
									{
										bootstrap_alert.warning(json.error, ".alert-container");
										unblock_click();
									}
								})
							  .fail(standard_fail_function);
					}
					else
					{
						hide_panel_down($(this).parents(".site-panel")[0]);
					}
				}
				d3.event.preventDefault();
			});
		}
		
		/* For root objects, the containerPanel.name is the type name of the container;
		   for container objects, the containerPanel.name is the field name of the object within its container.
		 */
		function show_pick_value_panel(oldData, cell, containerUUID, containerPanel) {
			$.getJSON("{% url 'getEnumerationValues' %}",
				{ "id" : cell.field.id }, 
				function(json)
				{
					if (json.success) {
						var values = [];
						$(json.values).each(function()
						{
							values.push(dataTypes[cell.field.dataType].copyValue(this));
						});
					
						var panelDatum;
						if (oldData && oldData.id)
							panelDatum = oldData;
						else
							panelDatum = cell;
						var panelDiv = create_panel(containerPanel, 
													panelDatum, cell.field.name)
							.classed("list-panel", true);
					
						var navContainer = panelDiv.appendNavContainer();
					
						var backButton = navContainer.appendLeftButton()
							.on("click", handle_close_right_event);
						backButton.append("span").text("Cancel");
						
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader();
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						var sections = panel2Div.appendSections(values);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (prepare_click())
								{
									if (oldData && oldData.id != null)
									{
										if (d.getValueID() == oldData.getValueID()) {
											hide_panel_right(panelDiv.node());
										}
										else
										{
											initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
											$.post("{% url 'submitUpdateValues' %}", 
													{ csrfmiddlewaretoken: '{{ csrf_token }}', 
														"commands": JSON.stringify(initialData),
														"timezoneoffset": new Date().getTimezoneOffset()
													})
												  .done(function(json, textStatus, jqXHR)
													{
														if (json.success) {
															oldData.completeUpdateValue(d);
															hide_panel_right(panelDiv.node());
														}
														else {
															bootstrap_alert.warning(json.error, ".alert-container");
															unblock_click();
														}
													})
												  .fail(standard_fail_function);
										}
									}
									else if (containerUUID)	/* In this case, we are adding an object to an existing object. */
									{
										$.post("{% url 'submitAddValue' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												  containerUUID: containerUUID,
												  elementUUID: cell.field.nameID,
												  valueUUID: d.getValueID(),
												  timezoneoffset: new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														var newData = dataTypes[cell.field.dataType].newValue();
														newData.id = json.id;
														newData.value.description = d.getDescription();
														newData.value.id = d.getValueID();
														cell.addValue(newData);
														hide_panel_right(panelDiv.node());
													}
													else {
														bootstrap_alert.warning(json.error, ".alert-container");
														unblock_click();
													}
												})
											  .fail(standard_fail_function);
									}
									else 
									{
										closealert();
										store_unsaved_picked_value(cell, oldData, d);
										hide_panel_right(panelDiv.node());
									}
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json.error);
						unblock_click();
					}
				}
			);
		}
		
		/* Displays a panel from which a user can select an object of the kind required 
			for objects in the specified cell.
		 */
		function show_pick_object_panel(oldData, cell, containerUUID, containerPanel) {
			var panelDatum;
			if (oldData && oldData.id)
				panelDatum = oldData;	/* Replacing a new object. */
			else
				panelDatum = cell;		/* Adding a new object. */
			var panelDiv = create_panel(containerPanel, panelDatum, cell.field.name)
				.classed("list-panel", true);
		
			var navContainer = panelDiv.appendNavContainer();
		
			var backButton = navContainer.appendLeftButton()
				.on("click", handle_close_right_event);
			backButton.append("span").text("Cancel");
		
			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader();
			var alertContainer = panel2Div.append("div").classed("alert-container", true);
			
			$.getJSON("{% url 'selectAll' %}", 
				{ "ofKindID" : cell.field.ofKindID },
				function(json)
				{
					if (json.success) {
						var rootObjects = [];
						$(json.objects).each(function()
						{
							rootObjects.push(dataTypes._object.copyValue(this));
						});
						
						rootObjects.sort(function(a, b)
							{
								return a.getDescription().localeCompare(b.getDescription());
							});
					
						var sections = panel2Div.appendSections(rootObjects);
					
						var buttons = appendButtons(sections)
							.on("click", function(d) {
								if (prepare_click())
								{
									if (oldData && oldData.id != null)
									{
										if (d.getValueID() == oldData.getValueID()) {
											hide_panel_right(panelDiv.node());
										}
										else
										{
											initialData = [{id: oldData.id, elementID: "_value", value: d.getValueID()}];
											$.post("{% url 'submitUpdateValues' %}", 
													{ csrfmiddlewaretoken: '{{ csrf_token }}', 
														"commands": JSON.stringify(initialData),
														"timezoneoffset": new Date().getTimezoneOffset()
													})
												  .done(function(json, textStatus, jqXHR)
													{
														if (json.success) {
															closealert();
															oldData.completeUpdateValue(d);
															hide_panel_right(panelDiv.node());
														}
														else {
															bootstrap_alert.warning(json.error, ".alert-container");
															unblock_click();
														}
													})
												  .fail(standard_fail_function);
										}
									}
									else if (containerUUID)	/* In this case, we are adding an object to an existing object. */
									{
										$.post("{% url 'submitAddValue' %}", 
												{ csrfmiddlewaretoken: '{{ csrf_token }}', 
												  containerUUID: containerUUID,
												  elementUUID: cell.field.nameID,
												  valueUUID: d.getValueID(),
												  timezoneoffset: new Date().getTimezoneOffset()
												})
											  .done(function(json, textStatus, jqXHR)
												{
													if (json.success) {
														closealert();
														var newData = dataTypes[cell.field.dataType].newValue();
														newData.id = json.id;
														newData.value.description = d.getDescription();
														newData.value.id = d.getValueID();
														cell.addValue(newData);
														hide_panel_right(panelDiv.node());
													}
													else {
														bootstrap_alert.warning(json.error, ".alert-container");
														unblock_click();
													}
												})
											  .fail(standard_fail_function);
									}
									else 
									{
										closealert();
										store_unsaved_picked_value(cell, oldData, d);
										hide_panel_right(panelDiv.node());
									}
								}
								d3.event.preventDefault();
							});
						buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
							function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
						sections.append("hr");
					
						window.scrollTo(0, 0);
						show_panel_left(panelDiv.node());
					}
					else
					{
						alert(json['error']);
					}
				}
			);
		}
		
		/* This method gets called to bring up a configuration panel when adding
			a new instance of an object to another object. For example, adding a 
			configuration to an object with a uuname kind.
		 */
		function show_add_object_panel(containerCell, containerUUID, containerPanel, storeDataFunction) {
			$.getJSON("{% url 'getAddConfiguration' %}",
				{ "typeID" : containerCell.field.ofKindID }, 
				function(json)
				{
					if (json.success)
					{
						var cells = [];
						$(json.cells).each(function()
						{
							newCell = new Cell();
							newCell.field = this.field;
							newCell.setup(null);
							cells.push(newCell);
						});
						
						var panelDiv = create_panel(containerPanel, containerCell, "New " + containerCell.field.name)
							.classed("edit-panel", true);
			
						var header = "New " + containerCell.field.name								 
						var navContainer = panelDiv.appendNavContainer();
			
						var backButton = navContainer.appendLeftButton()
							.on("click", handle_close_down_event);
						
						backButton.append("span").text("Cancel");
			
						var onSuccessFunction = function(newData) {
							hide_panel_down(panelDiv.node());
						};
							
						var addButton = navContainer.appendRightButton()
							.on("click", function(d) {
								if (prepare_click())
								{
									show_click_feedback(this);
									
									storeDataFunction(containerCell, containerUUID, sections, onSuccessFunction);
								}
								d3.event.preventDefault();
							});
						addButton.append("span").text("Add");
			
						var panel2Div = panelDiv.appendScrollArea();
						panel2Div.appendHeader();
						var alertContainer = panel2Div.append("div").classed("alert-container", true);
						
						var sections = panel2Div.appendSections(cells)
							.each(function(cell) {
									dataTypeViews[cell.field.dataType].showAdd(this, panelDiv, cell, null);
								});
			
						window.scrollTo(0, 0);
						show_panel_up(panelDiv.node());
					}
					else
						alert(json.error);
				}
			);
		}
		
		/* This is a storeDataFunction for adding an object within an unsaved object. */
		function store_new_instance(containerCell, containerUUID, sections, onSuccessFunction)
		{
			closealert();
			var newData = dataTypes._object.newValue();
			newData.value.cells = [];
			sections.each(
				function(cell) {
					if ("updateCell" in dataTypeViews[cell.field.dataType])
						dataTypeViews[cell.field.dataType].updateCell(this, cell);
					newData.importCell(cell);
				});
				
			newData.calculateDescription();
			containerCell.addValue(newData);
			if (onSuccessFunction) onSuccessFunction(newData);
		}
		
		/* This is a storeDataFunction for creating a root object. */
		function submit_create_root_instance(containerCell, containerUUID, sections, onSuccessFunction)
		{
			var initialData = []
			sections.each(
				function(cell) {
					dt = dataTypeViews[cell.field.dataType]
					if ("updateCell" in dt)
						dt.updateCell(this, cell);
					dataTypes[cell.field.dataType].appendData(cell, initialData);
				});
				
			var jsonArray = { csrfmiddlewaretoken: '{{ csrf_token }}', 
						typeID: containerCell.field.ofKindID,
						properties: JSON.stringify(initialData),
						timezoneoffset: new Date().getTimezoneOffset()
					};
			
			$.post("{% url 'submitCreateInstance' %}", 
					jsonArray)
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							/* Copy the data from json object into newData so that 
								any functions are properly initialized.
							 */
							var newData = dataTypes._object.newValue();
							newData.value.id = json.object.value.id;
							newData.value.description = json.object.value.description;
							containerCell.addValue(newData);
							if (onSuccessFunction) onSuccessFunction(newData);
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							unblock_click();
						}
					})
				  .fail(standard_fail_function);
		}

		/* This is a storeDataFunction for creating an object within a saved object. */
		function submit_create_instance(containerCell, containerUUID, sections, onSuccessFunction)
		{
			var initialData = []
			sections.each(
				function(cell) {
					dt = dataTypeViews[cell.field.dataType]
					if ("updateCell" in dt)
						dt.updateCell(this, cell);
					dataTypes[cell.field.dataType].appendData(cell, initialData);
				});
				
			var jsonArray = { csrfmiddlewaretoken: '{{ csrf_token }}', 
						typeID: containerCell.field.ofKindID,
						properties: JSON.stringify(initialData),
						timezoneoffset: new Date().getTimezoneOffset()
					};
			if ('elementName' in containerCell.field)
				jsonArray.elementName = containerCell.field.elementName;
			if ('nameID' in containerCell.field)
				jsonArray.elementUUID = containerCell.field.nameID;
			if (containerUUID)
				jsonArray.containerUUID = containerUUID;
			
			$.post("{% url 'submitCreateInstance' %}", 
					jsonArray)
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							/* Copy the data from json object into newData so that 
								any functions are properly initialized.
							 */
							var newData = dataTypes._object.newValue();
							/* If there is a container, then the id in newData will contain
								the id of the value object in the database. */
							if (containerUUID)
								newData.id = json.object.id;
							newData.value.id = json.object.value.id;
							newData.value.description = json.object.value.description;
							containerCell.addValue(newData);
							if (onSuccessFunction) onSuccessFunction(newData);
						}
						else {
							bootstrap_alert.warning(json.error, ".alert-container");
							unblock_click();
						}
					})
				  .fail(standard_fail_function);
		}
	</script>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  </body>
</html>
