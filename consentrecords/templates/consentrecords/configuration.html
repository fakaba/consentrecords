<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>{{header}}</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">
    <link href="{% static "consentrecords/css/base.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
	<!-- Styles for this web page -->
	<style>
		body {
		  background: #eee;
		}
	</style>

  </head>

  <body>
	<div id="id_panel1" class="site-panel list-panel">
		<nav class="navbar navbar-default site-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="pull-left">
					<div id="id_cancelButton" class="cancel-button site-navbar-link site-active-text">Done</div>
				</div>
				<div class="pull-right">
					<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
						<span>+</span>
					</div>
				</div>
				<div class="site-navbar-commands">
					<div class="site-title site-fill"><span class="site-inner-fill">{{header}}</span></div>
				</div>
			</div>
		</nav>
		<div id="id_scrollableArea" class="panel-scrolling">
			<div>
				<div class="alert-container"></div>
			</div>
			<div id="id_searchArea" class="searchbar">
				<span id="id_searchCancelButton" class="search-cancel-button site-disabled-text"><span>Cancel</span></span>
				<div id="id_searchInputContainer" class="search-input-container">
					<input id="id_searchInput" class="search-input" placeholder="Search">
					</input>
				</div>
			</div>
			<div id="id_objects">
			</div>
		</div> <!-- /container-fluid -->
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "consentrecords/js/models.js" %}"></script>
	<script src="{% static "consentrecords/js/views.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
	
		function standard_json_fail_function(error)
		{
			bootstrap_alert.warning(error, ".alert-container");
			unblock_click();
		}
 
		var storedcsrftoken = "{{ csrf_token }}";
		var headerText = "{{header}}";
		
		$("title").text(headerText);
		$(".site-navbar-commands .site-title .site-inner-fill").text(headerText);
		
		/* For show methods, the obj is the DOM object that contains the item being shown.
							 the d object contains the field information.
							 d["_data"] has the data for the instance of this field.
		 */
		 
		$(document).ready (function(e) {
			$("#id_cancelButton").click(function(e) {
				window.location = "{{ backURL }}";
				e.preventDefault();
			});
			
			$("#id_searchInput").on("keyup input paste", function(){
				val = this.value;
				if (val.length == 0)
				{
					/* Show all of the items. */
					d3.select("#id_objects").selectAll("div")
						.style("display", "block");
				}
				else
				{
					/* Show the items whose description is this.value */
					d3.select("#id_objects").selectAll("div")
						.style("display", function(d)
							{
								if (d.getDescription().indexOf(val) >= 0)
									return "block";
								else
									return "none";
							});
				}
				d3.select("#id_searchCancelButton")
					.classed("site-disabled-text", val.length == 0)
					.classed("site-active-text", val.length > 0);
			});
			
			$("#id_searchCancelButton").on("click", function() {
				$("#id_searchInput").val("");
				$("#id_searchInput").trigger("input");
			});

			var parentPanel = document.getElementById("id_panel1")
			var panelDiv = d3.select(parentPanel);
			panelDiv.attr("headerText", headerText);

			var cell = new cr.Cell();
			cell.field = {name: "Item",
						  dataType: "_object",
			{% if rootID %}
						  ofKindID: "{{rootID}}",
			{% endif %}
						  capacity: "_multiple values",
						  };
			cell.setup(null);
			
			var itemsDiv = d3.select("#id_objects")
				.data([cell]);
			cell.add_target("valueAdded", itemsDiv.node());
			itemsDiv.node().onValueAdded = get_on_value_added_function(d3.select(parentPanel), cell, null, show_view_object_panel);
			$(itemsDiv.node()).on("valueAdded", function(e, newData)
			{
				this.onValueAdded(e, newData);
				itemsDiv.selectAll("div").sort(function(a, b)
				{
					return a.getDescription().localeCompare(b.getDescription());
				});
			});
			
			{% if rootID %}
				$("#id_addUniversalObjectButton").click(function(e) {
					if (prepare_click())
					{
						show_click_feedback(this);
				
						show_add_object_panel(null, cell, null, panelDiv, submit_create_instance);
					}

					e.preventDefault();
				});
			{% else %}
				$("#id_addUniversalObjectButton").css("display", "none");
			{% endif %}
			
			var successFunction = function(newValues)
			{
				newValues.sort(function(a, b)
					{
						return a.getDescription().localeCompare(b.getDescription());
					});
				
				layout_objects(d3.select("#id_objects"), newValues,
					function(d) {
						if (prepare_click())
						{
							show_view_object_panel(d, cell, null, panelDiv);
						}
					});
			}
			
			var failFunction = function(error)
			{
				bootstrap_alert.warning(error, ".alert-container");
				/* Don't unblock here, because there was no block. */
			}
			
			cr.getValues("{{path}}", undefined, successFunction, failFunction);
		});
		
		$(document).ready(function(e) { resetidObjectsHeight() });
		$(window).resize(function(e) { resetidObjectsHeight() });
		
		resetidObjectsHeight = function()
		{
			var newHeight = window.innerHeight;
			$("#id_panel1").children().each(
				function() { if (this != document.getElementById("id_scrollableArea")) newHeight -= $(this).height(); }
			);
			$("#id_scrollableArea").height(newHeight);
		}
		
		function store_unsaved_picked_value(cell, oldData, newData)
		{
			if (oldData)
			{
				/* In this case, we are replacing an old value for
				   an item that was added to the item but not saved;
				   a placeholder or a previously picked value.
				 */
				if (newData.getValueID() != oldData.getValueID()) {
					oldData.completeUpdateValue(newData);
				}
			}
			else	/* In this case, we are adding an object to a new object. */
			{
				cell.addValue(newData);
			}
		}
		
		function get_view_panel_header(objectData, containerCell)
		{
			var headerText = objectData.getDescription();
			if (!objectData.hasTextDescription())
			{
				if (headerText.length > 0)
					headerText = containerCell.field.name + " (" + headerText + ")";
				else
					headerText = containerCell.field.name;
			}
			return headerText;
		}
		
		/* Displays a panel in which the specified object's contents appear.
		 */
		function show_view_object_panel(objectData, containerCell, containerUUID, containerPanel) {
			successFunction = function ()
			{
					
				var panelDiv = create_panel(containerPanel, 
											objectData, get_view_panel_header(objectData, containerCell))
					.classed("show-panel", true);
	
				var navContainer = panelDiv.appendNavContainer();
		
				var backButton = navContainer.appendLeftButton()
					.on("click", handle_close_right_event);
				backButton.append("span").classed("glyphicon glyphicon-chevron-left site-active-text", true);
				backButton.append("span").text(" " + containerPanel.attr("headerText"));
			
				var editButton = navContainer.appendRightButton()
					.on("click", function(d) {
						if (prepare_click())
						{
							show_click_feedback(this);
						
							show_edit_object_panel(objectData, containerCell, containerUUID, panelDiv);
						}
						d3.event.preventDefault();
					});
				editButton.append("span").text("Edit");
			
				var panel2Div = panelDiv.appendScrollArea();
		
				var headerDiv = panel2Div.appendHeader();
				objectData.add_target("dataChanged", headerDiv.node());
				$(headerDiv.node()).on("dataChanged", function(e) {
						d3.select(this).text(get_view_panel_header(objectData, containerCell));
					});

				var alertContainer = panel2Div.append("div").classed("alert-container", true);
									
				window.scrollTo(0, 0);
				show_panel_left(panelDiv.node());
			
				panel2Div.show_view_cells(objectData, containerCell, containerUUID, panelDiv);
			}
			
			failFunction = function(error)
			{
				alert(error);
				unblock_click();
			}
			
			objectData.checkCells(containerCell, successFunction, failFunction)
		}
		
		/* 
			Displays a panel for editing the specified object. 
		 */
		function show_edit_object_panel(objectData, containerCell, containerUUID, containerPanel) {
			var successFunction = function()
			{
				var panelDiv = create_panel(containerPanel, 
											objectData, "Edit " + containerCell.field.name)
								.classed("edit-panel", true);
	
				var navContainer = panelDiv.appendNavContainer();
		
				var doneButton = navContainer.appendRightButton();
				doneButton.append("span").text("Done");
		
				var panel2Div = panelDiv.appendScrollArea();
				panel2Div.appendHeader();
				var alertContainer = panel2Div.append("div").classed("alert-container", true);
				window.scrollTo(0, 0);
				show_panel_up(panelDiv.node());

				panel2Div.show_edit_cells(objectData, containerCell, panelDiv);
	
				doneButton.on("click", function(d) {
					if (prepare_click())
					{
						show_click_feedback(this);
					
						var sections = panel2Div.selectAll("section");
						var successFunction = function()
						{
							hide_panel_down($(doneButton.node()).parents(".site-panel")[0]);
						};
						if (objectData.getValueID())
						{
							/* This object has been previously saved. Update the data. */
							var initialData = [];
							var sourceObjects = [];
							sections.each(function(cell) {
									if ("appendUpdateCommands" in dataTypeViews[cell.field.dataType])
										dataTypeViews[cell.field.dataType].appendUpdateCommands(this, cell, objectData, initialData, sourceObjects);
								});
							var updateValuesFunction = function()
							{
								sections.each(function(cell) {
										if ("updateCell" in dataTypeViews[cell.field.dataType])
											dataTypeViews[cell.field.dataType].updateCell(this, cell);
									});
							}
							if (initialData.length > 0) {
								cr.updateValues(storedcsrftoken, initialData, sourceObjects, updateValuesFunction, successFunction, standard_json_fail_function);
							}
							else
							{
								successFunction();
							}
						}
						else if (containerUUID != null)
						{
							submit_create_instance(objectData, containerCell, containerUUID, sections, successFunction);
							/* Add this item to the contained object. */
						}
						else
						{
							/* In this case, we are editing an object that is contained in an object
								that hasn't been saved. */
							objectData.value.cells = [];
							sections.each(
								function(cell) {
									if ("updateCell" in dataTypeViews[cell.field.dataType])
										dataTypeViews[cell.field.dataType].updateCell(this, cell);
									objectData.importCell(cell);
								});
				
							objectData.calculateDescription();
							objectData.trigger_event("dataChanged");
							successFunction();
						}
					}
					d3.event.preventDefault();
				});
			}
			
			failFunction = function(error)
			{
				alert(error);
				unblock_click();
			}
			
			objectData.checkCells(containerCell, successFunction, failFunction);
		}
		
		/* Displays a panel from which a user can select an object of the kind required 
			for objects in the specified cell.
		 */
		function show_pick_object_panel(oldData, cell, containerUUID, containerPanel) {
			var failFunction = standard_json_fail_function;
			
			function selectAllSuccessFunction(rootObjects) {
				if (!("pickObjectPath" in cell.field && cell.field.pickObjectPath))
				{
					rootObjects.sort(function(a, b)
						{
							return a.getDescription().localeCompare(b.getDescription());
						});
				}
			
				var panelDatum;
				if (oldData && oldData.id)
					panelDatum = oldData;	/* Replacing an existing object. */
				else
					panelDatum = cell;		/* Adding a new object. */
				var panelDiv = create_panel(containerPanel, panelDatum, cell.field.name)
					.classed("list-panel", true);
		
				var navContainer = panelDiv.appendNavContainer();
		
				var backButton = navContainer.appendLeftButton()
					.on("click", handle_close_right_event);
				backButton.append("span").text("Cancel");
		
				var panel2Div = panelDiv.appendScrollArea();
				panel2Div.appendHeader();
				var alertContainer = panel2Div.append("div").classed("alert-container", true);
				
				var sections = panel2Div.appendSections(rootObjects);
			
				var buttons = appendButtons(sections)
					.on("click", function(d) {
						var successFunction = function()
						{
							hide_panel_right(panelDiv.node());
						}
						
						if (prepare_click())
						{
							if (oldData && oldData.id != null)
							{
								if (d.getValueID() == oldData.getValueID()) {
									successFunction();
								}
								else
								{
									cr.updateValue(storedcsrftoken, oldData, d, successFunction, failFunction);
								}
							}
							else if (containerUUID)	/* In this case, we are adding an object to an existing object. */
							{
								cr.addObjectValue(storedcsrftoken, cell, containerUUID, d, 
									successFunction,
									failFunction);
							}
							else 
							{
								store_unsaved_picked_value(cell, oldData, d);
								successFunction();
							}
						}
						d3.event.preventDefault();
					});
				buttons.insert("span", ":first-child").classed("glyphicon glyphicon-ok pull-left", 
					function(d) { return oldData && d.getDescription() == oldData.getDescription(); });
				sections.append("hr");
			
				window.scrollTo(0, 0);
				show_panel_left(panelDiv.node());
			}
			
			cr.getValues(cell.field.pickObjectPath, cell.field.ofKindID, selectAllSuccessFunction, failFunction);
		}
				
		/* This method gets called to bring up a configuration panel when adding
			a new instance of an object to another object. For example, adding a 
			configuration to an object with a uuname kind.
		 */
		function show_add_object_panel(oldValue, containerCell, containerUUID, containerPanel, storeDataFunction) {
			var successFunction = function(cells)
			{
				var panelDiv = create_panel(containerPanel, containerCell, "New " + containerCell.field.name)
					.classed("edit-panel", true);
	
				var navContainer = panelDiv.appendNavContainer();
	
				var backButton = navContainer.appendLeftButton()
					.on("click", handle_close_down_event);
				
				backButton.append("span").text("Cancel");
	
				var onSuccessFunction = function(newData) {
					hide_panel_down(panelDiv.node());
				};
					
				var addButton = navContainer.appendRightButton()
					.on("click", function(d) {
						if (prepare_click())
						{
							show_click_feedback(this);
							
							storeDataFunction(oldValue, containerCell, containerUUID, sections, onSuccessFunction);
						}
						d3.event.preventDefault();
					});
				addButton.append("span").text("Add");
	
				var panel2Div = panelDiv.appendScrollArea();
				panel2Div.appendHeader();
				var alertContainer = panel2Div.append("div").classed("alert-container", true);
				
				var sections = panel2Div.appendSections(cells)
					.each(function(cell) {
							dataTypeViews[cell.field.dataType].showAdd(this, panelDiv, cell, null);
						});
	
				window.scrollTo(0, 0);
				show_panel_up(panelDiv.node());
			}
			
			var failFunction = standard_json_fail_function
			
			cr.getConfiguration(containerCell.field.ofKindID, successFunction, failFunction);
		}
		
		/* This is a storeDataFunction for adding an object within an unsaved object. */
		function store_new_instance(oldValue, containerCell, containerUUID, sections, onSuccessFunction)
		{
			closealert();
			var newData = cr.dataTypes._object.newValue();
			newData.value.cells = [];
			sections.each(
				function(cell) {
					if ("updateCell" in dataTypeViews[cell.field.dataType])
						dataTypeViews[cell.field.dataType].updateCell(this, cell);
					newData.importCell(cell);
				});
				
			newData.calculateDescription();
			if (oldValue)
				oldValue.completeUpdateValue(newData);
			else
				containerCell.addValue(newData);
			if (onSuccessFunction) onSuccessFunction(newData);
		}
		
		/* This is a storeDataFunction for creating an object. 
			If this is a root object, then containerUUID will be null.
		 */
		function submit_create_instance(oldValue, containerCell, containerUUID, sections, onSuccessFunction)
		{
			var initialData = []
			sections.each(
				function(cell) {
					dt = dataTypeViews[cell.field.dataType]
					if ("updateCell" in dt)
						dt.updateCell(this, cell);
					cr.dataTypes[cell.field.dataType].appendData(cell, initialData);
				});
				
			cr.append(storedcsrftoken, oldValue, containerCell, containerUUID, initialData, onSuccessFunction, standard_json_fail_function)
		}
	</script>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  </body>
</html>
