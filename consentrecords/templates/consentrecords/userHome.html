<!DOCTYPE html>
<html lang="en"
	xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

	{% if fbURL %}
    <meta property="og:url" content="{{fbURL}}">
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{fbTitle}}">
    <meta property="og:description" content="{{fbDescription}}">
    {% endif %}

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">
    <link href="{% static "custom_user/css/bodybackground.css" %}" rel="stylesheet">
    <link href="{% static "consentrecords/css/base.css" %}" rel="stylesheet">
    
    <link href="{% static "custom_user/css/formsimple.css" %}" rel="stylesheet">
    <link href="{% static "custom_user/css/signin.css" %}" rel="stylesheet">

    <style>
    	.consent-record {
    		margin-top: 3px;
    	}
    	.consent-form-title {
    	}
    	.consent-record-accept-button {
    	}
    	.button-section {
    		float: bottom;
    	}
    	.organization-section {
    		display: none;
    	}
    	.level-2-panel {
    		top: 0;
    		z-index: 2;
    	}
    	.level-3-panel {
    		top: 0;
    		z-index: 3;
    	}
    	.level-4-panel {
    		top: 0;
    		z-index: 4;
    	}
    	nav {
    		opacity: 0.8;
    	}
    	.sub-text {
    		font-size: smaller;
    	}
    	.centered-right-glyph {
			position: absolute;
			top: 50%;
			-moz-transform: translateY(-50%);
			-webkit-transform: translateY(-50%);
			transform: translateY(-50%);
			float: right;
			right: 12px;
	   	}
	   	.centered-right-2 {	/* To the left of a centered-right-glyph */
			width: auto;
			float: right;
			margin-right: 24px;
			text-align: right;
	   	}
	   	.background-gradient-panel .row-button {
	   		position: relative;
    		background: white;
    		opacity: 0.6;
	   	}
		.background-gradient-panel .row-button:hover {
			opacity: 0.8;
		}
	   	.panel-input-container {
	   		margin-top: 9px;
	   		padding-top: 3px;
	   		padding-left: 12px;
	   		padding-right: 12px;
	   		width: 100%;
	   	}
	   	.panel-input {
	   		width: 100%;
	   	}
    	.sign-in-button {
    	    padding-top: 6px;
    	    padding-right: 15px;
    	}
    	.option-label {
    		margin-top: 15px;
    		margin-left: 15px;
    	}
    	.option-item {
    		margin-top: 15px;
    		margin-left: 45px;
    	}
    	.share-container {
    		position: fixed;
    		bottom: 0px;
    		width: 100%;
    		padding: 6px 12px;
    	}
    </style>
	</head>
	
  	<body class="site-body">
  	
		{% if facebookIntegration %}
  		<div id="fb-root"></div>
		<script>
		  window.fbAsyncInit = function() {
			FB.init({
			  appId      : '1503871976607590',
			  status     : true,
			  cookie     : true,
			  xfbml      : true,
			  version    : 'v2.5'
			});
		  };

		  (function(d, s, id){
			 var js, fjs = d.getElementsByTagName(s)[0];
			 if (d.getElementById(id)) {return;}
			 js = d.createElement(s); js.id = id;
			 js.src = "//connect.facebook.net/en_US/sdk.js";
			 fjs.parentNode.insertBefore(js, fjs);
		   }(document, 'script', 'facebook-jssdk'));
		</script>
		{% endif %}
		
  		<panel id="id_user_home_panel" class="base-panel site-panel background-gradient-panel" >
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<div class="pull-right">
						<div class="sign-in-button site-trio-clipped site-active-text site-navbar-link site-active-text">
							<span id="sign-in-span">Sign&nbsp;In</span>
						</div>
					</div>
				</div>
			</nav>
			<h3 class="username-label left-label"> </h3>
			<div class="alert-container"></div>
			<section class="button-section">
				<section class="row-button-group">
					<button panelID = "id_find_experience_panel"
						class="btn row-button site-active-text find_experience_button show-panel-button">
						<span class="pull-left">Find a New Experience</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
					<button panelID = "id_your_pathway_panel"
						class="check-signin-button btn row-button site-active-text">
						<span class="pull-left">My Pathway</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
					<button panelID = "id_your_plans_panel"
						class="check-signin-button btn row-button site-active-text">
						<span class="pull-left">My Plans</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
					<button panelID = "id_consent_forms_panel"
						class="check-signin-button btn row-button site-active-text">
						<span class="pull-left">Consent Forms</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
				</section>
				<section class="organization-section row-button-group">
				</section>
				<section class="row-button-group">
					<button panelID = "id_sharing_panel"
						class="check-signin-button btn row-button site-active-text">
						<span class="pull-left">Sharing</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
					<button panelID = "id_settings_panel"
						class="check-signin-button btn row-button site-active-text">
						<span class="pull-left">Settings</span>
						<span class="glyphicon glyphicon-chevron-right site-chevron-right pull-right"></span>
					</button>
				</section>
			</section>
		</panel>
		
		<panel id="id_sign_in_panel" class="level-2-panel site-panel configuration-panel background-gradient-panel">
		  <form class="form-simple form-signin">
			<div class="site-title">Sign In to Consent Records</div>
			<div class="alert-container"></div>
			<label for="id_username" class="sr-only">Email address</label>
			<input type="email" id="id_username" maxlength="254" name="username" class="form-control" placeholder="Email address" required autofocus>
			<label for="id_password" class="sr-only">Password</label>
			<input type="password" id="id_password" name="password" class="form-control" placeholder="Password" required>
			<div class="checkbox">
			  <label>
				<input id="id_rememberme" type="checkbox" value="remember-me"> Remember me
			  </label>
			</div>
			<div class="site-trio-container">
				<span class="signin-cancel-button site-trio-clipped site-active-text">Cancel</span>
				<div class="site-trio-fill"></div>
				<span class="submit-button site-trio-clipped site-active-text">Sign&nbsp;In</span>
			</div>
		  </form>
	  
		  <hr />

		  <div class="div-create-new-account">
			Don't have an account? <a id="id_signup_link" class="site-active-text">Create one now.</a>
		  </div>
		  <div class="div-forgot-password">
			Forgot your password? <a id="id_forgot_password_link" class="site-active-text">Reset it now.</a>
		  </div>
		</panel> <!-- /container -->
		
		<panel id="id_sign_up_panel" class="level-2-panel site-panel configuration-panel background-gradient-panel">
			<form class="form-simple">
				<div class="site-title">Sign Up for Consent Records</div>
				<div class="row">
					<div class="alert-container" class="col-xs-12"></div>
				</div>
				<div class="row">
					<div class="form-group col-xs-12">
						<label for="id_username" class="control-label sr-only">Email Address</label> 
						<input id="id_username" class="form-control" maxlength="254" name="username" 
							   type="email" placeholder="Email address"/>
					</div>
					<div class="form-group col-xs-12">
						<label for="id_password"  class="control-label sr-only">Password</label> 
						<input id="id_password" class="form-control password-control" name="password" type="password" placeholder="Password" />
					</div>
					<div id="id_confirm_form_group" class="form-group col-xs-12 has-feedback">
						<label for="id_confirmpassword"  class="control-label sr-only">Confirm Password</label> 
						<input id="id_confirmpassword" class="form-control password-control" name="confirmpassword" type="password" placeholder="Confirm password" />
						<span id="id_passwordOK" class="glyphicon form-control-feedback"></span>
					</div>
					<div class="form-group col-xs-12">

						<!-- maxLength of firstname is the same as in the custom_user.AUser.firstName field -->
						<label for="id_firstname"  class="control-label sr-only">First Name</label> 
						<input id="id_firstname" class="form-control" maxlength="30" name="firstName" type="text" placeholder="First name" required/>
					</div>
					<div class="form-group col-xs-12">
						<!-- maxLength of lastname is the same as in the custom_user.AUser.lastName field --!>
						<label for="id_lastname"  class="control-label sr-only">Last Name</label> 
						<input id="id_lastname" class="form-control" maxlength="50" name="lastName" type="text" placeholder="Last name" required />
					</div>
				</div>
				<div class="site-trio-container">
					<span class="done-button site-trio-clipped site-active-text">Cancel</span>
					<div class="site-trio-fill"></div>
					<span class="submit-button site-trio-clipped site-active-text">Sign&nbsp;Up</span>
				</div>
			</form>
		
			<hr />
			<div class="row">
				<a id="id_termsOfUseLink" class="btn btn-link btn-xs col-xs-12">Terms Of Use</a>
			</div>
			<div class="row">
				<div id="id_termsAlert" class="col-xs-12">				
				</div>
			</div>
		</panel>

		<panel id="id_forgot_password_panel" class="level-2-panel site-panel configuration-panel background-gradient-panel">
			<form class="form-simple">
				<div class="site-title">Forgot your Password?</div>
				<div class="help-block">Enter your email address to receive an email with a link you can click to reset your password.</div>

				<div class="row">
					<div class="alert-container col-xs-12"></div>
				</div>

			  <div class="row">
					<style>
						.feedback-control {
							width: calc(100% - 30px);
						}
					</style>
					<div class="col-xs-12">
						<div id="id_email_group" class="form-group has-feedback">
							<label for="id_email"  class="control-label sr-only">Email Address</label>
							<input id="id_email" class="form-control feedback-control" type="email" placeholder="Email"/>
							<span id="id_emailOK" class="glyphicon form-control-feedback"></span>
						</div>
					</div> 
			  </div>
				<div class="form-group site-trio-container">
					<span class="done-button site-trio-clipped site-active-text">Cancel</span>
					<div class="site-trio-fill"></div>
					<span class="submit-button site-trio-clipped site-active-text">Send&nbsp;Email</span>
				</div>
				<div class="row">
					<div id="id_alert_success" class="col-xs-12 div-success"></div>
				</div>
			</form>
		</panel>

	    <panel id="id_find_experience_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Find a New Experience</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_services">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_find_offering_panel" class="level-3-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Find a New Experience</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div class="searchbar">
				</div>
				<div id="id_offerings">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_your_pathway_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar-default site-navbar site-navbar-top" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">My Pathway</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="vertical-scrolling site-content-panel-under">
				<div id="id_pathway" class="site-fill-panel"></div>
				<div class="alert-container site-alert-under"></div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_your_plans_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">My Plans</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_plans">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_consent_forms_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Consent Forms</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_openConsentForms">
				</div>
			</div> <!-- /container-fluid -->
			<div class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div class="searchbar">
				</div>
				<div id="id_openConsentForms">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_sharing_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Sharing</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="vertical-scrolling site-content-panel-under">
				<div id="id_sharing" class="site-fill-panel"></div>
				<div class="alert-container site-alert-under"></div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_settings_panel" class="level-2-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Settings</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_settings">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    	<script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  	</body>

	<script src="{% static "jquery/js/jquery.min.js" %}"></script>
	<script src="{% static "jqueryui/js/jquery-ui.min.js" %}"></script>
	<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "jquerycookie/jquery.cookie.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "datejs/date.js" %}"></script>
	<script src="{% static "datejs/time.js" %}"></script>
	<script src="{% static "custom_user/js/bodybackground.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "consentrecords/js/models.js" %}"></script>
	<script src="{% static "consentrecords/js/domainmodels.js" %}"></script>
	<script src="{% static "consentrecords/js/views.js" %}"></script>
	<script src="{% static "consentrecords/js/showPathway.js" %}"></script>
	<script src="{% static "consentrecords/js/showSharing.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
		rightChevronPath = '{% static "consentrecords/png/ios7-arrow-forward-512px.svg" %}'
		leftChevronPath = '{% static "consentrecords/png/ios7-arrow-back-512px.svg" %}'

		var storedcsrftoken = "{{ csrf_token }}";
		var activeColor = "#2C55CC"
		
		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		$.ajaxSetup({
			beforeSend: function(xhr, settings) {
				if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
					xhr.setRequestHeader("X-CSRFToken", storedcsrftoken);
				}
			}
		});

		/* The global object used to identify the current user. */
		var userInstance = new cr.ObjectValue();
		{% if userID %}
		userInstance.value.id = "{{userID}}"
		userInstance.value.description = "{{ user.get_full_name }}"
		crp.pushCheckCells(userInstance, function() { }, asyncFailFunction);
		{% endif %}
		
		/* Update the username label when a user signs in or out. */	
		var usernameLabel = $(".username-label");
		userInstance.addTarget("signin.cr", usernameLabel[0]);
		userInstance.addTarget("signout.cr", usernameLabel[0]);
		usernameLabel.on("signin.cr", function(e, eventInfo)
		{
			$(this).text(eventInfo.getDescription());
		});
		usernameLabel.on("signout.cr", function(e, eventInfo)
		{
			$(this).text("");
		});
		
		/* Update the text of the signin button when a user signs in or out. */
		var signinSpan = $("#sign-in-span")
		userInstance.addTarget("signin.cr", signinSpan[0]);
		userInstance.addTarget("signout.cr", signinSpan[0]);
		signinSpan.on("signin.cr", function(e, eventInfo)
		{
			$(this).text("Sign Out");
		});
		signinSpan.on("signout.cr", function(e, eventInfo)
		{
			$(this).text("Sign In");
		});
		
		/* Update the list of organizations associated with the user when a user signs in or out. */
		var orgSection = $(".organization-section");
		userInstance.addTarget("signin.cr", orgSection[0]);
		userInstance.addTarget("signout.cr", orgSection[0]);
		orgSection.on("signin.cr", function(e, eventInfo)
		{
			load_organizations.call(this, eventInfo)
		});
		orgSection.on("signout.cr", function(e, eventInfo)
		{
			hide_organizations.call(this, eventInfo)
		});
		
		/* Initialize all of the objects that are dependent on whether or not the user is
			signed in.
		 */
		if (userInstance.getValueID())
			userInstance.triggerEvent("signin.cr", userInstance);
		else
			userInstance.triggerEvent("signout.cr", userInstance);

		/* Handle a click event on the sign-in button to either sign in or sign out
			the current user.
		 */
		$(".sign-in-button").click(function(e) {
			if (prepareClick())
			{
				if (userInstance.getValueID())
				{
					var successFunction = function()
					{
						userInstance.value = {id: "", description: ""};
						userInstance.triggerEvent("signout.cr", userInstance);
						unblockClick();
					};
					
					sign_out(successFunction, syncFailFunction);
				}
				else
				{
					showFixedPanel($(this).parents(".site-panel")[0], "#id_sign_in_panel");
				}
			}
			e.preventDefault();
		});

		/* Show a pre-defined panel associated with this button. */
		function showPanel(e)
		{
			var panelDiv = d3.select("#" + d3.select(this).attr("panelID"));
			if (prepareClick())
			{
				showClickFeedback(this);
				showPanelLeft(panelDiv.node());
			}
		}
		
		/* Hide the currently displaying panel with no further action. */		
		function hidePanel(e)
		{
			if (prepareClick())
			{
				showClickFeedback(this);
				hidePanelRight($(this).parents(".site-panel")[0], false);
			}
		}
		
		/* Remove all of the functions associated with a target that handles a signin
			message */
		function removeSignin(target)
		{
			$(target).off("signin.cr");
			$(target).off("signinCanceled.cr");
			userInstance.removeTarget("signin.cr", target);
			userInstance.removeTarget("signinCanceled.cr", target);
		}
		
		/* Initialize the buttons that show a pre-defined panel. */
		$(".show-panel-button").click(showPanel);
		
		/* Initialize the buttons that hide the currently displaying panel with no further action. */
		$(".done-button").click(hidePanel);
		
		$(".check-signin-button").click(function(e)
		{
			if (userInstance.getValueID())
				showPanel.call(this, e);
			else
			{
				var _this = this;
				var panel = $(this).parents(".site-panel")[0];
				userInstance.addTarget("signin.cr", panel);
				userInstance.addTarget("signinCanceled.cr", panel);
				
				$(panel).on("signin.cr", function()
				{
					removeSignin(this);
					if (prepareClick())
						showPanelLeft("#" + _this.getAttribute("panelID"));
				});
				
				$(panel).on("signinCanceled.cr", function()
				{
					removeSignin(this);
				});
				
				if (prepareClick())
					showFixedPanel(panel, "#id_sign_in_panel");
			}

			e.preventDefault();
		});
		
		$(document).ready (function(e) {
			$("#id_find_experience_panel").on("revealing.cr", function(e, eventInfo)
				{
					show_services("#id_services");
				});
				
			setupSearchBar("#id_find_experience_panel .searchbar",
				getFilter("#id_services"));
				
			$("#id_find_offering_panel").on("revealing.cr", function(e, eventInfo)
				{
					var datum = d3.select(this).datum();
					showSessions(datum, "#id_offerings");
				});
				
			setupSearchBar("#id_find_offering_panel .searchbar",
				getFilter("#id_offerings"));
				
			$("#id_your_pathway_panel").on("revealing.cr", function(e, eventInfo)
			{
				showPathway("#id_pathway");
			});
			$("#id_your_pathway_panel").on("hiding.cr", hidePathway);
			$("#id_your_plans_panel").on("revealing.cr", function(e, eventInfo)
			{
				show_plans("#id_plans");
			});
			$("#id_consent_forms_panel").on("revealing.cr", function(e, eventInfo)
				{
					show_consent_records("#id_openConsentForms");
				});	
			
			$("#id_sharing_panel").on("revealing.cr", function(e, eventInfo)
				{
					showSharing("#id_sharing");
				});	
			
			var signInSuccess = function(userData)
			{
				userInstance.value = userData;
				userInstance.checkCells(undefined, undefined, function()
					{
						hidePanelRight($("#id_sign_in_panel")[0], false,
							function()
							{
								userInstance.triggerEvent("signin.cr", userInstance);
							});
						
					},
					syncFailFunction);
			}
				
			/* Items for the sign-in panel. */
			$("#id_sign_in_panel .submit-button").click(function(e) {
				if (prepareClick())
				{
					signIn.submit(signInSuccess, syncFailFunction);
				}
				
			   //stop form submission
			   e.preventDefault();
			});
			
			$("#id_sign_in_panel .signin-cancel-button").click(function(e) {
				if (prepareClick())
				{
					showClickFeedback(this);
					hidePanelRight($("#id_sign_in_panel")[0], false,
						function()
						{
							userInstance.triggerEvent("signinCanceled.cr", userInstance);
						});
				}
				
			   e.preventDefault();
			});
			
			$("#id_sign_in_panel input[type='password']").keypress(function(e) {
				if (e.which == 13)
				{
					if (prepareClick())
					{
						signIn.submit(signInSuccess, syncFailFunction);
					}
					e.preventDefault();
				}
			});
	
			$("#id_sign_in_panel input[type='text']").bind("keyup input paste", signIn.checkenabled);
			$("#id_sign_in_panel input[type='password']").bind("keyup input paste", signIn.checkenabled);

			$("#id_sign_in_panel").on("revealing.cr", function()
			{
				$("#id_sign_in_panel #id_username").val($.cookie("email"));
				$("#id_sign_in_panel #id_password").val("");
				if ($("#id_sign_in_panel #id_username").val() !== "")
				{
					$("#id_sign_in_panel #id_rememberme").prop("checked", true);
					$("#id_sign_in_panel #id_password").focus();
				}
				else
					$("#id_sign_in_panel #id_username").focus();
				
				signIn.checkenabled();
			});	
			
			$("#id_sign_in_panel #id_signup_link").click(function(e) {
				if (prepareClick())
				{
					showFixedPanel($(this).parents(".site-panel")[0], "#id_sign_up_panel");
				}
				e.preventDefault();
			});

			$("#id_sign_in_panel #id_forgot_password_link").click(function(e) {
				if (prepareClick())
				{
					showFixedPanel($(this).parents(".site-panel")[0], "#id_forgot_password_panel");
				}
				e.preventDefault();
			});

			var signUpSuccess = function(userData)
			{
				userInstance.value = userData;
				userInstance.checkCells(undefined, undefined, function()
					{
						$("#id_sign_in_panel").hide("slide", {direction: "right"}, 0);
						hidePanelRight($("#id_sign_up_panel")[0], false,
							function()
							{
								userInstance.triggerEvent("signin.cr", userInstance);
							});
					},
				syncFailFunction);
			}

			$("#id_sign_up_panel .submit-button").click(function(e) {
				if (signUp.canSubmit())
				{
					if (prepareClick())
					{
						signUp.checkUnusedEmail(
							function() {
								signUp.submit(signUpSuccess, syncFailFunction);
							},
							syncFailFunction);
					}
				}

				e.preventDefault();
			});
		
			$("#id_sign_up_panel #id_termsOfUseLink").click(function(e) {
				signUp.showTermsOfUse();
				e.preventDefault();
			});
		
			$("#id_sign_up_panel").on("revealing.cr", function()
			{
				$("#id_sign_up_panel #id_username").focus();
				signUp.checkenabled();
			});
			
			$("#id_sign_up_panel input[type='text']").bind("keyup input paste", signUp.checkenabled);
			$("#id_sign_up_panel input[type='password']").bind("keyup input paste", signUp.checkenabled);

			$("#id_forgot_password_panel .submit-button").click(function(e) {
				if (forgotPassword.canSubmit())
				{
					if (prepareClick())
					{
						var successFunction = function()
						{
							$("#id_sign_in_panel").hide("slide", {direction: "right"}, 0);
							hidePanelRight($("#id_forgot_password_panel")[0], false)
						}
						forgotPassword.submit(successFunction, syncFailFunction);
					}
				}
			   //stop form submission
			   e.preventDefault();
			});

			$("#id_forgot_password_panel #id_email").bind("keyup input paste", forgotPassword.checkenabled);
			$("#id_forgot_password_panel").on("revealing.cr", function()
			{
				$("#id_forgot_password_panel #id_email").val("");
				$("#id_forgot_password_panel #id_email").focus();
				forgotPassword.checkenabled();
			});
			
			{% if state %}
			var stateString = "{{state}}"
				if (stateString.startsWith("findNewExperience"))
				{
					stateString = stateString.substring("findNewExperience".length);
					if (stateString.length > 0)
					{
						var serviceValueID = stateString.substring(0, 32);
						stateString = stateString.substring(32);
						$("#id_find_experience_panel").on("servicesShown.cr", function()
						{
							var cell = d3.select("#id_services").datum();
							for (var i = 0; i < cell.data.length; ++i)
							{
								var d = cell.data[i];
								if (d.getValueID() == serviceValueID)
								{
									d3.select("#id_find_offering_panel").datum(d);
									showPanelNow("#id_find_offering_panel");
									break;
								}
							}
							/* Only do this once, so turn it off. */
							$("#id_find_experience_panel").off("servicesShown.cr");
						});
						var offeringString = stateString.substring(0, 32);
						stateString = stateString.substring(32);
						$("#id_find_offering_panel").on("offeringsShown.cr", function()
						{
							var containerDiv = d3.select("#id_offerings");
							containerDiv.selectAll("li").each(function(d)
							{
								if (d.getValueID() == offeringString)
								{
									
									var panelDiv = showSessionDetails(d, 
										d3.select("#id_find_offering_panel").datum(),
										"#id_find_offering_panel");
									showPanelNow(panelDiv.node());
								}
							});
							/* Only do this once, so turn it off. */
							$("#id_find_offering_panel").off("offeringsShown.cr");
						});
					}
					showPanelNow("#id_find_experience_panel");
					stateString = "";	/* So it only happens once. */
				}
			{% endif %}
		});
		
		signUp = {
			checkenabled: function() {			
				if ($("#id_sign_up_panel #id_password").val() === "" ||
					$("#id_sign_up_panel #id_confirmpassword").val() !== $("#id_sign_up_panel #id_password").val())
				{
					$( "#id_sign_up_panel #id_confirm_form_group" ).removeClass( "has-success");
					$( "#id_sign_up_panel #id_passwordOK" ).removeClass( "glyphicon-ok" );
				}
				else
				{
					$( "#id_sign_up_panel #id_confirm_form_group" ).addClass( "has-success");
					$( "#id_sign_up_panel #id_passwordOK" ).addClass( "glyphicon-ok" );
				}
			},
			
			canSubmit: function ()
			{
				if ($("#id_sign_up_panel #id_username").val() === "") {
					bootstrap_alert.warning("An email address is required.", ".alert-container");
					$("#id_sign_up_panel #id_username").focus();
				}
				else if ($("#id_sign_up_panel #id_password").val() === "") {
					bootstrap_alert.warning("A password is required.", ".alert-container");
					$("#id_sign_up_panel #id_password").focus();
				}
				else if ($("#id_sign_up_panel #id_confirmpassword").val() != $("#id_sign_up_panel #id_password").val()) {
					bootstrap_alert.warning("Your password is not confirmed.", ".alert-container");
					$("#id_sign_up_panel #id_confirmpassword").focus();
				}
				else if ($("#id_sign_up_panel #id_firstname").val() === "") {
					bootstrap_alert.warning("A first name is required.", ".alert-container");
					$("#id_sign_up_panel #id_firstname").focus();
				}
				else if ($("#id_sign_up_panel #id_lastname").val() === "") {
					bootstrap_alert.warning("A last name is required.", ".alert-container");
					$("#id_sign_up_panel #id_lastname").focus();
				}
				else
					return true;	/* Everything is OK */
				
				return false;
			},
		
			showTermsOfUse: function() {
				var message = "<p>Information in this system will only be used according to your consent except " +
					" as required by law. By signing up for this system, you consent to allow this system to store" +
					" the information you have entered.</p>" + 
					"<p>In keeping with best security practices, passwords are not stored in this system.</p>" + 
					"<p>These terms of use have not been subject to any revision based on" +  
						" review by a lawyer." + 
					"</p>";
				$("#id_sign_up_panel #id_termsAlert").html('<div class="alert alert-info alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+message+'</div>');
			},
			
			checkUnusedEmail: function(successFunction, failFunction) {
				bootstrap_alert.show($('.alert-container'), "Checking Email Address...<br>(this may take a minute)", "alert-info");
		
				deferredObject = $.post("{% url 'checkUnusedEmail' %}", 
					{ csrfmiddlewaretoken: storedcsrftoken, 
					  email: $("#id_username").val(),
					})
				  .done(function(json, textStatus, jqXHR)
					{
						if (json.success) {
							closealert();
							if (successFunction)
								successFunction();
						}
						else {
							failFunction(json.error);
						}
					})
				  .fail(function(jqXHR, textStatus, errorThrown) {
						cr.postFailed(jqXHR, textStatus, errorThrown, failFunction);
					});
			},
			
			submit: function(successFunction, failFunction)
			{
				bootstrap_alert.show($('alert-container'), "Signing up...<br>(this may take a minute)", "alert-info");
		
				deferredObject = $.post("{% url 'submitNewUser' %}", 
					{ csrfmiddlewaretoken: storedcsrftoken, 
						username: $("#id_sign_up_panel #id_username").val(),
						password: $("#id_sign_up_panel #id_password").val(),
						firstName: $("#id_sign_up_panel #id_firstname").val(),
						lastName: $("#id_sign_up_panel #id_lastname").val(),
		  				timezoneoffset : new Date().getTimezoneOffset()
					})
				  .done(function(json, textStatus, jqXHR)
					{
						if (json['success']) {
							/* A successful sign-up updates the storedcsrftoken */
							storedcsrftoken = $.cookie("csrftoken");
							
							successFunction(json.user);
						}
						else {
							failFunction(json.error);
						}
					})
				  .fail(function(jqXHR, textStatus, errorThrown) {
						cr.postFailed(jqXHR, textStatus, errorThrown, failFunction);
				  });
			},
		}
		
		signIn = {
			canSubmit: function() {
			return $("#id_sign_in_panel #id_password").val() !== "" &&
				$("#id_sign_in_panel #id_username").val() !== "";
			},
		
			checkenabled: function() {			
				if (!signIn.canSubmit())
				{
					$("#id_sign_in_panel .submit-button").addClass("site-disabled-text");
					$("#id_sign_in_panel .submit-button").removeClass("site-active-text");
				}
				else
				{
					$("#id_sign_in_panel .submit-button").removeClass("site-disabled-text");
					$("#id_sign_in_panel .submit-button").addClass("site-active-text");
				}
			},
		
			submit: function(successFunction, failFunction) {
				if (!signIn.canSubmit())
					return;
				
				bootstrap_alert.show($('.alert-container'), "Signing In...", "alert-info");
				
				$.post("{% url 'submitSignin' %}", { csrfmiddlewaretoken: storedcsrftoken, 
											  username : $("#id_username").val(),
											  password : $("#id_password").val(),
											  timezoneoffset : new Date().getTimezoneOffset() }, 
					function(json){
				if (json.success) {
					/* A successful sign-in updates the storedcsrftoken */
					storedcsrftoken = $.cookie("csrftoken");
					
					if ($("#id_sign_in_panel #id_rememberme").prop("checked"))
						$.cookie("email", $("#id_sign_in_panel #id_username").val(), { expires : 10 });
					else
						$.removeCookie("email");
						
					$("#id_sign_in_panel #id_username").val("")
					$("#id_sign_in_panel #id_password").val("")
						
					$.cookie("authenticator", "email", { path: "/"});
					if (successFunction)
					{
						successFunction(json.user);
					}
				}
				else
					failFunction(json.error);
			  })
				.fail(function(jqXHR, textStatus, errorThrown)
				{
					cr.postFailed(jqXHR, textStatus, errorThrown, failFunction);
				});
			}
		};

		forgotPassword = {
			canSubmit: function() {
				var testusername = $("#id_email").val();
				return validateEmail(testusername);
			},
		
			checkenabled: function() {			
				if (!forgotPassword.canSubmit())
				{
					$(".submit-button").addClass("site-disabled-text")
									   .removeClass("site-active-text")
									   .prop( "disabled", true );
					$( "#id_email_group" ).removeClass( "has-success");
					$( "#id_emailOK" ).removeClass( "glyphicon-ok" );
				}
				else
				{
					$(".submit-button").removeClass("site-disabled-text")
									   .addClass("site-active-text")
									   .prop( "disabled", false );
					$( "#id_email_group" ).addClass( "has-success");
					$( "#id_emailOK" ).addClass( "glyphicon-ok" );
				}
			},
			
			submit: function(successFunction, failFunction) {
				bootstrap_alert.success('Sending email (this may take a few minutes)...', '#id_alert_success');
				
				deferredObject = $.post("{% url 'resetPassword' %}", 
					{ csrfmiddlewaretoken: '{{ csrf_token }}', 
						"email": $("#id_email").val()
					})
				  .done(function(json, textStatus, jqXHR)
					{
						closealert();
						if (json.success) {
							bootstrap_alert.success('Your email has been sent. <a href="{{nextURL}}">Continue</a>', '#id_alert_success');
							successFunction();
						}
						else {
							failFunction(json.error);
						}
					})
				  .fail(function(jqXHR, textStatus, errorThrown) {
				  	cr.postFailed(jqXHR, textStatus, errorThrown, failFunction);
				  });
			},
			
		};
				
		function getFilter(node)
		{
			return function()
			{
				var val = this.value.toLocaleLowerCase();
				if (val.length == 0)
				{
					/* Show all of the items. */
					d3.select(node).selectAll("div")
						.style("display", "block");
				}
				else
				{
					/* Show the items whose description is this.value */
					d3.select(node).selectAll("div")
						.style("display", function(d)
							{
								if (d.getDescription().toLocaleLowerCase().indexOf(val) >= 0)
									return "block";
								else
									return "none";
							});
				}
			}
		}
		
		function showFixedPanel(containerPanel, newNode)
		{
			var zIndex = parseInt($(containerPanel).css("z-index"))+1;
			var panel = d3.select(newNode);
			panel.style("z-index", zIndex);
			
			showPanelLeft(panel.node());
		}
			
		function sign_out(successFunction, failFunction) {
			bootstrap_alert.show($('#myAlert'), "Signing Out...", "alert-info");
		    $.post("{% url 'submitSignout' %}", { csrfmiddlewaretoken: storedcsrftoken }, 
		  								function(json){
		  	if (json['success']) {
		  		successFunction();
		  	}
		  	else
		  		failFunction(json.error);
		  })
		  	.fail(function(jqXHR, textStatus, errorThrown)
			{
				cr.postFailed(jqXHR, textStatus, errorThrown, failFunction);
			});
		}
		
		function show_consent_records(containerDiv) {
			var successFunction = function(newInstances)
			{
				var divs = d3.select(containerDiv).selectAll('div')
					.data(newInstances)
					.enter()
					.append('div').classed("consent-record cell-div", true);
				
				divs.append('div').classed("consent-record-accept-button right-label right-fixed-width-div right-label site-active-text", true)
					.text("I Accept");
				divs.append('div').classed("consent-form-title left-label string-label-div expanding-div", true)
					.text(function(d) { 
						return d.value.cells[0].data[0].value.description;
					});
			}
			
			var path = "#" + userInstance.getValueID() + '>"Consent Record"';
			cr.getData({path: path, 
						fields: ["parents"], 
						done: successFunction, 
						fail: asyncFailFunction});
		}
		
		function show_services(containerDiv) {
			var successFunction = function(newInstances)
			{
				var cell = new cr.Cell();
				cell.field = {
							  dataType: "_object",
							  name: "Service",
							  capacity: "_multiple values",
							  };
				cell.setup(null);
				newInstances.sort(function(a, b)
					{
						return a.getDescription().localeCompare(b.getDescription());
					});
					
				for (var i = 0; i < newInstances.length; i++)
				{
					var newI = crp.pushInstance(newInstances[i]);
					cell.pushValue(newI);
				}
				
				var container = d3.select(containerDiv);
				container.datum(cell);
				appendViewCellItems(container, cell, 
					function(d) {
						if (prepareClick())
						{
							var panelDiv = d3.select("#id_find_offering_panel");
							panelDiv.datum(d);
							showClickFeedback(this);
				
							showPanelLeft(panelDiv.node());
						}
					});
				$(containerDiv).trigger("servicesShown.cr");
			}
			
			var path = "Service";
			crp.getData({path: path, 
						 done: successFunction, 
						 fail: asyncFailFunction});
		}
		
		function cells_get_cell_by_name(cells, name)
		{
			for (var i = 0; i < cells.length; ++i)
			{
				var cell = cells[i];
				if (cell.field.name == name)
					return cell;
			}
			return undefined;
		}
		
		function get_cell_by_name(d, name)
		{
			d = crp.pushInstance(d);
			return cells_get_cell_by_name(d.value.cells, name);
		}
		
		function getStartDate(d)
		{
			return d.getDatum("Start Date");
		}
		
		function getEndDate(d) {
			return d.getDatum("End Date") || new Date().toISOString().substr(0, 10);
		}	

		function getDateRange(d)
		{
			var startDate = getStartDate(d);
			if (startDate === undefined || startDate === null)
				startDate = "";
			var endDate = getEndDate(d);
			if (endDate === undefined || endDate === null)
				endDate = "";
			var connector;
			if (startDate || endDate)
				connector = " - ";
			else
				connector = "";
			return startDate + connector + endDate;
		}
		
		function appendStringItem(obj, label, text, addBorder)
		{
			addBorder = (addBorder === undefined) ? true : addBorder;
			var sectionObj = d3.select(obj);
	
			sectionObj.classed("cell-div", true);
	
			var labelDiv = sectionObj.append("div").classed("cell-label", true)
				.text(label);
			var itemsDiv = sectionObj.append("div").classed("items-div", true);

			if (text)
			{
				labelDiv.classed("left-label left-fixed-width", true);
				itemsDiv.classed("right-label expanding-div", true);

				var setupItems = function(divs) {
					divs.append("div")
					.classed("string-value-view", true)
					.text(function(d) { return d; });
				}
	
				var divs = appendItems(itemsDiv, [text]);
				setupItems(divs);
			}
			else
				labelDiv.classed("left-label expanding-div", true);
				
			if (addBorder)
				sectionObj.append("div").classed("cell-border-below", true);	

		}

		function setMetaProperties(session, targetHRef)
		{
			var headDiv = d3.select("head");
			headDiv.selectAll("meta").each(function()
			{
				var metaObj = d3.select(this);
				if (metaObj.attr("property") &&
					metaObj.attr("property").startsWith("og:"))
					metaObj.remove();
			});
			var offering = session.getValue("Offering");
			var organization = session.getValue("Organization");
			var a = [{property: "og:url", content: targetHRef},
					 {property: "og:type", content: "website" },
					 {property: "og:title", content: offering.getDescription()},
					 {property: "og:description", content: session.getDescription() + "\n" + organization.getDescription()}];
			for (var i = 0; i < a.length; i++)
			{
				if (a[i].content)
					headDiv.append("meta")
						.attr("property", a[i].property)
						.attr("content", a[i].content);
			}
		}
		
		function showAgeRange(offering, successFunction)
		{
			crp.pushCheckCells(offering, 
				function()
				{
					var min = offering.getDatum("Minimum Age");
					var max = offering.getDatum("Maximum Age");
					var newText = "";
					if (min)
					{
						if (max)
						{
							if (min == max)
								newText = min;
							else
								newText = min + " - " + max;
						}
						else
							newText = min + " or older";
					}
					else if (max)
					{
						newText = "up to " + max;
					}
					successFunction(newText);
				},
				function()
				{
					successFunction("!");
				}
			);
		}
		
		function showGradeRange(offering, successFunction)
		{
			crp.pushCheckCells(offering, 
				function()
				{
					var min = offering.getDatum("Minimum Grade");
					var max = offering.getDatum("Maximum Grade");
					var newText = "";
					if (min)
					{
						if (max)
						{
							if (min == max)
								newText = min;
							else
								newText = min + " - " + max;
						}
						else
							newText = min + " or beyond";
					}
					else if (max)
					{
						newText = "up to " + max;
					}
					successFunction(newText);
				},
				function()
				{
					successFunction("!");
				}
			);
		}
		
		function showWebSite(offering, successFunction)
		{
			crp.pushCheckCells(offering, 
				function()
				{
					var newText = offering.getDatum("Web Site");
					successFunction(newText);
				},
				function()
				{
					successFunction("!");
				}
			);
		}
		
		function showSessionDetails(session, service, container)
		{
			var containerPanel = d3.select(container);
			var organization = session.getValue("Organization");
			var offering = session.getValue("Offering");
			var site = session.getValue("Site");
			
			session.calculateDescription();
			
			var panelDiv = createPanel(containerPanel, session, offering.getDescription())
				.classed("show-panel", true);
			var panel = panelDiv.node();
			
			var navContainer = panelDiv.appendNavContainer();

			var backButton = navContainer.appendLeftButton()
				.on("click", handleCloseRightEvent);
			backButton.append("span").text("Done");
			
			var buttonDiv = navContainer.appendRightButton();
			
			var shareDiv = panelDiv.append("div");
			var targetHRef;

			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendHeader();
			panel2Div.appendAlertContainer();
			
			if (organization)
			{
				var orgDiv = panel2Div.append("div");
				appendStringItem(orgDiv.node(), organization.getDescription(), null, false);
				if (site.getDescription() && (site.getDescription() !== organization.getDescription()))
				{
					orgDiv.append('div')
						.classed("left-label sub-text", true)
						.text(site.getDescription());
				}
				
				crp.pushCheckCells(site, function()
				{
					var address = site.getValue("Address");
					crp.pushCheckCells(address, function()
					{
						var streetCell = address.getCell("Street");
						var cityCell = address.getCell("City");
						var stateCell = address.getCell("State");
						var zipCell = address.getCell("Zip Code");
						if (streetCell)
							$(streetCell.data).each(function() {
								orgDiv.append('div')
									.classed("left-label sub-text", true)
									.text(this.value);
							});
						line = "";
						if (cityCell && cityCell.data.length)
							line += cityCell.data[0].value;
						if (stateCell && stateCell.data.length)
							line += ", " + stateCell.data[0].getDescription();
						if (zipCell && zipCell.data.length && zipCell.data[0].value)
							line += "  " + zipCell.data[0].value;
						if (line.trim())
							orgDiv.append('div')
								.classed('left-label sub-text', true)
								.text(line.trim());
						orgDiv.append('div').classed('cell-edit-div cell-border-below', true);
					},
					function() {
						orgDiv.append('div').classed('cell-edit-div cell-border-below', true);
					});
				},
				function() { }
				);
			}
			
			function appendStringDatum(cellName)
			{
				var v = session.getDatum(cellName);
				if (v)
				{
					var deadlineDiv = panel2Div.append("div");
					appendStringItem(deadlineDiv.node(), cellName, v);
					return deadlineDiv;
				}
				else
					return null;
			}
			
			var firstDiv = null;
			var nextDiv;
			firstDiv = appendStringDatum("Registration Deadline");
			
			nextDiv = appendStringDatum("Start Date");
			if (!firstDiv)
				firstDiv = nextDiv;
				
			nextDiv = appendStringDatum("End Date");
			if (!firstDiv)
				firstDiv = nextDiv;

			var cellDiv = panel2Div.append("div")
				.classed("cell-div", true);
			
			crp.pushCheckCells(offering, function()
				{
					var serviceCell = offering.getCell("Service");
					if (!service && serviceCell.data.length > 0)
						service = serviceCell.data[0];
						
					if (service)
					{
						shareDiv.classed("share-container site-navbar border-above", true);

						targetHRef = window.location.origin+"/find/"+service.value.id+"/"+session.value.id;

						setMetaProperties(session, targetHRef);
						var fbDiv = shareDiv.append("div")
							.classed("fb-share-button", true)
							.attr("data-href", targetHRef)
							.attr("data-layout", "button_count");
						var fbImage = fbDiv.append("img")
							.attr("src", "{% static "consentrecords/png/fb.png" %}")
							.style("height", "22px")
							.style("weight", "22px");
						{% if facebookIntegration %}
						fbDiv.on("click", function() {
							FB.ui({
								  method     : 'share',
								  href       : targetHRef
								  }, function(response){});
							d3.event.preventDefault();
						});
						{% endif %}
					}

					if (serviceCell.length > 0)
					{
						var labelDiv = cellDiv.append("div").classed("cell-label", true)
							.text("Services");
						var itemsDiv = cellDiv.append("div").classed("items-div", true);

						var divs = appendItems(itemsDiv, newInstances);
						var buttons = divs.append("div").classed("multi-line-item", true);
						appendButtonDescriptions(buttons, null);
						itemsDiv.classed("border-below", true);
					}
				},
				asyncFailFunction);
			
			var agesDiv = panel2Div.append("div");
			showAgeRange(offering, function(newText)
				{
					if (newText)
					{
						appendStringItem(agesDiv.node(), "Ages", newText);
						agesDiv.classed("cell-div", true);
					}
				});
			var gradesDiv = panel2Div.append("div");
			showGradeRange(offering, function(newText)
				{
					if (newText)
					{
						appendStringItem(gradesDiv.node(), "Grades", newText);
						gradesDiv.classed("cell-div", true);
					}
				});
			
			var webSiteDiv = panel2Div.append("div");	
			showWebSite(offering, function(newText)
				{
					if (newText)
					{
						webSiteDiv.classed("cell-div", true)
							.classed("border-below", true);
	
						var labelDiv = webSiteDiv.append("div")
							.classed("cell-label sub-text", true);
						var link = labelDiv
							.append("a")
							.classed("site-active-text", true)
							.attr("href", newText)
							.attr("target", "_blank")
							.text("More Info");
						labelDiv.classed("left-label expanding-div", true);
					}
				});

			var inquiriesCell = session.getCell("Inquiries")
			var newInstances = inquiriesCell.data;
			if (newInstances.length == 0 || !newInstances[0].getValueID())
				asyncFailFunction("Access Failure for Inquiries");
			else
			{
				var inquiriesInstance = newInstances[0];
				var inquiryInstance = null;
				var inquiryCell = null;
				var emailCell = null;
				
				var addInquiry = function()
				{
					email = userInstance.getDatum("_email");
					add_single_field_instance(inquiriesInstance, 
									   inquiryCell, 
									   emailCell, 
									   email, 
									   function(newData) { 
									   		bootstrap_alert.success("You have signed up for " + 
														  offering.getDescription() + "/" + session.getDescription() + "." +
														  " Look out for a notice when you are enrolled.",
														  ".alert-container");
									   		checkInquiryFunction([newData]); 
									   	},
									   asyncFailFunction);
				}
				
				var tryAddInquiry = function()
				{
					if (userInstance.getValueID())
					{
						addInquiry();
						unblockClick();
					}
					else
					{
						userInstance.addTarget("signin.cr", panel);
						userInstance.addTarget("signinCanceled.cr", panel);
						$(panel).on("signin.cr", function(e, eventInfo)
						{
							removeSignin(this);
							
							var userEmailCell = eventInfo.getCell("_email");
							var newEmail = userEmailCell.data[0].value;
							cr.selectAll({path: "#" + inquiriesInstance.getValueID() + ">Inquiry[_email=" + newEmail + "]",
								done: function(newInstances)
								{
									if (newInstances.length > 0)
									{
										inquiryInstance = newInstances[0];
										buttonDiv.text("Back Out");
										buttonDiv.on("click", deleteInquiryFunction);
										bootstrap_alert.success(userInstance.getDescription() + 
															  " already signed up for " + 
															  offering.getDescription() + "/" + session.getDescription(),
															  ".alert-container");
									}
									else
									{
										addInquiry();
									}
								},
								fail: asyncFailFunction});
						});
								
						$(panel).on("signinCanceled.cr", function()
						{
							removeSignin(this);
						});
						
						showFixedPanel(panel, "#id_sign_in_panel");
					}
				}
				
				var addNameFunction = function(e)
				{
					if (prepareClick())
					{
						showClickFeedback(this);
						
						if (inquiryCell && emailCell)
						{
							tryAddInquiry();
						}
						else
						{
							cr.getConfiguration(null, inquiriesCell.field.ofKindID, 
								function(cells)
								{
									inquiryCell = cells_get_cell_by_name(cells, "Inquiry");
									cr.getConfiguration(null, inquiryCell.field.ofKindID,
										function(cells)
										{
											emailCell = cells_get_cell_by_name(cells, "_email");
											tryAddInquiry();
										},
										syncFailFunction);
								}, 
								syncFailFunction);
						}
					}
					d3.event.preventDefault();
				};
				
				var deleteInquiryFunction = function(e)
				{
					if (prepareClick())
					{
						showClickFeedback(this);
						
						var successFunction = function(oldValue)
						{
							bootstrap_alert.success("You have backed out of " + 
										  offering.getDescription() + "/" + session.getDescription() + ".",
										  ".alert-container");
							checkInquiryFunction([]);
						}
						
						cr.deleteValue(inquiryInstance, successFunction, asyncFailFunction);
						
						unblockClick();
					}
					d3.event.preventDefault();
				};
				
				var checkInquiryFunction = function(newInstances)
				{
					if (newInstances.length > 0)
					{
						inquiryInstance = newInstances[0];
						buttonDiv.text("Back Out");
						buttonDiv.on("click", deleteInquiryFunction);
					}
					else
					{
						inquiryInstance = null;
						buttonDiv.text("Sign Up");
						buttonDiv.on("click", addNameFunction);
					}
				};
				
				if (userInstance.getValueID())
				{
					userInstance.checkCells(undefined, undefined, function()
					{
						var newEmail = userInstance.getDatum("_email");
						cr.selectAll({path: "#" + inquiriesInstance.value.id + ">Inquiry[_email=" + newEmail + "]",
							done: checkInquiryFunction,
							fail: asyncFailFunction});
					}, asyncFailFunction);
				}
				else
					checkInquiryFunction([]);
			}
			
			return panelDiv;
		}
		
		function compareSessions(a, b)
		{
			var aDate = a.getDatum("Start Date");
			var bDate = b.getDatum("Start Date");
			if (aDate)
			{
				if (bDate)
				{
					result = aDate.localeCompare(bDate);
					if (result == 0)
						return a.getDescription().localeCompare(b.getDescription());
					else
						return result;
				}
				else
					return -1;
			}
			else
			{
				if (bDate)
					return 1;
				else
					return a.getDescription().localeCompare(b.getDescription());
			}
		}
		
		function showSessionDetailPanel(session, service)
		{
		}
		
		function appendSessionDescriptions(buttons)
		{
			var leftText = buttons.append('div').classed("consent-form-title left-expanding-div", true);
			
			leftText.append('div')
				.text(function(d) { 
					return d.getValue("Offering").getDescription();
				});
			leftText.append('div').classed("sub-text", true)
				.text(function(d) {
					return d.getDescription();
				});
			leftText.append('div').classed("sub-text", true)
				.text(function(d) {
					return d.getValue("Organization").getDescription();
				});
		}
						
		function showSessions(service, container) {
			// Remove any lingering contents from the set of full issues.
			var containerPanel = d3.select(container);
			containerPanel.selectAll("li").remove();

			var successFunction = function(sessions)
			{
				$(sessions).each(function() { this.calculateDescription(); });
				sessions.sort(compareSessions);
				
				var divs = containerPanel.selectAll("li")
					.data(sessions)
					.enter()
					.append("li").classed("consent-record cell-div", true);	// So that each button appears on its own row.
	
				var buttons = divs.append("button").classed("btn row-button", true)
					.on("click", function(session)
						{
							if (prepareClick())
							{
								showClickFeedback(this);

								var panelDiv = showSessionDetails(session, service, $(container).parents(".site-panel")[0]);
				
								showPanelLeft(panelDiv.node());
							}
						});
	
				appendRightChevrons(buttons);
				var rightText = buttons.append('span').classed("centered-right-2", true);
				
				rightText.append('div')
					.classed("sub-text", true)
					.text(getDateRange);
				rightText.append('div').classed("sub-text", true)
					.text(function(d) {
						var registrationDeadline = d.getDatum("Registration Deadline");
						if (registrationDeadline)
							return "register by " + registrationDeadline;
						else
							return "";
					});
				rightText.each(function(d) {
					var offering = d.getValue("Offering");
					showAgeRange(offering, 
						function(newText) {
							if (newText)
							{
								rightText.append('div').classed("sub-text", true)
									.text("Ages: " + newText);
							}
						});
					showGradeRange(offering, function(newText)
						{
							if (newText)
							{
								rightText.append('div').classed("sub-text", true)
									.text("Grades: " + newText);
							}
						});
				});
				
				appendSessionDescriptions(buttons);
				$($(container).parents(".site-panel")[0]).trigger("offeringsShown.cr");
			}
			
			var currentDate = new Date();
			var todayString = currentDate.toISOString().substring(0, 10);
			var path = "#" + service.value.id + '::reference(Offering)>Sessions>Session:not(["Registration Deadline"<"' + todayString + '"])';
			cr.getData({path: path, 
						fields: ["parents"], 
						done: successFunction, 
						fail: asyncFailFunction});
		}
		
		function show_plans(container) {
			var successFunction = function(sessions)
			{
				$(sessions).each(function() { this.calculateDescription(); });
				sessions.sort(compareSessions);
				
				var containerPanel = d3.select(container);
				var divs = containerPanel.selectAll("li")
					.data(sessions)
					.enter()
					.append("li").classed("consent-record cell-div", true);	// So that each button appears on its own row.
	
				var buttons = divs.append("button").classed("btn row-button", true)
					.on("click", function(session)
					{
						if (prepareClick())
						{
							showClickFeedback(this);

							var panelDiv = showSessionDetails(session, null, $(container).parents(".site-panel")[0]);
			
							showPanelLeft(panelDiv.node());
						}
					});
	
				appendRightChevrons(buttons);
				var rightText = buttons.append('span').classed("centered-right-2", true);
				
				rightText.append('div')
					.classed("sub-text", true)
					.text(getDateRange);
				
				appendSessionDescriptions(buttons);
				$($(container).parents(".site-panel")[0]).trigger("offeringsShown.cr");
			}
			
			var path = "#"+userInstance.getValueID()+"::reference(Enrollment)::reference(Enrollments)::reference(Session)";
			cr.getData({path: path, 
						fields: ["parents"], 
						done: successFunction, 
						fail: asyncFailFunction});
		}
		
		function hide_organizations()
		{
			var orgSection = d3.select(this);
			orgSection.style("display", "none");
			orgSection.selectAll("li").remove();
		}
		
		function load_organizations()
		{
			var orgSection = d3.select(this);
			var successFunction = function(newInstances)
			{
				var cell = new cr.Cell();
				cell.field = {name: "Organization",
							  dataType: "_object",
							  capacity: "_multiple values",
							  };
				cell.setup(null);
				
				orgSection.style("display", newInstances.length > 0 ? "block" : "none");
				
				var divs = orgSection.selectAll("li")
					.data(newInstances)
					.enter()
					.append("li");
				
				var buttons = divs.append("button")
					.classed("btn row-button site-active-text show-panel-button", true);
				
				buttons.append("span")
					.classed("pull-left", true)
					.text(function(d) { return d.getDescription(); });
				
				appendRightChevrons(buttons);
					
				buttons.on("click", function(d) {
					if (prepareClick())
					{
						show_organization_panel(d, cell, null, d3.select("body>panel"));
					}
				});
			}
			
			var path = '#'+userInstance.getValueID()+'::reference(_users)::reference(_group)::reference(Organization)';
			cr.selectAll({path: path, done: successFunction, fail: asyncFailFunction});
		}
		
		/* Displays a panel in which the specified object's contents appear.
		 */
		function show_organization_panel(objectData, containerCell, containerUUID, containerPanel) {
			successFunction = function ()
			{
				var b;
				
				var addButton = function(sectionObj, title, clickFunction)
				{
					var b = sectionObj.append("button")
						.classed("btn row-button site-active-text show-panel-button", true);
					b.append("span")
						.classed("pull-left", true)
						.text(title);
					appendRightChevrons(b);
					b.on("click", clickFunction);
				}
				
				var panelDiv = createPanel(containerPanel, 
											objectData, getViewPanelHeader(objectData, containerCell))
					.classed("background-gradient-panel", true);

				var navContainer = panelDiv.appendNavContainer();

				var backButton = navContainer.appendLeftButton()
					.on("click", handleCloseRightEvent);
				backButton.append("span").text("Done");
	
				var panel2Div = panelDiv.appendScrollArea();

				var headerDiv = panel2Div.appendHeader();
				objectData.addTarget("dataChanged.cr", headerDiv.node());
				$(headerDiv.node()).on("dataChanged.cr", function(e) {
						d3.select(this).text(getViewPanelHeader(objectData, containerCell));
					});

				var alertContainer = panel2Div.appendAlertContainer();
							
				showPanelLeft(panelDiv.node());

				var sectionObj = panel2Div.append("section")
					.classed("row-button-group", true);
					
				addButton(sectionObj, "Record an Inquiry",
					function(organization)
					{
						if (prepareClick())
						{
							pick_inquiry_site(organization, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Inquiries",
					function(organization)
					{
						if (prepareClick())
						{
							manage_inquiry(organization, panelDiv);
						}
					});
					
				sectionObj = panel2Div.append("section")
					.classed("row-button-group", true);
					
				addButton(sectionObj, "Enroll an Inquiry",
					function(d)
					{
						if (prepareClick())
						{
							enroll_inquiry(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Add an Enrollment",
					function(d)
					{
						if (prepareClick())
						{
							add_enrollment(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Enrollment",
					function(d)
					{
						if (prepareClick())
						{
							manage_enrollment(d, panelDiv);
						}
					});
					
				sectionObj = panel2Div.append("section")
					.classed("row-button-group", true);
					
				addButton(sectionObj, "Record Participation",
					function(d)
					{
						if (prepareClick())
						{
							record_participation(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Participation",
					function(d)
					{
						if (prepareClick())
						{
							manage_participation(d, panelDiv);
						}
					});
			}
	
			objectData.checkCells(containerCell, undefined, successFunction, asyncFailFunction)
		}
		
		function pickChild(parent, data, containerPanel, header, successFunction)
		{
			data.sort(function(a, b)
				{
					return a.getDescription().localeCompare(b.getDescription());
				});

			var panelDiv = createPanel(containerPanel, parent, header)
				.classed("list-panel", true);

			var navContainer = panelDiv.appendNavContainer();

			var backButton = navContainer.appendLeftButton()
				.on("click", handleCloseRightEvent);
			appendLeftChevrons(backButton).classed("site-active-text", true);
			backButton.append("span").text(" " + containerPanel.attr("headerText"));
	
			var centerButton = navContainer.appendTitle(header);

			var searchBar = panelDiv.appendSearchBar(show_matching_descriptions);

			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendAlertContainer();
	
			var sections = panel2Div.appendSections(data);

			var buttons = appendViewButtons(sections)
				.on("click", function(d) {
					if (prepareClick())
					{
						successFunction(d, panelDiv);
					}
					d3.event.preventDefault();
				});

			showPanelLeft(panelDiv.node());
		}
		/*
			Displays a panel from which the user can pick a session from
			the specified offering.
			
			This function should be called within a prepareClick block.
		 */
		function pick_session(offering, containerPanel, successFunction)
		{
			offering.checkCells(undefined, undefined, function()
				{
					var sessions = offering.getValue("Sessions");
					if (!sessions)
						syncFailFunction("the sessions are not set up");
					else
						sessions.checkCells(undefined, undefined, function()
							{
								var sessionCell = sessions.getCell("Session");
								pickChild(offering, sessionCell.data, containerPanel, "Pick Session", successFunction);
							},
							syncFailFunction);
				},
				syncFailFunction);
		}
		
		/*
			Displays a panel from which the user can pick an offering from
			the specified site.
			
			This function should be called within a prepareClick block.
		 */
		function pick_offering(site, containerPanel, successFunction)
		{
			site.checkCells(undefined, undefined, function()
				{
					var offerings = site.getValue("Offerings");
					if (!offerings)
						syncFailFunction("the offerings are not set up");
					else
						offerings.checkCells(undefined, undefined, function()
							{
								var offeringCell = offerings.getCell("Offering");
								pickChild(site, offeringCell.data, containerPanel, "Pick Offering", successFunction);
							},
							syncFailFunction);
				},
				syncFailFunction);
		}
		
		/*
			This function should be called within a prepareClick block.
		 */
		function pick_site(organization, containerPanel, successFunction)
		{
			organization.checkCells(undefined, undefined, function()
				{
					var sites = organization.getValue("Sites");
					if (!sites)
						syncFailFunction("the sites are not set up");
					else
						sites.checkCells(undefined, undefined, function()
							{
								var siteCell = sites.getCell("Site");
								pickChild(organization, siteCell.data, containerPanel, "Pick Site", successFunction);
							},
							syncFailFunction);
				},
				syncFailFunction);
		}
		
		function enroll_inquiry(organization, panelDiv)
		{
			pickSessionFromOrganization(organization, panelDiv,
				function(session, containerPanel)
				{
					var inquiriesCell = session.getCell("Inquiries");
					var inquiriesInstances = inquiriesCell.data;
					if (inquiriesInstances.length == 0)
						syncFailFunction("Session Inquiries are not set up");
					else
					{
						var inquiriesInstance = inquiriesInstances[0];
						inquiriesInstance.checkCells(inquiriesCell, undefined, function()
							{
								inquiryCell = inquiriesInstance.getCell("Inquiry");
						
								var panelDiv = createPanel(containerPanel, session, "Pick User")
									.classed("list-panel", true);

								var navContainer = panelDiv.appendNavContainer();

								var backButton = navContainer.appendLeftButton()
									.on("click", handleCloseRightEvent);
								backButton.append("span").text("Done");
								var centerButton = navContainer.appendTitle("Inquiries (" + inquiryCell.data.length + ")");
						
								var searchBar = panelDiv.appendSearchBar(show_matching_descriptions);

								var panel2Div = panelDiv.appendScrollArea();
								panel2Div.appendAlertContainer();

								showPanelLeft(panelDiv.node());
						
								panel2Div.selectAll("section").remove();
								var sections = panel2Div.appendSections(inquiryCell.data);
								var buttons = appendViewButtons(sections)
									.on("click", function(inquiry)
									{
										if (prepareClick())
										{
											inquiry.checkCells(inquiryCell, undefined, 
												function()
												{
													addEnrollmentByInquiry(session, inquiry);
												}, 
												syncFailFunction);
									
										}
									});
							
								var infoButtons =  buttons.insert("div", ":first-child")
									.classed("info-button right-fixed-width-div", true)
									.on("click", function(inquiry) {
										if (prepareClick())
										{
											checkUserByInquiry(inquiry,
												function(user) {
													show_user(user, panelDiv);
												},
												syncFailFunction);
										}
										d3.event.preventDefault();
									});
								drawInfoButtons(infoButtons);
							},
							syncFailFunction);
					}
				});
		}
		
		function checkUserByInquiry(inquiry, successFunction, failFunction)
		{
			var checkSuccessFunction = function() 
			{
				var email = inquiry.getDatum("_email");
				if (!email)
					failFunction("The email is not set up.");
				else
				{
					var selectAllSuccess = function(userObjects)
					{
						if (userObjects.length == 0)
							failFunction('There is no user set up with the email "' + email + '".');
						else
						{
							successFunction(userObjects[0]);
						}
					};
		
					cr.selectAll({path: "_user[_email="+email+"]", limit: 50, done: selectAllSuccess, fail: syncFailFunction});
				}
			}
			inquiry.checkCells(undefined, undefined, checkSuccessFunction, syncFailFunction);
		}
		
		function addEnrollmentByInquiry(session, inquiry)
		{
			checkUserByInquiry(inquiry,
				function(user)
				{
					getAddEnrollmentFunction(session, user, unblockClick)();
				},
				syncFailFunction);
		}
		
		function addExperienceByEnrollment(session, enrollment, containerPanel)
		{
			checkUserByEnrollment(enrollment,
				function(user)
				{
					getAddExperienceFunction(session, user, containerPanel)();
				},
				syncFailFunction);
		}
		
		function drawInfoButtons(infoButtons)
		{
			var svg = infoButtons.append("svg")
				.attr("width", "24px")
				.attr("height", "24px");
			var circles = svg.append("circle")
				.attr("cx", "12px")
				.attr("cy", "12px")
				.attr("r", "11px")
				.attr("fill", "transparent")
				.attr("stroke", activeColor)
				.attr("stroke-width", "1");
			var text = svg.append("text")
				.attr("x", "12px")
				.attr("y", "17px")
				.attr("text-anchor", "middle")
				.attr("font-family", "serif")
				.attr("font-weight", "bold")
				.attr("font-size", "16px")
				.attr("fill", activeColor)
				.text("i");
		}
		
		function show_user(user, containerPanel)
		{
			showViewOnlyObjectPanel(user, user.cell, undefined, containerPanel);
		}
		
		/*
			This function should be called within a prepareClick block. 
		 */
		function add_enrollment(organization, containerPanel)
		{
			var panelDiv = createPanel(containerPanel, organization, "Pick User")
				.classed("list-panel", true);

			var navContainer = panelDiv.appendNavContainer();

			var backButton = navContainer.appendLeftButton()
				.on("click", handleCloseRightEvent);
			backButton.append("span").text("Done");
	
			var centerButton = navContainer.appendTitle("Pick User");

			var searchBar = panelDiv.appendSearchBar(show_users);

			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendAlertContainer();
	
			showPanelLeft(panelDiv.node());
			
			var searchText = "";
			function show_users()
			{
				var val = this.value.toLocaleLowerCase();
				var inputBox = this;
				
				if (val.length == 0)
				{
					panel2Div.selectAll("section").remove();
					searchText = val;
				}
				else
				{
					var startVal = val;
					var pickedUser = null;
					
					var pickSessionSuccess = function(session, sessionPanelDiv)
					{
						var checkCellsSuccess = getAddEnrollmentFunction(session, pickedUser, unblockClick);
// 							function()
// 							{
// 								unblockClick();
// 								hidePanelRight(sessionPanelDiv.node());
// 							});
						session.checkCells(undefined, undefined, checkCellsSuccess, syncFailFunction);
					};
					
					var pickOfferingSuccess = function(offering, offeringPanelDiv)
					{
						pick_session(offering, offeringPanelDiv, pickSessionSuccess);
					}
					
					var pickSiteSuccess = function(site, sitePanelDiv)
					{
						pick_offering(site, sitePanelDiv, pickOfferingSuccess);
					}
					
					var selectAllSuccess = function(userObjects)
					{
						if (inputBox.value.toLocaleLowerCase() == startVal)
						{
							panel2Div.selectAll("section").remove();
							var sections = panel2Div.appendSections(userObjects);
							var buttons = appendViewButtons(sections)
								.on("click", function(user) {
									pickedUser = user;
									if (prepareClick())
									{
										pick_site(organization, panelDiv, pickSiteSuccess);
									}
									d3.event.preventDefault();
								});
							var infoButtons =  buttons.insert("div", ":first-child")
								.classed("info-button right-fixed-width-div", true)
								.on("click", function(user) {
									if (prepareClick())
									{
										show_user(user, panelDiv);
									}
									d3.event.preventDefault();
								});
							drawInfoButtons(infoButtons);

							searchText = startVal;
						}
					}
					
					if (val.length < 3)
						cr.selectAll({path: '_user[_email^="'+val+'"]', limit: 50, done: selectAllSuccess, fail: asyncFailFunction});
					else
						cr.selectAll({path: '_user[_email*="'+val+'"]', limit: 50, done: selectAllSuccess, fail: asyncFailFunction} );
				}
			}
		}
		
		function getAddEnrollmentFunction(session, user, successFunction)
		{
			return function()
			{
				var checkCellsSuccessFunction = function()
				{
					var offering = session.cell.parent.cell.parent;
					var enrollmentsCell = session.getCell("Enrollments");
					var enrollmentsInstances = enrollmentsCell.data;
					if (enrollmentsInstances.length == 0)
						syncFailFunction("Session enrollments are not set up");
					else
					{
						var enrollmentsInstance = enrollmentsInstances[0];
						cr.getConfiguration(null, enrollmentsCell.field.ofKindID,
							function(cells)
							{
								var enrollmentCell = cells_get_cell_by_name(cells, "Enrollment");
								cr.getConfiguration(null, enrollmentCell.field.ofKindID,
									function(cells)
									{
										var userCell = cells_get_cell_by_name(cells, "_user");
										check_single_field_instance(enrollmentsInstance, 
											["Enrollment"],
											"_user",
											user.getValueID(), 
											function(newData)
											{
												syncFailFunction(user.getDescription() + 
													  " already enrolled in " + 
													  offering.getDescription() + "/" + session.getDescription());
											},
											function()
											{
												add_single_field_instance(enrollmentsInstance, 
												   enrollmentCell, 
												   userCell, 
												   user.getValueID(), 
												   function(newData)
												   {
														bootstrap_alert.success(user.getDescription() + 
															  " enrolled in " + 
															  offering.getDescription() + "/" + session.getDescription(),
															  ".alert-container");
														successFunction();
												   },
												   syncFailFunction);
											},
											syncFailFunction);
									},
									syncFailFunction);
							},
							syncFailFunction);
					}
				}
				session.checkCells(undefined, ["parents"], checkCellsSuccessFunction, syncFailFunction);
			}
		}
		
		function getAddExperienceFunction(session, user, containerPanel)
		{
			return function()
			{
				var offering = session.cell.parent.cell.parent;
				var experiencesCell = session.getCell("Experiences");
				var experiencesInstances = experiencesCell.data;
				if (experiencesInstances.length == 0)
					syncFailFunction("Session experiences are not set up");
				else
				{
					var experiences = experiencesInstances[0];
					experiences.checkConfiguration(
						function()
						{
							var experienceCell = experiences.getCell("Experience");
							cr.getConfiguration(null, experienceCell.field.ofKindID,
								function(cells)
								{
									var userCell = cells_get_cell_by_name(cells, "_user");
									check_single_field_instance(experiences, 
										["Experience"],
										"_user",
										user.getValueID(), 
										function(data)
										{
											var experience = data[0];
											if (!experience.getValueID())
												throw "experience value ID not specified"
											experienceCell.pushValue(experience);
											showEditObjectPanel(experience, experience.cell, experiences.getValueID(), containerPanel, revealPanelUp);
										},
										function()
										{
											var experience = experienceCell.addNewValue();
											experience.checkConfiguration(
												function() {
													/* Copy the user into the data set. */
													userCell = experience.getCell("_user");
													var userValue = cr.dataTypes._object.copyValue(user);
													userCell.addValue(userValue);
													
													showEditObjectPanel(experience, experience.cell, experiences.getValueID(), containerPanel, revealPanelUp);
												},
												syncFailFunction);
										},
										syncFailFunction);
								},
								syncFailFunction);
						},
						syncFailFunction);
				}
			}
		}
		
		function check_single_field_instance(container, childFields, fieldName, dataValue, existsFunction, doesntExistFunction, failFunction)
		{
			var path = "#"+container.getValueID();
			for (i = 0; i < childFields.length; ++i)
			{
				path += ">" + childFields[i];
			}
			path += "[" + fieldName + "=" + dataValue + "]";
			
			var successFunction = function(newInstances)
			{
				if (newInstances.length > 0)
				{
					existsFunction(newInstances);
				}
				else
				{
					doesntExistFunction();
				}
			}
			cr.selectAll({path: path, done: successFunction, fail: failFunction} );
		}
		
		function add_single_field_instance(container, instanceCell, dataCell, dataValue, successFunction, failFunction)
		{
			initialData = {}
			initialData[dataCell.field.id] = dataValue;
			cr.createInstance(instanceCell.field, 
				container.value.id,
				initialData,
				successFunction,
				failFunction);
		}
		
		function show_matching_descriptions(){
			var panel2Div = d3.select($(this).parents(".site-panel").children(".panel-scrolling")[0]);
			var val = this.value.toLocaleLowerCase();
			if (val.length == 0)
			{
				/* Show all of the items. */
				panel2Div.selectAll(".row-button")
					.style("display", "block");
			}
			else
			{
				/* Show the items whose description is this.value */
				panel2Div.selectAll(".row-button")
					.style("display", function(d)
						{
							if (d.getDescription().toLocaleLowerCase().indexOf(val) >= 0)
								return "block";
							else
								return "none";
						});
			}
		}
		
		function validateEmail(email) 
		{
			var re = /\S+@\S+\.\S\S+/;
			return re.test(email);
		}
		
		function pick_inquiry_site(organization, panelDiv)
		{
			function pickSiteSuccess(site, pickSitePanel)
			{
				var pickOfferingSuccess = function(offering, pickOfferingPanel)
				{
					function pickSessionSuccess(session, containerPanel)
					{
						var addInquiryPanelDiv = createPanel(containerPanel, session, "Add Inquiry")
							.classed("list-panel", true);

						var navContainer = addInquiryPanelDiv.appendNavContainer();

						var backButton = navContainer.appendLeftButton()
							.on("click", handleCloseRightEvent);
						backButton.append("span").text("Done");
				
						var addButton = navContainer.appendRightButton()
							.classed("site-disabled-text", true);
						addButton.append("span").text("Add");
	
						var centerButton = navContainer.appendTitle("Record Inquiry");

						var panel2Div = addInquiryPanelDiv.appendScrollArea();
						panel2Div.appendAlertContainer();
				
						inquiryInput = panel2Div.append("div")
							.classed("panel-input-container", true)
							.append("input")
							.attr("type", "email")
							.classed("panel-input", true)
							.attr("placeholder", "email address");
					
				
						$(inquiryInput.node()).on("keyup input paste", function(e) {
							isValid = validateEmail(this.value);
							addButton
								.classed("site-disabled-text", !isValid)
								.classed("site-active-text", isValid)
								.style("font-weight", (isValid ? 600 : 400));
						});
	
						showPanelLeft(addInquiryPanelDiv.node());
			
						/* Since d.getValueID() is not null, containerUUID is not needed. */
						var createInquiry = function(d)
						{
							if (d3.select(this).classed("site-disabled-text"))
								return;
						
							if (prepareClick())
							{
								var checkCellsSuccess = function() 
								{
									var inquiriesCell = session.getCell("Inquiries");
									var inquiriesInstances = inquiriesCell.data;
									if (inquiriesInstances.length == 0)
										syncFailFunction("Session Inquiries are not set up");
									else
									{
										var inquiriesInstance = inquiriesInstances[0];
										cr.getConfiguration(null, inquiriesCell.field.ofKindID,
											function(cells)
											{
												var inquiryCell = cells_get_cell_by_name(cells, "Inquiry");
												cr.getConfiguration(null, inquiryCell.field.ofKindID,
													function(cells)
													{
														var emailCell = cells_get_cell_by_name(cells, "_email");
														add_single_field_instance(inquiriesInstance, 
																			   inquiryCell, 
																			   emailCell, 
																			   inquiryInput.node().value, 
																			   function(newData)
																			   {
																					bootstrap_alert.success(inquiryInput.node().value + 
																						  " inquiry added to " + 
																						  session.getDescription(),
																						  ".alert-container");
																					inquiryInput.node().value = "";
																					$(inquiryInput.node()).trigger("input");
																					unblockClick();
																			   },
																			   syncFailFunction);
													},
													syncFailFunction);
											},
											syncFailFunction);
									}
								}
								session.checkCells(undefined, undefined, checkCellsSuccess, syncFailFunction);
							};
						};
						addButton.on("click", createInquiry);
					}
					pick_session(offering, pickOfferingPanel, pickSessionSuccess);
				}
				pick_offering(site, pickSitePanel, pickOfferingSuccess);
			}
			pick_site(organization, panelDiv, pickSiteSuccess);
		}
		
		function pickSessionFromOrganization(organization, panelDiv, sessionSuccess)
		{
			function pickSiteSuccess(site, pickSitePanel)
			{
				var pickOfferingSuccess = function(offering, pickOfferingPanel)
				{
					function pickSessionSuccess(session, containerPanel)
					{
						/* Since d.getValueID() is not null, containerUUID is not needed. */
						var checkCellsSuccess = function()
						{
							sessionSuccess(session, containerPanel);
						}
						session.checkCells(undefined, undefined, checkCellsSuccess, syncFailFunction);
					}
					pick_session(offering, pickOfferingPanel, pickSessionSuccess);
				}
				pick_offering(site, pickSitePanel, pickOfferingSuccess);
			}
			pick_site(organization, panelDiv, pickSiteSuccess);
		}
		
		function manage_inquiry(organization, panelDiv)
		{
			pickSessionFromOrganization(organization, panelDiv, 
				function(session, containerPanel)
				{
					var inquiriesCell = session.getCell("Inquiries");
					var inquiriesInstances = inquiriesCell.data;
					if (inquiriesInstances.length == 0)
						syncFailFunction("Inquiries are not set up");
					else
					{
						var inquiries = inquiriesInstances[0];
						showEditObjectPanel(inquiries, inquiriesCell, undefined, containerPanel, revealPanelLeft);
					}
				});
		}
		
		function manage_enrollment(organization, panelDiv)
		{
			pickSessionFromOrganization(organization, panelDiv, 
				function(session, containerPanel)
				{
					var enrollmentsCell = session.getCell("Enrollments");
					var enrollmentsInstances = enrollmentsCell.data;
					if (enrollmentsInstances.length == 0)
						syncFailFunction("Session Enrollments are not set up");
					else
					{
						var enrollmentsInstance = enrollmentsInstances[0];
						showEditObjectPanel(enrollmentsInstance, enrollmentsCell, undefined, containerPanel, revealPanelLeft);
					}
				}
				);
		}
		
		function record_participation(organization, panelDiv)
		{
			pickSessionFromOrganization(organization, panelDiv, 
				function(session, containerPanel)
				{
					var listCell = session.getCell("Enrollments");
					var listInstances = listCell.data;
					if (listInstances.length == 0)
						syncFailFunction("Session Enrollments are not set up");
					else
					{
						var instance = listInstances[0];
						instance.checkCells(listCell, undefined, function()
							{
								enrollmentCell = instance.getCell("Enrollment");
						
								var panelDiv = createPanel(containerPanel, session, "Record Participation")
									.classed("list-panel", true);

								var navContainer = panelDiv.appendNavContainer();

								var backButton = navContainer.appendLeftButton()
									.on("click", handleCloseRightEvent);
								backButton.append("span").text("Done");
								var centerButton = navContainer.appendTitle("Record Participation");
						
								var searchBar = panelDiv.appendSearchBar(show_matching_descriptions);

								var panel2Div = panelDiv.appendScrollArea();
								panel2Div.appendAlertContainer();

								panel2Div.selectAll("section").remove();
								var sections = panel2Div.appendSections(enrollmentCell.data);
								var buttons = appendViewButtons(sections)
									.on("click", function(enrollment)
									{
										if (prepareClick())
										{
											enrollment.checkCells(enrollmentCell, undefined, 
												function()
												{
													addExperienceByEnrollment(session, enrollment, panelDiv);
												}, 
												syncFailFunction);
										}
									});
							
								var infoButtons =  buttons.insert("div", ":first-child")
									.classed("info-button right-fixed-width-div", true)
									.on("click", function(enrollment) {
										if (prepareClick())
										{
											checkUserByEnrollment(enrollment,
												function(user) {
													show_user(user, panelDiv);
												},
												syncFailFunction);
										}
										d3.event.preventDefault();
									});
								drawInfoButtons(infoButtons);
								
								showPanelLeft(panelDiv.node());
							},
							syncFailFunction);
					}
				});
		}
		
		function checkUserByEnrollment(enrollment, successFunction, failFunction)
		{
			var checkSuccessFunction = function() 
			{
				var user = enrollment.getValue("_user");
				if (!user)
					failFunction("The user is not set up.");
				else
				{
					successFunction(user);
				}
			}
			enrollment.checkCells(undefined, undefined, checkSuccessFunction, syncFailFunction);
		}
		
		function manage_participation(organization, panelDiv)
		{
			pickSessionFromOrganization(organization, panelDiv, 
				function(session, containerPanel)
				{
					var listCell = session.getCell("Experiences");
					var listInstances = listCell.data;
					if (listInstances.length == 0)
						syncFailFunction("Session Experiences are not set up");
					else
					{
						var instance = listInstances[0];
						showEditObjectPanel(instance, listCell, undefined, containerPanel, revealPanelLeft);
					}
				});
		}
		
	</script>
		
</html>

