<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap core CSS -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="{% static "custom_user/css/base.css" %}" rel="stylesheet">
    <link href="{% static "custom_user/css/bodybackground.css" %}" rel="stylesheet">
    <link href="{% static "consentrecords/css/base.css" %}" rel="stylesheet">
    
    <style>
    	.consent-record {
    		margin-top: 3px;
    	}
    	.consent-form-title {
    	}
    	.consent-record-accept-button {
    	}
    	.button-section {
    		float: bottom;
    	}
    	.button-group {
    		padding-top: 12px;
    	}
    	.organization-section {
    		padding-top: 12px;
    	}
    	.settings-section {
    		padding-top: 12px;
    	}
    	.hidden-panel {
    		top: 0;
    		z-index: 2;
    	}
    	nav {
    		opacity: 0.8;
    	}
    	.level-3-panel {
    		top: 0;
    		z-index: 3;
    	}
    	.level-4-panel {
    		top: 0;
    		z-index: 4;
    	}
    	.sub-text {
    		font-size: smaller;
    	}
    	.centered-right-glyph {
			position: absolute;
			top: 50%;
			right: 12px;
			-moz-transform: translateY(-50%);
			-webkit-transform: translateY(-50%);
			transform: translateY(-50%);
			float: right;
	   	}
	   	.centered-right-2 {	/* To the left of a centered-right-glyph */
			width: auto;
			float: right;
			margin-right: 24px;
			text-align: right;
	   	}
	   	.background-gradient-panel .row-button {
	   		position: relative;
    		background: white;
    		opacity: 0.6;
	   	}
	   	.panel-input-container {
	   		margin-top: 9px;
	   		padding-top: 3px;
	   		padding-left: 12px;
	   		padding-right: 12px;
	   		width: 100%;
	   	}
	   	.panel-input {
	   		width: 100%;
	   	}
    </style>
	</head>
	
  	<body class="site-body">
  		<panel class="background-gradient-panel" >
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<div class="pull-right">
						<div class="sign-out-button site-trio-clipped site-active-text site-navbar-link site-active-text">
							<span>Sign&nbsp;Out</span>
						</div>
					</div>
				</div>
			</nav>
			<h3> Hello, {% if user.is_authenticated %}{{ user.get_full_name }}{% else %}world{% endif %}. </h3>
			<div id="myAlert" class="alert-container"></div>
			<section class="button-section">
				<hr>
				<button id="id_find_experience_button" panelID = "id_find_experience_panel"
					class="btn row-button site-active-text show-panel-button">
					<span class="pull-left">Find a New Experience</span>
					<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
				</button>
				<hr>
				<button id="id_your_pathway_button" panelID = "id_your_pathway_panel"
					class="btn row-button site-active-text show-panel-button">
					<span class="pull-left">Your Pathway</span>
					<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
				</button>
				<hr>
				<button id="id_your_plans_button" panelID = "id_your_plans_panel"
					class="btn row-button site-active-text show-panel-button">
					<span class="pull-left">Your Plans</span>
					<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
				</button>
				<hr>
				<button id="id_consent_forms_button" panelID = "id_consent_forms_panel"
					class="btn row-button site-active-text show-panel-button">
					<span class="pull-left">Consent Forms</span>
					<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
				</button>
				<hr>
				<section class="organization-section button-group">
				</section>
				<section class="button-group">
					<hr>
					<button id="id_sharing_button" panelID = "id_sharing_panel"
						class="btn row-button site-active-text show-panel-button">
						<span class="pull-left">Sharing</span>
						<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
					</button>
					<hr>
					<button id="id_settings_button" panelID = "id_settings_panel"
						class="btn row-button site-active-text show-panel-button">
						<span class="pull-left">Settings</span>
						<span class="glyphicon glyphicon-chevron-right text-muted pull-right"></span>
					</button>
					<hr>
				</section>
			</section>
		</panel>
	    <panel id="id_find_experience_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Find a New Experience</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_services">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_find_offering_panel" class="level-3-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Find a New Experience</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div class="searchbar">
				</div>
				<div id="id_offerings">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_offering_details_panel" class="level-4-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Sign-Up</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_offering_details">
				</div>
				<div id="id_action_container">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_your_pathway_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Your Pathway</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_pathway">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_your_plans_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Your Plans</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_plans">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_consent_forms_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Consent Forms</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_openConsentForms">
				</div>
			</div> <!-- /container-fluid -->
			<div class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div class="searchbar">
				</div>
				<div id="id_openConsentForms">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_sharing_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Sharing</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_sharing">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>
	    <panel id="id_settings_panel" class="hidden-panel configuration-panel site-panel list-panel">
			<nav class="navbar navbar-default site-navbar" role="navigation">
				<div class="container-fluid">
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="pull-left">
						<div id="id_cancelButton" class="done-button cancel-button site-navbar-link site-active-text">Done</div>
					</div>
					<div class="pull-right">
						<div id="id_addUniversalObjectButton" class="site-navbar-link site-active-text add-button">
							<span>+</span>
						</div>
					</div>
					<div class="site-navbar-commands">
						<div class="site-title site-fill"><span class="site-inner-fill">Settings</span></div>
					</div>
				</div>
			</nav>
			<div id="id_scrollableArea" class="panel-scrolling">
				<div>
					<div class="alert-container"></div>
				</div>
				<div id="id_searchArea" class="searchbar">
				</div>
				<div id="id_settings">
				</div>
			</div> <!-- /container-fluid -->
	    </panel>

<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    	<script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}"></script>
  	</body>

	<script src="{% static "jquery/js/jquery.min.js" %}"></script>
	<script src="{% static "jqueryui/js/jquery-ui.min.js" %}"></script>
	<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script src="{% static "jquerycookie/jquery.cookie.js" %}"></script>
	<script src="{% static "d3/d3.v3.min.js" %}"></script>
	<script src="{% static "custom_user/js/bodybackground.js" %}"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "consentrecords/js/models.js" %}"></script>
	<script src="{% static "consentrecords/js/views.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
		var storedcsrftoken = "{{ csrf_token }}";

		var userInstance;
		
		var asyncFailFunction = function(error)
			{
				bootstrap_alert.warning(error, ".alert-container");
				/* Don't unblock here, because there was no block. */
			}
			

		$(document).ready (function(e) {
			$(".sign-out-button").click(function(e) {
				closealert();
				sign_out();
				
			   //stop form submission
			   e.preventDefault();
			});
			
			userInstance = new cr.ObjectValue()
			userInstance.value.id = "{{userID}}"
			userInstance.description = "{{ user.get_full_name }}"
			
			$(".show-panel-button").click(show_find_experience_panel);
			$(".done-button").click(hide_site_panel);
			
			$("#id_find_experience_panel").on("revealing", function(e, eventInfo)
				{
					show_services("#id_services");
				});
			setup_search_bar("#id_find_experience_panel .panel-scrolling .searchbar",
				get_filter("#id_services"));
			$("#id_find_offering_panel").on("revealing", function(e, eventInfo)
				{
					datum = d3.select(this).datum();
					show_offerings(datum, "#id_offerings");
				});
			setup_search_bar("#id_find_offering_panel .panel-scrolling .searchbar",
				get_filter("#id_offerings"));
				
			$("#id_your_pathway_panel").on("revealing", function(e, eventInfo)
			{
				show_pathway("#id_pathway");
			});
			$("#id_your_plans_panel").on("revealing", function(e, eventInfo)
			{
				show_plans("#id_plans");
			});
			$("#id_consent_forms_panel").on("revealing", function(e, eventInfo)
				{
					show_consent_records("#id_openConsentForms");
				});
				
			load_organizations();
						
		});
		
		function get_filter(node)
		{
			return function()
			{
				var val = this.value.toLocaleLowerCase();
				if (val.length == 0)
				{
					/* Show all of the items. */
					d3.select(node).selectAll("div")
						.style("display", "block");
				}
				else
				{
					/* Show the items whose description is this.value */
					d3.select(node).selectAll("div")
						.style("display", function(d)
							{
								if (d.getDescription().toLocaleLowerCase().indexOf(val) >= 0)
									return "block";
								else
									return "none";
							});
				}
			}
		}
			
		function sign_out() {
			bootstrap_alert.show($('#myAlert'), "Signing Out...", "alert-info");
		    $.post("{% url 'submitSignout' %}", { csrfmiddlewaretoken: storedcsrftoken }, 
		  								function(json){
		  	if (json['success']) {
		  		window.location = "{{backURL}}"
		  	}
		  	else
				bootstrap_alert.warning(json['error']);
		  })
		  	.fail(function(jqXHR, textStatus, errorThrown)
			{
				bootstrap_alert.warning(jqXHR.status + "; " + jqXHR.statusText);
				console.log( "error: " + textStatus + "; " + errorThrown + ";");
				console.log( jqXHR.status + "; " + jqXHR.statusText);
			});
		}
		
		function show_find_experience_panel(e)
		{
			var panelDiv = d3.select("#" + d3.select(this).attr("panelID"));
			if (prepare_click())
			{
				show_click_feedback(this);
				
				window.scrollTo(0, 0);
				show_panel_left(panelDiv.node());
			}
		}
				
		function hide_site_panel(e)
		{
			if (prepare_click())
			{
				show_click_feedback(this);
				hide_panel_right($(this).parents(".site-panel")[0], false);
			}
		}
		
		function show_consent_records(containerDiv) {
			var successFunction = function(newInstances)
			{
				var divs = d3.select(containerDiv).selectAll('div')
					.data(newInstances)
					.enter()
					.append('div').classed("consent-record cell-div", true);
				
				divs.append('div').classed("consent-record-accept-button right-label-div right-fixed-width-div right-label-div site-active-text", true)
					.text("I Accept");
				divs.append('div').classed("consent-form-title left-label-div string-label-div expanding-div", true)
					.text(function(d) { 
						return d.value.cells[0].data[0].value.description;
					});
			}
			
			var path = "#" + "{{userID}}" + '>"Consent Record"';
			cr.getData(path, ["parents"], successFunction, asyncFailFunction);
		}
		
		function show_services(containerDiv) {
			var successFunction = function(newInstances)
			{
				var cell = new cr.Cell();
				cell.field = {
							  dataType: "_object",
							  name: "Service",
							  capacity: "_multiple values",
							  };
				cell.setup(null);
				newInstances.sort(function(a, b)
					{
						return a.getDescription().localeCompare(b.getDescription());
					});
				
				layout_objects(cell, d3.select("#id_services"), newInstances,
					function(d) {
						if (prepare_click())
						{
							var panelDiv = d3.select("#id_find_offering_panel");
							panelDiv.datum([d]);
							show_click_feedback(this);
				
							window.scrollTo(0, 0);
							show_panel_left(panelDiv.node());
						}
					});
			}
			
			var path = "Service";
			cr.getValues(path, successFunction, asyncFailFunction);
		}
		
		function cells_get_cell_by_name(cells, name)
		{
			for (var i = 0; i < cells.length; ++i)
			{
				var cell = cells[i];
				if (cell.field.name == name)
					return cell;
			}
			return undefined;
		}
		
		function get_cell_by_name(d, name)
		{
			return cells_get_cell_by_name(d.value.cells, name);
		}
		
		/* Gets the first value of the cell within the specified instance 
			whose name equals the specified name. */
		function get_datum_by_name(d, name)
		{
			var cell = get_cell_by_name(d, name);
			if (cell)
				return cell.data[0].value;
			else
				return undefined;
		}
		
		function show_pathway(containerDiv) {
			var successFunction = function(newInstances)
			{
				d3.select(containerDiv).selectAll('div').remove();
				
				var divs = d3.select(containerDiv).selectAll('div')
					.data(newInstances)
					.enter()
					.append('div');
				divs.classed("consent-record cell-div", true);
				
				divs.append('div').classed("right-label-div right-fixed-width-div right-label-div", true)
					.text(function(d) {
						startDate = get_datum_by_name(d, "Start Date");
						if (startDate === undefined || startDate === null)
							startDate = "";
						endDate = get_datum_by_name(d, "End Date");
						if (endDate === undefined || endDate === null)
							endDate = "";
						if (startDate || endDate)
							connector = " - ";
						else
							connector = "";
						return startDate + connector + endDate;
					});
				var titleDivs = divs.append('div').classed("consent-form-title left-label-div string-label-div expanding-div", true);
				titleDivs.append("div")
					.text(function(d) { 
						return get_datum_by_name(d, "Offering").description;
					});
				titleDivs.append("div")
					.text(function(d) {
						var datum = get_datum_by_name(d, "Organization");
						if (datum)
							return datum.description;
						else
							return "None";
					});
			}
			
			var path = "#" + "{{userID}}" + '::reference(Experience)';
			cr.getData(path, ["parents"], successFunction, asyncFailFunction);
		}
		
		function show_offerings(datum, container) {
			var successFunction = function(newInstances)
			{
				// Remove any lingering contents from the set of full issues.
				var containerDiv = d3.select(container);
				containerDiv.selectAll("div").remove();

				var divs = d3.select(container).selectAll("div")
					.data(newInstances)
					.enter()
					.append("div").classed("consent-record cell-div", true);	// So that each button appears on its own row.
	
				var buttons = divs.append("button").classed("btn row-button", true)
					.on("click", show_offering_details);
				divs.append("hr");
	
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted centered-right-glyph", true);
				var rightText = buttons.append('span').classed("centered-right-2", true);
				
				rightText.append('div')
					.text(function(d) {
						var startDate = get_datum_by_name(d, "Start Date");
						if (startDate === undefined)
							startDate = "";
						var endDate = get_datum_by_name(d, "End Date");
						if (endDate === undefined)
							endDate = "";
						var connector;
						if (startDate || endDate)
							connector = " - ";
						else
							connector = "";
						return startDate + connector + endDate;
					});
				rightText.append('div').classed("sub-text", true)
					.text(function(d) {
						var registrationDeadline = get_datum_by_name(d, "Registration Deadline");
						if (registrationDeadline)
							return "register by " + registrationDeadline;
						else
							return "";
					});
				var leftText = buttons.append('div').classed("consent-form-title left-expanding-div", true);
				
				leftText.append('div')
					.text(function(d) { 
						return get_datum_by_name(d, "_name").description;
					});
				leftText.append('div').classed("sub-text", true)
					.text(function(d) {
						return get_datum_by_name(d, "Organization").description;
					});
			}
			
			function show_offering_details(d)
			{
				if (prepare_click())
				{
					show_click_feedback(this);

					var panelDiv = d3.select("#id_offering_details_panel");
					panelDiv.datum(d);
					
					var div = panelDiv.selectAll("#id_offering_details");
					div.selectAll("div").remove();
					div.append("div")
						.text(get_datum_by_name(d, "_name").description);
					div.append("div")
						.text("Minimum Age: " + get_datum_by_name(d, "Minimum Age"));
					div.append("div")
						.text("Maximum Age: " + get_datum_by_name(d, "Maximum Age"));
					div.append("div")
						.text("Registration Deadline: " + get_datum_by_name(d, "Registration Deadline"));
					cr.getValues("#"+d.value.id+">Service", function(newInstances)
						{
							newInstances.sort(function(a, b)
								{
									return a.getDescription().localeCompare(b.getDescription());
								});
				
							div.append("div").text("Services");
							div.append("div").selectAll("div")
								.data(newInstances)
								.enter()
								.append("div")
								.text(function(d) {
									return d.getDescription();
								});
						},
						asyncFailFunction);
					var inquiriesCell = get_cell_by_name(d, "Inquiries")
					var newInstances = inquiriesCell.data;
					if (newInstances.length == 0)
						asyncFailFunction("Access Failure for Inquiries");
					else
					{
						var inquiriesInstance = newInstances[0];
						var inquiryInstance = null;
						var inquiryCell = null;
						var emailCell = null;
						var addInquiryFunction = function()
						{
							add_single_field_instance(inquiriesInstance, 
											   inquiryCell, 
											   emailCell, 
											   "{{ user.email }}", 
											   function(newData) { checkInquiryFunction([newData]); },
											   asyncFailFunction);
						}

						var checkInquiryFunction = function(newInstances)
						{
							var actionDiv = panelDiv.selectAll("#id_action_container");
							actionDiv.selectAll("div").remove();
							buttonDiv = actionDiv.append("div")
								.classed("sign-up-button site-active-text", true);
				
							if (newInstances.length > 0)
							{
								inquiryInstance = newInstances[0];
								buttonDiv.text("Delete Inquiry");
							}
							else
							{
								inquiryInstance = null;
								buttonDiv.text("Add My Name");
								buttonDiv.on("click", function(e)
									{
										if (prepare_click())
										{
											show_click_feedback(this);
											
											if (inquiryCell && emailCell)
											{
												addInquiryFunction();
											}
											else
											{
												cr.getConfiguration(null, inquiriesCell.field.ofKindID, 
													function(cells)
													{
														inquiryCell = cells_get_cell_by_name(cells, "Inquiry");
														cr.getConfiguration(null, inquiryCell.field.ofKindID,
															function(cells)
															{
																emailCell = cells_get_cell_by_name(cells, "_email");
																addInquiryFunction();
															},
															standard_json_fail_function);
													}, 
													standard_json_fail_function);
											}
											unblock_click();
										}
										d3.event.preventDefault();
									});
							}
						};
							
						cr.getValues("#" + inquiriesInstance.value.id + ">Inquiry[_email={{ user.email }}]",
							checkInquiryFunction,
							asyncFailFunction);
					}
		
					window.scrollTo(0, 0);
					show_panel_left(panelDiv.node());
				}
			}
						
			var currentDate = new Date();
			var todayString = currentDate.toISOString().substring(0, 10);
			var path = "#" + datum[0].value.id + '::reference(Offering):not(["Registration Deadline"<"' + todayString + '"])';
			cr.getData(path, ["parents"], successFunction, asyncFailFunction);
		}
		
		function show_plans(containerDiv) {
			var successFunction = function(newInstances)
			{
				var divs = d3.select(containerDiv).selectAll('div')
					.data(newInstances)
					.enter()
					.append('div').classed("consent-record cell-div", true);
				
				divs.append('div').classed("consent-record-accept-button right-label-div right-fixed-width-div right-label-div", true)
					.text(function(d) {
						startDate = get_datum_by_name(d, "Start Date");
						if (startDate === undefined)
							startDate = "";
						endDate = get_datum_by_name(d, "End Date");
						if (endDate === undefined)
							endDate = "";
						if (startDate || endDate)
							connector = " - ";
						else
							connector = "";
						return startDate + connector + endDate;
					});
				divs.append('div').classed("consent-form-title left-label-div string-label-div expanding-div", true)
					.text(function(d) { 
						return get_datum_by_name(d, "_name").description;
					});
			}
			
			var path = "#{{userID}}::reference(Enrollment)::reference(Offering)";
			cr.getData(path, ["parents"], successFunction, asyncFailFunction);
		}
		
		function load_organizations()
		{
			var successFunction = function(newInstances)
			{
				var cell = new cr.Cell();
				cell.field = {name: "Organization",
							  dataType: "_object",
							  capacity: "_multiple values",
							  };
				cell.setup(null);
				
				if (newInstances.length > 0)
					d3.select(".organization-section").append("hr");
				
				var divs = d3.select(".organization-section").selectAll("div")
					.data(newInstances)
					.enter()
					.append("div");
				
				var buttons = divs.append("button")
					.classed("btn row-button site-active-text show-panel-button", true);
				
				buttons.append("span")
					.classed("pull-left", true)
					.text(function(d) { return d.getDescription(); });
				
				buttons.append("span")
					.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
					
				buttons.on("click", function(d) {
					if (prepare_click())
					{
						show_organization_panel(d, cell, null, d3.select("body>panel"));
					}
				});
					
				divs.append("hr");
			}
			
			var path = '#{{userID}}::reference("Employee")::reference("Employees")::reference("Organization")';
			cr.getValues(path, successFunction, asyncFailFunction);
		}
		
		/* Displays a panel in which the specified object's contents appear.
		 */
		function show_organization_panel(objectData, containerCell, containerUUID, containerPanel) {
			successFunction = function ()
			{
				var b;
				
				var addButton = function(sectionObj, title, clickFunction)
				{
					var b = sectionObj.append("button")
						.classed("btn row-button site-active-text show-panel-button", true);
					b.append("span")
						.classed("pull-left", true)
						.text(title);
					b.append("span")
						.classed("glyphicon glyphicon-chevron-right text-muted pull-right", true);
					b.on("click", clickFunction);
					
					sectionObj.append("hr");
				}
				
				var panelDiv = create_panel(containerPanel, 
											objectData, get_view_panel_header(objectData, containerCell))
					.classed("background-gradient-panel", true);

				var navContainer = panelDiv.appendNavContainer();

				var backButton = navContainer.appendLeftButton()
					.on("click", handle_close_right_event);
				backButton.append("span").text("Done");
	
				var panel2Div = panelDiv.appendScrollArea();

				var headerDiv = panel2Div.appendHeader();
				objectData.add_target("dataChanged", headerDiv.node());
				$(headerDiv.node()).on("dataChanged", function(e) {
						d3.select(this).text(get_view_panel_header(objectData, containerCell));
					});

				var alertContainer = panel2Div.append("div").classed("alert-container", true);
							
				window.scrollTo(0, 0);
				show_panel_left(panelDiv.node());

				var sectionObj = panel2Div.append("section")
					.classed("button-group", true);
					
				sectionObj.append("hr");
				
				addButton(sectionObj, "Record an Inquiry",
					function(d)
					{
						if (prepare_click())
						{
							add_inquiry(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Inquiries",
					function(d)
					{
						if (prepare_click())
						{
							manage_inquiry(d, panelDiv);
						}
					});
					
				sectionObj = panel2Div.append("section")
					.classed("button-group", true);
					
				sectionObj.append("hr");
				
				addButton(sectionObj, "Enroll an Inquiry",
					function(d)
					{
						if (prepare_click())
						{
							enroll_inquiry(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Add an Enrollment",
					function(d)
					{
						if (prepare_click())
						{
							add_enrollment(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Enrollment",
					function(d)
					{
						if (prepare_click())
						{
							manage_enrollment(d, panelDiv);
						}
					});
					
				sectionObj = panel2Div.append("section")
					.classed("button-group", true);
					
				sectionObj.append("hr");
				
				addButton(sectionObj, "Record Participation",
					function(d)
					{
						if (prepare_click())
						{
							record_participation(d, panelDiv);
						}
					});
					
				addButton(sectionObj, "Manage Participation",
					function(d)
					{
						if (prepare_click())
						{
							manage_participation(d, panelDiv);
						}
					});
					
					
				sectionObj.append("hr");
			}
	
			objectData.checkCells(containerCell, successFunction, asyncFailFunction)
		}
		
		/*
			This function should be called within a prepare_click block.
		 */
		function pick_offering(d, containerPanel, successFunction)
		{
			function selectAllSuccessFunction(rootObjects) {
				rootObjects.sort(function(a, b)
					{
						return a.getDescription().localeCompare(b.getDescription());
					});
	
				var panelDiv = create_panel(containerPanel, d, "Pick Offering")
					.classed("list-panel", true);

				var navContainer = panelDiv.appendNavContainer();

				var backButton = navContainer.appendLeftButton()
					.on("click", handle_close_right_event);
				backButton.append("span").text("Cancel");
		
				var centerButton = navContainer.appendTitle("Pick Offering");

				var searchBar = panelDiv.appendSearchBar(show_matching_descriptions);

				var panel2Div = panelDiv.appendScrollArea();
				panel2Div.appendAlertContainer();
		
				var sections = panel2Div.appendSections(rootObjects);
	
				var buttons = appendButtons(sections)
					.on("click", function(d) {
						if (prepare_click())
						{
							successFunction(d, panelDiv);
						}
						d3.event.preventDefault();
					});
				sections.append("hr");
	
				window.scrollTo(0, 0);
				show_panel_left(panelDiv.node());
			}
	
			cr.getValues("#"+d.value.id+'>Offerings>Offering', 
						 selectAllSuccessFunction, 
						 standard_json_fail_function);
		}
		
		function enroll_inquiry(organization, containerPanel)
		{
			/* Pick an offering. */
			var successFunction = function(offering, offeringPanelDiv)
			{
				var checkCellsSuccess = function()
				{
					var inquiriesCell = get_cell_by_name(offering, "Inquiries");
					var inquiriesInstances = inquiriesCell.data;
					if (inquiriesInstances.length == 0)
						standard_json_fail_function("Offering Inquiries are not set up");
					else
					{
						var inquiriesInstance = inquiriesInstances[0];
						inquiriesInstance.checkCells(inquiriesCell, function()
							{
								inquiryCell = get_cell_by_name(inquiriesInstance, "Inquiry");
								
								var panelDiv = create_panel(containerPanel, organization, "Pick User")
									.classed("list-panel", true);

								var navContainer = panelDiv.appendNavContainer();

								var backButton = navContainer.appendLeftButton()
									.on("click", handle_close_right_event);
								backButton.append("span").text("Cancel");
								var centerButton = navContainer.appendTitle("Inquiries (" + inquiryCell.data.length + ")");
								
								var searchBar = panelDiv.appendSearchBar(show_matching_descriptions);

								var panel2Div = panelDiv.appendScrollArea();
								panel2Div.appendAlertContainer();
	
								window.scrollTo(0, 0);
								show_panel_left(panelDiv.node());
								
								panel2Div.selectAll("section").remove();
								var sections = panel2Div.appendSections(inquiryCell.data);
								var buttons = appendButtons(sections)
									.on("click", function(inquiry)
									{
										if (prepare_click())
										{
											inquiry.checkCells(inquiryCell, 
												function()
												{
													add_enrollment_by_inquiry(offering, inquiry);
												}, 
												standard_json_fail_function);
											
										}
									});
							},
							standard_json_fail_function);
					}
				}
				offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
			}
			
			pick_offering(organization, containerPanel, successFunction);
		}
		
		function add_enrollment_by_inquiry(offering, inquiry)
		{
			var emailCell = get_cell_by_name(inquiry, "_email");
			if (emailCell.data.length == 0)
				standard_json_fail_function("The email is not set up.");
			else
			{
				var email = emailCell.data[0].value;
				var getValuesSuccess = function(userObjects)
				{
					if (userObjects.length == 0)
						standard_json_fail_function('There is no user set up with the email "' + email + '".');
					else
					{
						add_enrollment_function(offering, userObjects[0], 
							function()
							{
								unblock_click();
							})();
					}
				};
			
				cr.getValues("_user[_email="+email+"]", getValuesSuccess, standard_json_fail_function);
			}
		}
		
		/*
			This function should be called within a prepare_click block. 
		 */
		function add_enrollment(organization, containerPanel)
		{
			var panelDiv = create_panel(containerPanel, organization, "Pick User")
				.classed("list-panel", true);

			var navContainer = panelDiv.appendNavContainer();

			var backButton = navContainer.appendLeftButton()
				.on("click", handle_close_right_event);
			backButton.append("span").text("Cancel");
	
			var centerButton = navContainer.appendTitle("Pick User");

			var searchBar = panelDiv.appendSearchBar(show_users);

			var panel2Div = panelDiv.appendScrollArea();
			panel2Div.appendAlertContainer();
	
			window.scrollTo(0, 0);
			show_panel_left(panelDiv.node());
			
			var searchText = "";
			function show_users()
			{
				var val = this.value.toLocaleLowerCase();
				var inputBox = this;
				
				if (val.length == 0)
				{
					panel2Div.selectAll("section").remove();
					searchText = val;
				}
				else
				{
					var startVal = val;
					var pickedUser = null;
					
					var pickOfferingSuccess = function(offering, offeringPanelDiv)
					{
						var checkCellsSuccess = add_enrollment_function(offering, pickedUser, 
							function()
							{
								hide_panel_right(offeringPanelDiv.node());
							});
						offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
					};
					
					var getValuesSuccess = function(userObjects)
					{
						if (inputBox.value.toLocaleLowerCase() == startVal)
						{
							panel2Div.selectAll("section").remove();
							var sections = panel2Div.appendSections(userObjects);
							var buttons = appendButtons(sections)
								.on("click", function(user) {
									pickedUser = user;
									if (prepare_click())
									{
										pick_offering(organization, panelDiv, pickOfferingSuccess);
									}
									d3.event.preventDefault();
								});
							searchText = startVal;
						}
					}
					
					cr.getValues("_user[_email^="+val+"]", getValuesSuccess, asyncFailFunction);
				}
			}
		}
		
		function add_enrollment_function(offering, user, successFunction)
		{
			return function()
			{
				var enrollmentsCell = get_cell_by_name(offering, "Enrollments");
				var enrollmentsInstances = enrollmentsCell.data;
				if (enrollmentsInstances.length == 0)
					standard_json_fail_function("Offering Enrollments are not set up");
				else
				{
					var enrollmentsInstance = enrollmentsInstances[0];
					cr.getConfiguration(null, enrollmentsCell.field.ofKindID,
						function(cells)
						{
							var enrollmentCell = cells_get_cell_by_name(cells, "Enrollment");
							cr.getConfiguration(null, enrollmentCell.field.ofKindID,
								function(cells)
								{
									var userCell = cells_get_cell_by_name(cells, "_user");
									check_single_field_instance(enrollmentsInstance, 
										[enrollmentCell],
										userCell.field.nameID,
										user.getValueID(), 
										function(newData)
										{
											standard_json_fail_function(user.getDescription() + 
												  " already enrolled in " + 
												  offering.getDescription());
										},
										function()
										{
											add_single_field_instance(enrollmentsInstance, 
											   enrollmentCell, 
											   userCell, 
											   {id: user.getValueID()}, 
											   function(newData)
											   {
													bootstrap_alert.success(user.getDescription() + 
														  " enrolled in " + 
														  offering.getDescription(),
														  ".alert-container");
													successFunction();
											   },
											   standard_json_fail_function);
										},
										standard_json_fail_function);
								},
								standard_json_fail_function);
						},
						standard_json_fail_function);
				}
			}
		}
		
		function check_single_field_instance(container, childCells, fieldName, dataValue, existsFunction, doesntExistFunction, failFunction)
		{
			var path = "#"+container.value.id;
			for (i = 0; i < childCells.length; ++i)
			{
				path += ">" + childCells[i].field.nameID;
			}
			path += "[" + fieldName + "=" + dataValue + "]";
			
			var successFunction = function(newInstances)
			{
				if (newInstances.length > 0)
				{
					existsFunction(newInstances);
				}
				else
				{
					doesntExistFunction();
				}
			}
			cr.getValues(path, successFunction, failFunction);
		}
		
		function add_single_field_instance(container, instanceCell, dataCell, dataValue, successFunction, failFunction)
		{
			initialData = [{field: dataCell.field, data: [{ value: dataValue}]}];
			cr.createInstance(storedcsrftoken, 
				instanceCell.field, 
				container.value.id,
				initialData,
				successFunction,
				failFunction);
		}
		
		function show_matching_descriptions(){
			var panel2Div = d3.select($(this).parents(".site-panel").children(".panel-scrolling")[0]);
			var val = this.value.toLocaleLowerCase();
			if (val.length == 0)
			{
				/* Show all of the items. */
				panel2Div.selectAll(".row-button")
					.style("display", "block");
			}
			else
			{
				/* Show the items whose description is this.value */
				panel2Div.selectAll(".row-button")
					.style("display", function(d)
						{
							if (d.getDescription().toLocaleLowerCase().indexOf(val) >= 0)
								return "block";
							else
								return "none";
						});
			}
		}
		
		function validateEmail(email) 
		{
			var re = /\S+@\S+\.\S\S+/;
			return re.test(email);
		}
		
		function add_inquiry(organization, containerPanel)
		{
			var pickOfferingSuccess = function(offering, pickOfferingDiv)
			{
				var addInquiryPanelDiv = create_panel(containerPanel, organization, "Add Inquiry")
					.classed("list-panel", true);

				var navContainer = addInquiryPanelDiv.appendNavContainer();

				var backButton = navContainer.appendLeftButton()
					.on("click", function(d)
					{
						closealert();
						handle_close_right_event.call(this);
					});
				backButton.append("span").text("Done");
				
				var addButton = navContainer.appendRightButton()
					.classed("site-disabled-text", true);
				addButton.append("span").text("Add");
	
				var centerButton = navContainer.appendTitle("Record Inquiry");

				var panel2Div = addInquiryPanelDiv.appendScrollArea();
				panel2Div.appendAlertContainer();
				
				inquiryInput = panel2Div.append("div")
					.classed("panel-input-container", true)
					.append("input")
					.attr("type", "email")
					.classed("panel-input", true)
					.attr("placeholder", "email address");
					
				
				$(inquiryInput.node()).on("keyup input paste", function(e) {
					isValid = validateEmail(this.value);
					addButton
						.classed("site-disabled-text", !isValid)
						.classed("site-active-text", isValid)
						.style("font-weight", (isValid ? 600 : 400));
				});
	
				window.scrollTo(0, 0);
				show_panel_left(addInquiryPanelDiv.node());
			
				/* Since d.getValueID() is not null, containerUUID is not needed. */
				var createInquiry = function(d)
				{
					if (d3.select(this).classed("site-disabled-text"))
						return;
						
					if (prepare_click())
					{
						var checkCellsSuccess = function() 
						{
							var inquiriesCell = get_cell_by_name(offering, "Inquiries");
							var inquiriesInstances = inquiriesCell.data;
							if (inquiriesInstances.length == 0)
								standard_json_fail_function("Offering Inquiries are not set up");
							else
							{
								var inquiriesInstance = inquiriesInstances[0];
								cr.getConfiguration(null, inquiriesCell.field.ofKindID,
									function(cells)
									{
										var inquiryCell = cells_get_cell_by_name(cells, "Inquiry");
										cr.getConfiguration(null, inquiryCell.field.ofKindID,
											function(cells)
											{
												var emailCell = cells_get_cell_by_name(cells, "_email");
												add_single_field_instance(inquiriesInstance, 
																	   inquiryCell, 
																	   emailCell, 
																	   inquiryInput.node().value, 
																	   function(newData)
																	   {
																			bootstrap_alert.success(inquiryInput.node().value + 
																				  " inquiry added to " + 
																				  offering.getDescription(),
																				  ".alert-container");
																			inquiryInput.node().value = "";
																			$(inquiryInput.node()).trigger("input");
																			unblock_click();
																	   },
																	   standard_json_fail_function);
											},
											standard_json_fail_function);
									},
									standard_json_fail_function);
							}
						}
						offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
					};
				};
				
				addButton.on("click", createInquiry);
			}
			pick_offering(organization, containerPanel, pickOfferingSuccess);
		}
		
		function manage_inquiry(organization, panelDiv)
		{
			var pickOfferingSuccess = function(offering, pickOfferingDiv)
			{
				/* Since d.getValueID() is not null, containerUUID is not needed. */
				var checkCellsSuccess = function()
				{
					var inquiriesCell = get_cell_by_name(offering, "Inquiries");
					var inquiriesInstances = inquiriesCell.data;
					if (inquiriesInstances.length == 0)
						standard_json_fail_function("Offering Inquiries are not set up");
					else
					{
						var inquiriesInstance = inquiriesInstances[0];
						show_edit_object_panel(inquiriesInstance, inquiriesCell, undefined, pickOfferingDiv);
					}
				}
				offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
			}
			pick_offering(organization, panelDiv, pickOfferingSuccess);
		}
		
		function manage_enrollment(organization, panelDiv)
		{
			var pickOfferingSuccess = function(offering, pickOfferingDiv)
			{
				/* Since d.getValueID() is not null, containerUUID is not needed. */
				var checkCellsSuccess = function()
				{
					var enrollmentsCell = get_cell_by_name(offering, "Enrollments");
					var enrollmentsInstances = enrollmentsCell.data;
					if (enrollmentsInstances.length == 0)
						standard_json_fail_function("Offering Enrollments are not set up");
					else
					{
						var enrollmentsInstance = enrollmentsInstances[0];
						show_edit_object_panel(enrollmentsInstance, enrollmentsCell, undefined, pickOfferingDiv);
					}
				}
				offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
			}
			pick_offering(organization, panelDiv, pickOfferingSuccess);
		}
		
		function record_participation(organization, panelDiv)
		{
			var pickOfferingSuccess = function(offering, pickOfferingDiv)
			{
				/* Since d.getValueID() is not null, containerUUID is not needed. */
				var checkCellsSuccess = function()
				{
					var listCell = get_cell_by_name(offering, "Experiences");
					var listInstances = listCell.data;
					if (listInstances.length == 0)
						standard_json_fail_function("Offering Experiences are not set up");
					else
					{
						var instance = listInstances[0];
						show_edit_object_panel(listInstances, listCell, undefined, pickOfferingDiv);
					}
				}
				offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
			}
			pick_offering(organization, panelDiv, pickOfferingSuccess);
		}
		
		function manage_participation(organization, panelDiv)
		{
			var pickOfferingSuccess = function(offering, pickOfferingDiv)
			{
				/* Since d.getValueID() is not null, containerUUID is not needed. */
				var checkCellsSuccess = function()
				{
					var listCell = get_cell_by_name(offering, "Experiences");
					var listInstances = listCell.data;
					if (listInstances.length == 0)
						standard_json_fail_function("Offering Experiences are not set up");
					else
					{
						var instance = listInstances[0];
						show_edit_object_panel(instance, listCell, undefined, pickOfferingDiv);
					}
				}
				offering.checkCells(undefined, checkCellsSuccess, standard_json_fail_function);
			}
			pick_offering(organization, panelDiv, pickOfferingSuccess);
		}
		
	</script>
		
</html>

